{
  "hash": "44fe7c4a84f4eb77c7531680df12174d",
  "result": {
    "markdown": "---\ntitle: \"Rstudio环境配置\"\nexecute: \n  eval: false\neditor_options: \n  chunk_output_type: console\n---\n\n\n## 更新R\n\n在R原软件中逐个运行下面的代码（仅适用Windows系统）。macOS直接打开[CRAN官网](https://cran.r-project.org/bin/macosx/)下载最新版本的R覆盖安装，重启RStudio即可完成R的更新，原R包都在。\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-1_6c5f225d3c4c058fec4dc9853f98a129'}\n\n```{.r .cell-code}\ninstall.packages(\"installr\")\nlibrary(installr)\nupdateR()\n```\n:::\n\n\n## 更新R包\n\n运行下面的代码或通过右下角的Packages选项卡进行R包的更新\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-2_ef54e80e16de5538abe4be00f5a6ac4a'}\n\n```{.r .cell-code}\nold.packages() # 检查是否有需要更新的R包\nupdate.packages(ask = F) # 更新所有R包\nnews(package = \"limma\") # 参看R包的更新内容\nBiocManager::valid() # 查看是否有需要更新的bioconductor包。根据提示安装更新\n```\n:::\n\n\n## 从bioconductor安装R包\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-3_9e54af248d09d8c40e1cce6f025788fa'}\n\n```{.r .cell-code}\nBiocManager::install(\"biomaRt\",update = TRUE,ask = FALSE)\n```\n:::\n\n\n## 清除当前加载的程序包\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-4_c52bb7b9c24b70aa1218b08477c10083'}\n\n```{.r .cell-code}\ndetach(\"package:dplyr\", unload=TRUE)\n# 或用pacman包内的p_unload函数\npacman::p_unload(\"dplyr\")\n```\n:::\n\n\n如果要从环境中移除所有用户包，则可通过`pacman`包的`p_loaded()`+`p_unload()`函数实现：\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-5_2bad12f82807f7f76a51cda6eb73fb4f'}\n\n```{.r .cell-code}\npacman::p_unload(pacman::p_loaded(), character.only = TRUE)\n```\n:::\n\n\n## 更改当前R脚本运行目录\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-6_1196c7aa82452b8acc16e7fe1e58d28b'}\n\n```{.r .cell-code}\nsetwd(\"/Users/totoshihiro/Library/Mobile Documents/com~apple~CloudDocs/Documents/科研/医学统计学/数据基本处理与标准化\")\ngetwd()#查看当前R脚本运行目录\n```\n:::\n\n\n## 环境查看和清理\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-7_12038be18436e1333a3aa77c0bb2f425'}\n\n```{.r .cell-code}\nrm(mydata)\nrm(list = ls())#移除当前环境中的所有对象\ncat(\"\\014\")#清空所有输出结果\nsessionInfo()#收集有关当前R项目的信息\n```\n:::\n\n\n## 自动安装所需的R包\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-8_6a3c5557689db635312bf5ad07b79fb9'}\n\n```{.r .cell-code}\npackages <-c(\"GEOquery\", \"limma\",\"ggplot2\", \"pheatmap\")#列出所需的R包\n\n#检查所需的R包是否已安装，若未安装则从CRAN或Bioconductor安装包\npackagecheck <- function(x) {\n  if (!require(\"BiocManager\")) {\n    install.packages(\"BiocManager\")\n  } else if (!require(x, character.only = T)) {\n    CRANpackages <- available.packages()\n    if (x %in% rownames(CRANpackages)) {\n      install.packages(x)\n    } else {\n      BiocManager::install(x, update = TRUE, ask = FALSE)\n    }\n  }\n}\nlapply(packages, packagecheck)\n```\n:::\n\n\n## 调整矢量/内存分配上限\n\n### 提高矢量大小上限\n\n在R语言中如果我们要处理的数据集较大，如在[处理单细胞数据时](/single_cell/scRNA-seq_online/06_SC_SCT_normalization.qmd#re_sctransform)，可能会出现如下报错：\n\n``` md\nError: cannot allocate vector of size *** Mb\n```\n\n这是因为 R 中有对象大小的限制（默认值为 500 1024 \\^ 2 = 500 Mb）。可以通过如下代码进行调整：\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-9_06b7e01798adfbeec37a6fe992109fdf'}\n\n```{.r .cell-code}\n# 调整允许对象大小限制为6GB\noptions(future.globals.maxSize = 6 * 1024 * 1024^2)\n```\n:::\n\n\n### 提高R内存分配上限（macOS） {#sec-Raising_memory_limit}\n\n如果在运行大量的数据处理时，出现如下报错：\n\n``` md\nError: vector memory exhausted (limit reached?)\n```\n\n那么说明脚本的运行超出了R语言内存分配的上限，这一般就是Mac的物理内存大小。但是，我们可以通过如下的方式来通过分配SWAP虚拟内存的方式，使得代码能够继续运行（来自stackoverflow上的[这篇](https://stackoverflow.com/questions/51295402/r-on-macos-error-vector-memory-exhausted-limit-reached)帖子）。\n\n【方法一：通过[usethis](https://usethis.r-lib.org/)包配置】\n\n在R中运行：\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-10_6985f08ffebbd93e3def024ed2700a7a'}\n\n```{.r .cell-code}\nusethis::edit_r_environ()\n```\n:::\n\n\n::: callout-tip\n`usethis` is a package that facilitates interactive workflows for R project creation and development\n:::\n\n运行后会在RStudio中以新标签页的方式打开一个.Renviron文件。在其中输入：\n\n``` md\nR_MAX_VSIZE=50Gb\n```\n\n::: callout-caution\n注意这里的内存数值包括了物理内存和虚拟内存，所以如果你的电脑的实际内存为16GB，那么在这里需要输入比16GB更大的数值，输入16GB是不会有帮助的。\n:::\n\n保存这个文件后，重启RStudio，这时候内存上限就被修改好了。\n\n![RStudio调用虚拟内存执行脚本](images/截屏2024-01-14%2010.33.37.png){width=\"290\"}\n\n【方法二：通过终端配置】\n\n打开终端（Terminal），在其中输入：\n\n``` md\ncd ~\ntouch .Renviron\nopen .Renviron\n```\n\n这时会打开.Renviron文件，在其中输入：\n\n``` md\nR_MAX_VSIZE=50Gb\n```\n\n保存文件，重启RStudio。\n\n## 自动整理代码\n\n[The tidyverse style guide](https://style.tidyverse.org/index.html)**对代码编写时的规范格式进行了详细说明。通过**[styler包](https://styler.r-lib.org)可以实现对代码的自动整理，有助于保持不同项目之间的代码风格一致，并促进协作。安装styler后通过运行下面的命令即可自动整理当前打开的文档的代码。\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-11_654c77be2ece9aa60301853c942017eb'}\n\n```{.r .cell-code}\ninstall.packages(\"styler\")\nstyler:::style_active_file()\n```\n:::\n\n\n也可以用通过打开Rstudio的插件（Addins），选择\"Style active file\"来实现对当前R脚本的代码整理。或者选择一段代码后，点击\"Style selection\"来对选中的代码进行整理。\n\n![Rstudio插件](images/screenshot_2023-11-14%2011.44.02.png){#fig-插件 width=\"219\"}\n\n## Rstudio主题\n\n[`rsthemes`](https://www.garrickadenbuie.com/project/rsthemes/#installation)包提供了多种额外的主题。\n\n![](images/rsthemes.gif)\n\n该包通过[r-universe](https://gadenbuie.r-universe.dev/)进行安装：\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-12_7ec047f644d902d8197f744c984ec752'}\n\n```{.r .cell-code}\ninstall.packages(\n  \"rsthemes\",\n  repos = c(gadenbuie = 'https://gadenbuie.r-universe.dev', getOption(\"repos\"))\n)\n```\n:::\n\n\n然后安装主题：\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-13_ef58f74689d5c2ace258719e23f210b2'}\n\n```{.r .cell-code}\nrsthemes::install_rsthemes()\n```\n:::\n\n\n使用：\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-14_00ebc935b029ef1bf46be2d544749cc5'}\n\n```{.r .cell-code}\n# 列出所有来自rsthemes的主题\nrsthemes::list_rsthemes()\n\n# 依次尝试所有主题\nrsthemes::try_rsthemes()\n\n# 只尝试浅色主题\nrsthemes::try_rsthemes(\"light\")\n```\n:::\n\n\n通过Tools \\> Global Options \\> Appearance也可以浏览和应用这些主题。\n\n安装该包后还会在Rstudio的插件中显示，可以方便的进行深色和浅色模式的切换。要实现这一点，需要打开R的配置文件（\\~/.Rprofile），可以通过下面的方式快速打开：\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-15_004ab86ff6028c1f922006a28540f6b2'}\n\n```{.r .cell-code}\nusethis::edit_r_profile()\n```\n:::\n\n\n然后将下面的代码粘贴进配置文件：\n\n\n::: {.cell hash='environment_configuration_cache/html/unnamed-chunk-16_2e6fe0ed395058a12ad9f505be8e6dd8'}\n\n```{.r .cell-code}\nif (interactive()) {\n  rsthemes::set_theme_light(\"Chrome\") # 默认的浅色主题\n  rsthemes::set_theme_dark(\"Cobalt\") # 默认的深色主题\n  rsthemes::set_theme_favorite( # 再添加一些主题作为备选\n    c(\n      \"GitHub {rsthemes}\",\n      \"Material Palenight {rsthemes}\"\n    )\n  )\n}\n```\n:::\n\n\n现在就可以通过点击插件中的\"Toggle Dark Mode\"来一键切换深色和浅色主题了（@fig-插件 ）。同时，点击\"Next Favorite Theme\"可以切换上面设置的`set_theme_favorite()`里面的主题。\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}