{
  "hash": "e83476b94f46a6d773a02555aab15a40",
  "result": {
    "markdown": "---\ntitle: \"多个单细胞数据集整合分析（下）\"\n---\n\n\n> 参考：[单细胞多数据集整合示例](https://mp.weixin.qq.com/s/51PtUi7ZKp1nbrFGElU74A)\n\n[上一节](/single_cell/sc_supplementary/integrated_analysis_multiple_single_cell_datasets_1.qmd)中我们完成了对GSE150430的分群注释，并提取了髓系细胞亚群，本节对髓系细胞进一步分群。\n\n# 加载包\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-1_4581e84b8b325f59266a2255291ace62'}\n\n```{.r .cell-code}\nlibrary(Seurat)\nlibrary(ggplot2)\nlibrary(cowplot)\nlibrary(dplyr)\nlibrary(clustree)\nlibrary(scCustomize)\n```\n:::\n\n\n# 髓系细胞进一步归一化、整合、降维、分群\n\n## SCTransform、PCA\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-2_b1d7ae7375b0b952517fc1a170bc3b42'}\n\n```{.r .cell-code}\nmyeloid_seurat <- readRDS(\"output/sc_supplementary/GSE150430_myeloid_seurat.RDS\")\n\n# SCTranform\nmyeloid_seurat <- SCTransform(myeloid_seurat, verbose = FALSE)\nmyeloid_seurat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn object of class Seurat \n39690 features across 3997 samples within 2 assays \nActive assay: SCT (14970 features, 3000 variable features)\n 3 layers present: counts, data, scale.data\n 1 other assay present: RNA\n```\n:::\n\n```{.r .cell-code}\n# Check which assays are stored in objects\nmyeloid_seurat@assays\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$RNA\nAssay (v5) data with 24720 features for 3997 cells\nFirst 10 features:\n RP11-34P13.7, RP11-34P13.8, AL627309.1, AP006222.2, RP4-669L17.10,\nRP4-669L17.2, RP5-857K21.4, RP11-206L10.3, RP11-206L10.5, RP11-206L10.2 \nLayers:\n counts.N01, counts.P01, counts.P02, counts.P03, counts.P04, counts.P05,\ncounts.P06, counts.P07, counts.P08, counts.P09, counts.P10, counts.P11,\ncounts.P12, counts.P13, counts.P14, counts.P15 \n\n$SCT\nSCTAssay data with 14970 features for 3997 cells, and 16 SCTModel(s) \nTop 10 variable features:\n IL1RN, CLEC10A, PKIB, HBEGF, MSR1, IER3, LGMN, CA2, CFD, GLUL \n```\n:::\n\n```{.r .cell-code}\n# 查看目前默认的assay\nDefaultAssay(myeloid_seurat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"SCT\"\n```\n:::\n\n```{.r .cell-code}\n# 查看默认assay的layers\nLayers(myeloid_seurat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"counts\"     \"data\"       \"scale.data\"\n```\n:::\n\n```{.r .cell-code}\n# 执行PCA\nmyeloid_seurat <- RunPCA(myeloid_seurat)\n```\n:::\n\n\n## 不进行整合时检查细胞分群情况：\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-3_dccaa33aa45622477ccf818b3325c4cf'}\n\n```{.r .cell-code}\n# 查看降维信息\nnames(myeloid_seurat@reductions)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"pca\"\n```\n:::\n\n```{.r .cell-code}\n# Run UMAP\nmyeloid_seurat <- RunUMAP(myeloid_seurat, \n                          dims = 1:40, \n                          reduction = \"pca\",\n                          reduction.name = \"umap.unintegrated\")\n\n# 分群\n# Determine the K-nearest neighbor graph\nmyeloid_seurat <- FindNeighbors(myeloid_seurat, \n                                dims = 1:40, \n                                reduction = \"pca\")\nmyeloid_seurat <- FindClusters(myeloid_seurat, \n                               cluster.name = \"unintegrated_clusters\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 3997\nNumber of edges: 211202\n\nRunning Louvain algorithm...\nMaximum modularity in 10 random starts: 0.7202\nNumber of communities: 8\nElapsed time: 0 seconds\n```\n:::\n\n```{.r .cell-code}\n# Plot UMAP\np1 <- DimPlot(myeloid_seurat, \n              reduction = \"umap.unintegrated\",\n              group.by = \"samples\")\np2 <- DimPlot(myeloid_seurat, \n              reduction = \"umap.unintegrated\",\n              split.by = \"samples\")\nplot_grid(p1, p2, \n          ncol = 1, labels = \"AUTO\")\n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-3-1.png){width=960}\n:::\n:::\n\n\n## 整合\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-4_806cd80dd73779e1359589a4163bdd7c'}\n\n```{.r .cell-code}\n# 整合\nmyeloid_integrated <- IntegrateLayers(object = myeloid_seurat,\n                                      method = HarmonyIntegration,\n                                      verbose = FALSE)\n\n\n# 整合后合并RNA layer\nmyeloid_integrated[[\"RNA\"]] <- JoinLayers(myeloid_integrated[[\"RNA\"]])\n\n# 查看整合后的降维信息\nnames(myeloid_integrated@reductions)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"pca\"               \"umap.unintegrated\" \"harmony\"          \n```\n:::\n:::\n\n\n## **整合后检验细胞分群情况**\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-5_7ce40d54c7272ca4eba430b2c46a92cc'}\n\n```{.r .cell-code}\nset.seed(123456)\n# Run UMAP\nmyeloid_integrated <- RunUMAP(myeloid_integrated, \n                              dims = 1:40,\n                              reduction = \"harmony\", # 更改降维来源为整合后的\"harmony\"\n                              reduction.name = \"umap.integrated\")\nnames(myeloid_integrated@reductions)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"pca\"               \"umap.unintegrated\" \"harmony\"          \n[4] \"umap.integrated\"  \n```\n:::\n\n```{.r .cell-code}\n# 分群\nmyeloid_integrated <- FindNeighbors(myeloid_integrated, \n                                    dims = 1:40, \n                                    reduction = \"harmony\") #更改降维来源为\"harmony\"\nmyeloid_integrated <- FindClusters(myeloid_integrated, \n                                   cluster.name = \"integrated_clusters\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nModularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck\n\nNumber of nodes: 3997\nNumber of edges: 290917\n\nRunning Louvain algorithm...\nMaximum modularity in 10 random starts: 0.7795\nNumber of communities: 10\nElapsed time: 0 seconds\n```\n:::\n\n```{.r .cell-code}\ncolnames(myeloid_integrated@meta.data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"orig.ident\"            \"nCount_RNA\"            \"nFeature_RNA\"         \n [4] \"samples\"               \"log10GenesPerUMI\"      \"mitoRatio\"            \n [7] \"cells\"                 \"S.Score\"               \"G2M.Score\"            \n[10] \"Phase\"                 \"mitoFr\"                \"groups\"               \n[13] \"old_clusters\"          \"nCount_SCT\"            \"nFeature_SCT\"         \n[16] \"unintegrated_clusters\" \"seurat_clusters\"       \"integrated_clusters\"  \n```\n:::\n\n```{.r .cell-code}\n# Plot UMAP                             \np3 <- DimPlot(myeloid_integrated, \n              reduction = \"umap.integrated\", \n              group.by = \"samples\")\np4 <- DimPlot(myeloid_integrated, \n              reduction = \"umap.integrated\", \n              split.by = \"samples\")\nplot_grid(p1, p3, p2, p4, \n          ncol = 1, \n          labels = c(\"Before Harmony\", \"After Harmony\", \n                     \"Before Harmony\", \"After Harmony\"))\n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-5-1.png){width=960}\n:::\n:::\n\n\n## 聚类\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-6_32fcc4232aee3163940122418ae5137f'}\n\n```{.r .cell-code}\n# Determine the clusters for various resolutions                                \nmyeloid_integrated <- FindClusters(myeloid_integrated,\n                                   resolution = c(0.01, 0.05, 0.1, 0.2, 0.3, \n                                                  0.4, 0.5, 0.8, 1),\n                                   verbose = F)\n# Explore resolutions\nhead(myeloid_integrated@meta.data, 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                       orig.ident nCount_RNA nFeature_RNA samples\nN01_AGCGTCGAGTGAAGAG.1        N01   2691.228         2086     N01\nN01_GCAATCATCAGCCTAA.1        N01   2139.759         1566     N01\nN01_CGTGTAATCCCACTTG.1        N01   2251.166         1803     N01\nN01_AAACGGGCATTTCAGG.1        N01   1909.545         1226     N01\nN01_AAAGATGCAATGTAAG.1        N01   1796.109         1360     N01\n                       log10GenesPerUMI   mitoRatio                  cells\nN01_AGCGTCGAGTGAAGAG.1        0.9677441 0.010726702 N01_AGCGTCGAGTGAAGAG.1\nN01_GCAATCATCAGCCTAA.1        0.9592918 0.018235699 N01_GCAATCATCAGCCTAA.1\nN01_CGTGTAATCCCACTTG.1        0.9712410 0.017482940 N01_CGTGTAATCCCACTTG.1\nN01_AAACGGGCATTTCAGG.1        0.9413461 0.011039803 N01_AAACGGGCATTTCAGG.1\nN01_AAAGATGCAATGTAAG.1        0.9628822 0.006095955 N01_AAAGATGCAATGTAAG.1\n                            S.Score   G2M.Score Phase mitoFr groups\nN01_AGCGTCGAGTGAAGAG.1 -0.093324147 -0.04497299    G1 Medium Normal\nN01_GCAATCATCAGCCTAA.1  0.008569604 -0.03484456     S   High Normal\nN01_CGTGTAATCCCACTTG.1 -0.013729028 -0.05064395    G1   High Normal\nN01_AAACGGGCATTTCAGG.1 -0.005136538 -0.03723796    G1 Medium Normal\nN01_AAAGATGCAATGTAAG.1 -0.039476505 -0.04625311    G1    Low Normal\n                               old_clusters nCount_SCT nFeature_SCT\nN01_AGCGTCGAGTGAAGAG.1          Macrophages       2455         1929\nN01_GCAATCATCAGCCTAA.1          Macrophages       2252         1505\nN01_CGTGTAATCCCACTTG.1          Macrophages       2359         1712\nN01_AAACGGGCATTTCAGG.1          Macrophages       2044         1197\nN01_AAAGATGCAATGTAAG.1 Myeloid (unspecific)       2271         1322\n                       unintegrated_clusters seurat_clusters\nN01_AGCGTCGAGTGAAGAG.1                     0               5\nN01_GCAATCATCAGCCTAA.1                     0               6\nN01_CGTGTAATCCCACTTG.1                     0               5\nN01_AAACGGGCATTTCAGG.1                     6               7\nN01_AAAGATGCAATGTAAG.1                     5              10\n                       integrated_clusters SCT_snn_res.0.01 SCT_snn_res.0.05\nN01_AGCGTCGAGTGAAGAG.1                   3                0                0\nN01_GCAATCATCAGCCTAA.1                   3                0                0\nN01_CGTGTAATCCCACTTG.1                   3                0                0\nN01_AAACGGGCATTTCAGG.1                   1                0                0\nN01_AAAGATGCAATGTAAG.1                   7                0                1\n                       SCT_snn_res.0.1 SCT_snn_res.0.2 SCT_snn_res.0.3\nN01_AGCGTCGAGTGAAGAG.1               0               0               3\nN01_GCAATCATCAGCCTAA.1               0               0               3\nN01_CGTGTAATCCCACTTG.1               0               0               3\nN01_AAACGGGCATTTCAGG.1               1               1               1\nN01_AAAGATGCAATGTAAG.1               3               4               5\n                       SCT_snn_res.0.4 SCT_snn_res.0.5 SCT_snn_res.0.8\nN01_AGCGTCGAGTGAAGAG.1               3               3               3\nN01_GCAATCATCAGCCTAA.1               3               3               3\nN01_CGTGTAATCCCACTTG.1               3               3               3\nN01_AAACGGGCATTTCAGG.1               1               1               1\nN01_AAAGATGCAATGTAAG.1               6               7               7\n                       SCT_snn_res.1\nN01_AGCGTCGAGTGAAGAG.1             5\nN01_GCAATCATCAGCCTAA.1             6\nN01_CGTGTAATCCCACTTG.1             5\nN01_AAACGGGCATTTCAGG.1             7\nN01_AAAGATGCAATGTAAG.1            10\n```\n:::\n\n```{.r .cell-code}\n# 查看各个分辨率下的细胞分群情况\nselect(myeloid_integrated@meta.data, \n       starts_with(match = \"SCT_snn_res.\")) %>%  \n  lapply(levels)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$SCT_snn_res.0.01\n[1] \"0\"\n\n$SCT_snn_res.0.05\n[1] \"0\" \"1\"\n\n$SCT_snn_res.0.1\n[1] \"0\" \"1\" \"2\" \"3\"\n\n$SCT_snn_res.0.2\n[1] \"0\" \"1\" \"2\" \"3\" \"4\"\n\n$SCT_snn_res.0.3\n[1] \"0\" \"1\" \"2\" \"3\" \"4\" \"5\"\n\n$SCT_snn_res.0.4\n[1] \"0\" \"1\" \"2\" \"3\" \"4\" \"5\" \"6\" \"7\"\n\n$SCT_snn_res.0.5\n[1] \"0\" \"1\" \"2\" \"3\" \"4\" \"5\" \"6\" \"7\" \"8\"\n\n$SCT_snn_res.0.8\n [1] \"0\" \"1\" \"2\" \"3\" \"4\" \"5\" \"6\" \"7\" \"8\" \"9\"\n\n$SCT_snn_res.1\n [1] \"0\"  \"1\"  \"2\"  \"3\"  \"4\"  \"5\"  \"6\"  \"7\"  \"8\"  \"9\"  \"10\" \"11\" \"12\"\n```\n:::\n:::\n\n\n绘制聚类树展示不同分辨率下的细胞分群情况及相互关系\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-7_c1d731cddcbda95d5dadc3cb50447288'}\n\n```{.r .cell-code}\ntree <- clustree(myeloid_integrated@meta.data, \n                 prefix = \"SCT_snn_res.\") # 指定包含聚类信息的列\ntree\n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n这里，选取分辨为0.8\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-8_6c799349b9c9a56e842974525fef5606'}\n\n```{.r .cell-code}\nIdents(myeloid_integrated) <- \"SCT_snn_res.0.8\"\n```\n:::\n\n\n聚类可视化\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-9_cfb3a1169e649f84bef18165c2ea06dd'}\n\n```{.r .cell-code}\n# Plot the UMAP\nDimPlot(myeloid_integrated,\n        reduction = \"umap.integrated\",\n        label = T)\n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-9-1.png){width=480}\n:::\n:::\n\n\n## **细胞分群质量评估**\n\n分析样本类型是否影响细胞分群\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-10_4fbc7dc56b04a7506d232e7167601447'}\n\n```{.r .cell-code}\n# 先简单查看不同cluster的细胞数\ntable(myeloid_integrated@active.ident)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  0   1   2   3   4   5   6   7   8   9 \n891 737 642 419 406 280 229 191 127  75 \n```\n:::\n\n```{.r .cell-code}\n# 查看不同样本类型中的细胞分群情况\nDimPlot(myeloid_integrated, \n        reduction = \"umap.integrated\",\n        label = TRUE, \n        split.by = \"groups\") + \n  NoLegend()\n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n分析细胞周期是否影响细胞分群\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-11_c134eb17875f826bff3f62bb07222e26'}\n\n```{.r .cell-code}\n# Explore whether clusters segregate by cell cycle phase\nDimPlot(myeloid_integrated,\n        reduction = \"umap.integrated\",\n        label = TRUE, \n        split.by = \"Phase\") + \n  NoLegend()\n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n分析其他非期望变异来源是否会影响细胞分群\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-12_7d8b662dd6d8c588309e404bc7a0a207'}\n\n```{.r .cell-code}\n# Determine metrics to plot present in seurat_clustered@meta.data\nmetrics <-  c(\"nCount_RNA\", \"nFeature_RNA\", \"S.Score\", \"G2M.Score\", \"mitoRatio\")\n\nFeaturePlot(myeloid_integrated, \n            reduction = \"umap.integrated\", \n            features = metrics,\n            pt.size = 0.4, \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-12-1.png){width=960}\n:::\n:::\n\n\n保存\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-13_e60ed15a584ef82bccbfa6bce545f604'}\n\n```{.r .cell-code}\nsaveRDS(myeloid_integrated, \n        file = \"output/sc_supplementary/GSE150430_myeloid_clustered.RDS\")\n```\n:::\n\n\n## 亚群细胞注释\n\n髓系亚群进一步细分的marker如下：\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-14_1cb96abf8aa8adff9ac964576d42f0e5'}\n\n```{.r .cell-code}\ngenes_to_check <- list(\n  Mac = c(\"CD14\", \"CD163\", \"APOE\", \"C1QA\", \"C1QB\", \"C1QC\"),\n  pDC = c(\"LILRA4\", \"IL3RA\", \"TCF4\", \"TCL1A\", \"CLEC4C\"),\n  DC1 = c(\"CLEC9A\", \"XCR1\", \"BATF3\"),\n  DC2 = c(\"CD1A\", \"FCER1A\", \"CD1C\", \"CD1E\", \"CLEC10A\"),\n  DC3 = c(\"CCR7\", \"LAMP3\", \"FSCN1\", \"CCL22\", \"BIRC3\"),\n  Mono = c(\"VCVN\", \"FCN1\", \"S100A12\", \"S100A8\", \"S100A9\", \"FCGR3A\")\n)\n```\n:::\n\n\n查看marker基因的表达：\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-15_34ed47817995e379859c03a42fe76a56'}\n\n```{.r .cell-code}\nDotPlot(myeloid_integrated,\n        features = genes_to_check) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-15-1.png){width=960}\n:::\n:::\n\n\n手动注释：\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-16_0d70840d5034a0e2948ee0b05cfb7632'}\n\n```{.r .cell-code}\nmyeloid_clustered <- RenameIdents(\n  myeloid_integrated,\n  \"0\" = \"Macrophages\",\n  \"1\" = \"DC2\",\n  \"2\" = \"Unknown\",\n  \"3\" = \"Macrophages\",\n  \"4\" = \"Monocyte\",\n  \"5\" = \"Macrophages\",\n  \"6\" = \"Unknown\",\n  \"7\" = \"DC1\",\n  \"8\" = \"DC2\",\n  \"9\" = \"Macrophages\"\n)\ntable(Idents(myeloid_clustered))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nMacrophages         DC2     Unknown    Monocyte         DC1 \n       1665         864         871         406         191 \n```\n:::\n\n```{.r .cell-code}\n# Plot the UMAP\np1 <- DimPlot(\n  myeloid_clustered,\n  reduction = \"umap.integrated\",\n  label = T\n)\np1\n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-16-1.png){width=480}\n:::\n:::\n\n\n在注释好的数据中再次检查marker基因的表达情况：\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-17_47ae1ce3e75050be30f28d9f377f9ec4'}\n\n```{.r .cell-code}\nDotPlot(myeloid_clustered, \n        features = genes_to_check) + \n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) \n```\n\n::: {.cell-output-display}\n![](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-17-1.png){width=960}\n:::\n:::\n\n\n这里我们参考[Seurat-对`FeaturePlot`的进一步修饰](/single_cell/seurat/data_visualization_methods_in_seurat.qmd#sec-Further_modifications_to_featureplot)中的方法，可视化巨噬细胞marker基因的共表达情况：\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-18_99b240e2206ffe10648df78923d14b46'}\n\n```{.r .cell-code}\np2 <- Plot_Density_Joint_Only(\n  myeloid_clustered,\n  features = c(\n    \"CD14\", \"CD163\", \"APOE\",\n    \"C1QA\", \"C1QB\", \"C1QC\"\n  ),\n  reduction = \"umap.integrated\",\n  custom_palette = BlueAndRed()\n)\np2\n```\n\n::: {.cell-output-display}\n![髓系细胞进一步分群及巨噬细胞marker基因共表达情况](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-18-1.png){width=960}\n:::\n\n```{.r .cell-code}\nplot_grid(\n  p1, p2,\n  labels = \"AUTO\"\n)\n```\n\n::: {.cell-output-display}\n![髓系细胞进一步分群及巨噬细胞marker基因共表达情况](integrated_analysis_multiple_single_cell_datasets_2_files/figure-html/unnamed-chunk-18-2.png){width=960}\n:::\n:::\n\n\n保存\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-19_3c94e0a063aae6fe3ef8c5208cb661c4'}\n\n```{.r .cell-code}\nsaveRDS(myeloid_clustered, \n        file = \"output/sc_supplementary/GSE150430_myeloid_clustered.RDS\")\n```\n:::\n\n\n------------------------------------------------------------------------\n\n# 整合三个数据集的髓系细胞\n\n后面分别对[**GSE150825**](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?&acc=GSE150825)**, [GSE162025](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?&acc=GSE162025)**两个数据集进行同样的处理，即先大致分群，然后提取髓系细胞进一步分群，保存文件名为“GSE\\*\\*\\*\\_myeloid_clustered.RDS”的文件。最后读取三个数据集，整合重新降维分群，再继续分析。这里不再实际分析。\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-20_ec7b6c34a7ecf714532597aad4aae3ed'}\n\n```{.r .cell-code}\n### 不运行 ###\n# 读取三个数据集的髓系细胞\nmyeloid_clustered_1 <- readRDS(\"output/sc_supplementary/GSE150430_myeloid_clustered.RDS\")\nmyeloid_clustered_2 <- readRDS(\"output/sc_supplementary/GSE150825_myeloid_clustered.RDS\")\nmyeloid_clustered_3 <- readRDS(\"output/sc_supplementary/GSE162025_myeloid_clustered.RDS\")\n\n# 添加数据集标识便于识别\nmyeloid_clustered_1$GSE_num = \"GSE150430\"\nmyeloid_clustered_2$GSE_num = \"GSE150825\"\nmyeloid_clustered_3$GSE_num = \"GSE162025\"\n\n# 合并三个数据集\nmyeloid_merged <-  merge(\n  GSE150430,\n  list(GSE150825, GSE162025),\n  add.cell.ids = c('GSE150430','GSE150825','GSE162025')\n  )\ntable(myeloid_merged$GSE_num)\ncolnames(myeloid_merged@meta.data)\n\n# 重新构建Seurat对象以便重新归一化、整合、降维等\nsce <- CreateSeuratObject(\n  myeloid_merged@assays[[\"RNA\"]],\n  meta.data = sce@meta.data\n  )\nsce\ntable(sce$groups)\n```\n:::\n\n\n------------------------------------------------------------------------\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n## Session Info\n\n\n::: {.cell hash='integrated_analysis_multiple_single_cell_datasets_2_cache/html/unnamed-chunk-21_5536021d7c90e4e6b45765ab4833daf7'}\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Sonoma 14.3\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] scCustomize_2.0.1  clustree_0.5.1     ggraph_2.1.0       dplyr_1.1.4       \n[5] cowplot_1.1.2      ggplot2_3.4.4      Seurat_5.0.1       SeuratObject_5.0.1\n[9] sp_2.1-2          \n\nloaded via a namespace (and not attached):\n  [1] RcppAnnoy_0.0.21            splines_4.3.2              \n  [3] later_1.3.2                 bitops_1.0-7               \n  [5] tibble_3.2.1                polyclip_1.10-6            \n  [7] janitor_2.2.0               fastDummies_1.7.3          \n  [9] lifecycle_1.0.4             globals_0.16.2             \n [11] lattice_0.22-5              MASS_7.3-60.0.1            \n [13] backports_1.4.1             magrittr_2.0.3             \n [15] plotly_4.10.4               rmarkdown_2.25             \n [17] yaml_2.3.8                  httpuv_1.6.13              \n [19] glmGamPoi_1.14.0            sctransform_0.4.1          \n [21] spam_2.10-0                 spatstat.sparse_3.0-3      \n [23] reticulate_1.34.0           pbapply_1.7-2              \n [25] RColorBrewer_1.1-3          lubridate_1.9.3            \n [27] abind_1.4-5                 zlibbioc_1.48.0            \n [29] Rtsne_0.17                  GenomicRanges_1.54.1       \n [31] purrr_1.0.2                 BiocGenerics_0.48.1        \n [33] RCurl_1.98-1.14             pracma_2.4.4               \n [35] tweenr_2.0.2                circlize_0.4.16            \n [37] GenomeInfoDbData_1.2.11     IRanges_2.36.0             \n [39] S4Vectors_0.40.2            ggrepel_0.9.5              \n [41] irlba_2.3.5.1               listenv_0.9.0              \n [43] spatstat.utils_3.0-4        goftest_1.2-3              \n [45] RSpectra_0.16-1             spatstat.random_3.2-2      \n [47] fitdistrplus_1.1-11         parallelly_1.36.0          \n [49] DelayedMatrixStats_1.24.0   DelayedArray_0.28.0        \n [51] leiden_0.4.3.1              codetools_0.2-19           \n [53] ggforce_0.4.1               tidyselect_1.2.0           \n [55] shape_1.4.6                 farver_2.1.1               \n [57] viridis_0.6.4               matrixStats_1.2.0          \n [59] stats4_4.3.2                spatstat.explore_3.2-5     \n [61] jsonlite_1.8.8              ks_1.14.2                  \n [63] ellipsis_0.3.2              tidygraph_1.3.0            \n [65] progressr_0.14.0            ggridges_0.5.5             \n [67] survival_3.5-7              tools_4.3.2                \n [69] ica_1.0-3                   Rcpp_1.0.12                \n [71] glue_1.7.0                  SparseArray_1.2.3          \n [73] gridExtra_2.3               xfun_0.41                  \n [75] MatrixGenerics_1.14.0       GenomeInfoDb_1.38.5        \n [77] withr_3.0.0                 fastmap_1.1.1              \n [79] fansi_1.0.6                 digest_0.6.34              \n [81] timechange_0.2.0            R6_2.5.1                   \n [83] mime_0.12                   ggprism_1.0.4              \n [85] colorspace_2.1-0            scattermore_1.2            \n [87] tensor_1.5                  spatstat.data_3.0-4        \n [89] RhpcBLASctl_0.23-42         Nebulosa_1.12.0            \n [91] utf8_1.2.4                  tidyr_1.3.0                \n [93] generics_0.1.3              data.table_1.14.10         \n [95] S4Arrays_1.2.0              graphlayouts_1.0.2         \n [97] httr_1.4.7                  htmlwidgets_1.6.4          \n [99] uwot_0.1.16                 pkgconfig_2.0.3            \n[101] gtable_0.3.4                lmtest_0.9-40              \n[103] SingleCellExperiment_1.24.0 XVector_0.42.0             \n[105] htmltools_0.5.7             dotCall64_1.1-1            \n[107] scales_1.3.0                Biobase_2.62.0             \n[109] png_0.1-8                   harmony_1.2.0              \n[111] snakecase_0.11.1            knitr_1.45                 \n[113] rstudioapi_0.15.0           reshape2_1.4.4             \n[115] checkmate_2.3.1             nlme_3.1-164               \n[117] zoo_1.8-12                  GlobalOptions_0.1.2        \n[119] stringr_1.5.1               KernSmooth_2.23-22         \n[121] parallel_4.3.2              miniUI_0.1.1.1             \n[123] vipor_0.4.7                 ggrastr_1.0.2              \n[125] pillar_1.9.0                grid_4.3.2                 \n[127] vctrs_0.6.5                 RANN_2.6.1                 \n[129] promises_1.2.1              xtable_1.8-4               \n[131] cluster_2.1.6               beeswarm_0.4.0             \n[133] paletteer_1.5.0             evaluate_0.23              \n[135] mvtnorm_1.2-4               cli_3.6.2                  \n[137] compiler_4.3.2              crayon_1.5.2               \n[139] rlang_1.1.3                 future.apply_1.11.1        \n[141] labeling_0.4.3              mclust_6.0.1               \n[143] rematch2_2.1.2              plyr_1.8.9                 \n[145] forcats_1.0.0               ggbeeswarm_0.7.2           \n[147] stringi_1.8.3               viridisLite_0.4.2          \n[149] deldir_2.0-2                munsell_0.5.0              \n[151] lazyeval_0.2.2              spatstat.geom_3.2-7        \n[153] Matrix_1.6-5                RcppHNSW_0.5.0             \n[155] patchwork_1.2.0             sparseMatrixStats_1.14.0   \n[157] future_1.33.1               shiny_1.8.0                \n[159] SummarizedExperiment_1.32.0 ROCR_1.0-11                \n[161] igraph_1.6.0               \n```\n:::\n:::\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}