{
  "hash": "e08efb758f1c9263e9ebe671f25d8994",
  "result": {
    "markdown": "# 读取非标准格式的单细胞数据\n\n## 读取非标准10X格式文件 {#sec-Read_non-standard_10x_files}\n\n该案例来自文献 [@xu2022]。该研究为了系统地研究高级别浆膜上皮卵巢癌（HGSOC）的肿瘤内异质性，采用深层单细胞RNA测序技术(scRNA-seq)**对7例初治HGSOC早期和晚期患者及5例年龄匹配的非恶性卵巢组织标本进行肿瘤分析。**共获得59,324个HGSOC和非恶性卵巢组织的单细胞，其中，33264个细胞（56%）来⾃HGSOC肿瘤患者组织，26060个（44%）来⾃⾮恶性卵巢组织标本。原始数据：[GSE184880](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE184880)。\n\n![](images/640-01.png)\n\n可以看到原始数据以10X格式提供:\n\n![](images/截屏2024-01-08%2011.17.00.png){width=\"465\"}\n\n但是，**没有按照标准的10X格式的三个文件命名，并且没有按照样本分别建立文件夹**。所以需要对其进行整理：\n\n-   首先给每个样本建立文件夹\n\n-   然后将对应的10X标准格式的三个文件分别复制到各个样本文件夹内\n\n-   最后将文件重命名为10X格式要求的标准形式，即**“barcodes.tsv.gz”、\"features.tsv.gz\"、\"matrix.mtx.gz\"**\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-1_39129bf8b407dd8fb905293b98f9e57b'}\n\n```{.r .cell-code}\nlibrary(Seurat)\nlibrary(stringr)\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-2_e5a051a0afb0f5adbb71a37ea9e65e67'}\n\n```{.r .cell-code}\n# 给每个样本建立文件夹\nfiles <- list.files(\"data/sc_supplementary/GSE184880_RAW\")\nfiles\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"GSM5599220_Norm1\"                   \"GSM5599220_Norm1.barcodes.tsv.gz\"  \n [3] \"GSM5599220_Norm1.genes.tsv.gz\"      \"GSM5599220_Norm1.matrix.mtx.gz\"    \n [5] \"GSM5599221_Norm2\"                   \"GSM5599221_Norm2.barcodes.tsv.gz\"  \n [7] \"GSM5599221_Norm2.genes.tsv.gz\"      \"GSM5599221_Norm2.matrix.mtx.gz\"    \n [9] \"GSM5599222_Norm3\"                   \"GSM5599222_Norm3.barcodes.tsv.gz\"  \n[11] \"GSM5599222_Norm3.genes.tsv.gz\"      \"GSM5599222_Norm3.matrix.mtx.gz\"    \n[13] \"GSM5599223_Norm4\"                   \"GSM5599223_Norm4.barcodes.tsv.gz\"  \n[15] \"GSM5599223_Norm4.genes.tsv.gz\"      \"GSM5599223_Norm4.matrix.mtx.gz\"    \n[17] \"GSM5599224_Norm5\"                   \"GSM5599224_Norm5.barcodes.tsv.gz\"  \n[19] \"GSM5599224_Norm5.genes.tsv.gz\"      \"GSM5599224_Norm5.matrix.mtx.gz\"    \n[21] \"GSM5599225_Cancer1\"                 \"GSM5599225_Cancer1.barcodes.tsv.gz\"\n[23] \"GSM5599225_Cancer1.genes.tsv.gz\"    \"GSM5599225_Cancer1.matrix.mtx.gz\"  \n[25] \"GSM5599226_Cancer2\"                 \"GSM5599226_Cancer2.barcodes.tsv.gz\"\n[27] \"GSM5599226_Cancer2.genes.tsv.gz\"    \"GSM5599226_Cancer2.matrix.mtx.gz\"  \n[29] \"GSM5599227_Cancer3\"                 \"GSM5599227_Cancer3.barcodes.tsv.gz\"\n[31] \"GSM5599227_Cancer3.genes.tsv.gz\"    \"GSM5599227_Cancer3.matrix.mtx.gz\"  \n[33] \"GSM5599228_Cancer4\"                 \"GSM5599228_Cancer4.barcodes.tsv.gz\"\n[35] \"GSM5599228_Cancer4.genes.tsv.gz\"    \"GSM5599228_Cancer4.matrix.mtx.gz\"  \n[37] \"GSM5599229_Cancer5\"                 \"GSM5599229_Cancer5.barcodes.tsv.gz\"\n[39] \"GSM5599229_Cancer5.genes.tsv.gz\"    \"GSM5599229_Cancer5.matrix.mtx.gz\"  \n[41] \"GSM5599230_Cancer6\"                 \"GSM5599230_Cancer6.barcodes.tsv.gz\"\n[43] \"GSM5599230_Cancer6.genes.tsv.gz\"    \"GSM5599230_Cancer6.matrix.mtx.gz\"  \n[45] \"GSM5599231_Cancer7\"                 \"GSM5599231_Cancer7.barcodes.tsv.gz\"\n[47] \"GSM5599231_Cancer7.genes.tsv.gz\"    \"GSM5599231_Cancer7.matrix.mtx.gz\"  \n```\n:::\n\n```{.r .cell-code}\ndirnames <- gsub(pattern = \".barcodes.tsv.gz|.genes.tsv.gz|.matrix.mtx.gz\", \n                 replacement = \"\", \n                 x = files) %>%  \n  unique() %>% \n  paste0(\"data/sc_supplementary/GSE184880_RAW/\", .)\ndirnames\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"data/sc_supplementary/GSE184880_RAW/GSM5599220_Norm1\"  \n [2] \"data/sc_supplementary/GSE184880_RAW/GSM5599221_Norm2\"  \n [3] \"data/sc_supplementary/GSE184880_RAW/GSM5599222_Norm3\"  \n [4] \"data/sc_supplementary/GSE184880_RAW/GSM5599223_Norm4\"  \n [5] \"data/sc_supplementary/GSE184880_RAW/GSM5599224_Norm5\"  \n [6] \"data/sc_supplementary/GSE184880_RAW/GSM5599225_Cancer1\"\n [7] \"data/sc_supplementary/GSE184880_RAW/GSM5599226_Cancer2\"\n [8] \"data/sc_supplementary/GSE184880_RAW/GSM5599227_Cancer3\"\n [9] \"data/sc_supplementary/GSE184880_RAW/GSM5599228_Cancer4\"\n[10] \"data/sc_supplementary/GSE184880_RAW/GSM5599229_Cancer5\"\n[11] \"data/sc_supplementary/GSE184880_RAW/GSM5599230_Cancer6\"\n[12] \"data/sc_supplementary/GSE184880_RAW/GSM5599231_Cancer7\"\n```\n:::\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-3_e77e40c1ce7cb3876b69097005c719be'}\n\n```{.r .cell-code}\nlapply(dirnames, dir.create, showWarnings = FALSE)\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-4_35aaa4f9fef8c2fa0c493d136d7b0bd0'}\n\n```{.r .cell-code}\nlapply(files, function(files) {\n  # 复制相应的10X文件到各个样本文件夹内\n  new_dir <- gsub(pattern = \".barcodes.tsv.gz|.genes.tsv.gz|.matrix.mtx.gz\", \n                  replacement = \"\", \n                  x = files) %>%  \n    paste0(\"data/sc_supplementary/GSE184880_RAW/\", .)\n  file.copy(from = paste0(\"data/sc_supplementary/GSE184880_RAW/\", files), \n            to = new_dir)\n  # 重命名3个10X文件\n  new_filename <- ifelse(grepl(pattern = \"barcodes\", x = files), \"barcodes.tsv.gz\", \n                         ifelse(grepl(pattern = \"genes\", x = files), \"features.tsv.gz\", \n                         \"matrix.mtx.gz\"))\n  file.rename(from = paste(new_dir, files, sep  = \"/\"),\n              to = paste(new_dir, new_filename, sep = \"/\"))\n  })\n```\n:::\n\n\n::: {.callout-tip collapse=\"true\"}\n###### 用setwd简化对文件路径的定义\n\n由于在渲染本文档时，knitr会将工作目录恢复为Rproject根目录，所以不能使用getwd指定工作目录。在实际应用中，可以设置工作目录到目标数据文件夹下以简化对文件路径的定义：\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-5_c015b490890eef7bec9871b6accefe00'}\n\n```{.r .cell-code}\nroot_dir <- getwd()\nsetwd(\"data/sc_supplementary/GSE184880_RAW\")\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-6_9984d215989ba9e5935c412354671db2'}\n\n```{.r .cell-code}\n# 给每个样本建立文件夹\nfiles <- list.files()\nfiles\ndirnames <- gsub(pattern = \".barcodes.tsv.gz|.genes.tsv.gz|.matrix.mtx.gz\", \n                 replacement = \"\", \n                 x = files) |> unique()\ndirnames\nlapply(dirnames, dir.create)\n\n\nlapply(files, function(files) {\n  # 复制相应的10X文件到各个样本文件夹内\n  new_dir <- gsub(pattern = \".barcodes.tsv.gz|.genes.tsv.gz|.matrix.mtx.gz\", \n                      replacement = \"\", \n                      x = files) \n  file.copy(from = files, \n            to = new_dir)\n  # 重命名3个10X文件\n  new_filename <- ifelse(grepl(pattern = \"barcodes\", x = files), \"barcodes.tsv.gz\", \n                         ifelse(grepl(pattern = \"genes\", x = files), \"features.tsv.gz\", \n                         \"matrix.mtx.gz\"))\n  file.rename(from = paste(new_dir, files, sep  = \"/\"),\n              to = paste(new_dir, new_filename, sep = \"/\"))\n  })\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-7_37831b1e1c02eabbea2c60c853841bde'}\n\n```{.r .cell-code}\nseurat_list <- lapply(dirnames, function(dirnames) {\n  print(dirnames)\n  sce <- CreateSeuratObject(counts =  Read10X(dirnames),\n                            project =  str_split(string = dirnames, \n                                                 pattern = \"_\", \n                                                 simplify = T)[,2],\n                            min.cells = 5,\n                            min.features = 500)\n  return(sce)\n})\nmerged_seurat <- merge(x = seurat_list[[1]],\n                       y = seurat_list[-1],\n                       add.cell.ids = str_split(string = dirnames, \n                                                pattern = \"_\", \n                                                simplify = T)[,2])\n\nmerged_seurat\nmerged_seurat <- JoinLayers(merged_seurat)\nmerged_seurat\nhead(merged_seurat)\ntail(merged_seurat)\nunique(merged_seurat$orig.ident)\n\n# 将样本信息添加到meta.data的新的一列“sample”中:\nmerged_seurat$sample <- merged_seurat$orig.ident\n```\n:::\n\n\n后续如有需要可以随时将工作目录恢复为Rproject根目录：\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-8_1f82070a950845cff9476979a7bd515f'}\n\n```{.r .cell-code}\nsetwd(root_dir)\n```\n:::\n\n:::\n\n接下来，就可以进行常规的Seurat对象构建：\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-9_2276ec70dba789e7e29f337262db2ed9'}\n\n```{.r .cell-code}\nseurat_list <- lapply(dirnames, function(dirnames) {\n  print(dirnames)\n  sce <- CreateSeuratObject(counts =  Read10X(dirnames),\n                            project =  str_split(string = dirnames, \n                                                 pattern = \"_\", \n                                                 simplify = T)[,4],\n                            min.cells = 5,\n                            min.features = 500)\n  return(sce)\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599220_Norm1\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599221_Norm2\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599222_Norm3\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599223_Norm4\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599224_Norm5\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599225_Cancer1\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599226_Cancer2\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599227_Cancer3\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599228_Cancer4\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599229_Cancer5\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599230_Cancer6\"\n[1] \"data/sc_supplementary/GSE184880_RAW/GSM5599231_Cancer7\"\n```\n:::\n\n```{.r .cell-code}\nmerged_seurat <- merge(x = seurat_list[[1]],\n                       y = seurat_list[-1],\n                       add.cell.ids = str_split(string = dirnames, \n                                                pattern = \"_\", \n                                                simplify = T)[,4])\n\nmerged_seurat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn object of class Seurat \n21454 features across 60886 samples within 1 assay \nActive assay: RNA (21454 features, 0 variable features)\n 12 layers present: counts.Norm1, counts.Norm2, counts.Norm3, counts.Norm4, counts.Norm5, counts.Cancer1, counts.Cancer2, counts.Cancer3, counts.Cancer4, counts.Cancer5, counts.Cancer6, counts.Cancer7\n```\n:::\n\n```{.r .cell-code}\nmerged_seurat <- JoinLayers(merged_seurat)\nmerged_seurat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn object of class Seurat \n21454 features across 60886 samples within 1 assay \nActive assay: RNA (21454 features, 0 variable features)\n 1 layer present: counts\n```\n:::\n\n```{.r .cell-code}\nhead(merged_seurat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                         orig.ident nCount_RNA nFeature_RNA\nNorm1_AAACCCAAGGACAGCT-1      Norm1       8191         2218\nNorm1_AAACCCAAGGTATCTC-1      Norm1       8720         2396\nNorm1_AAACCCACAAGTGCAG-1      Norm1       8554         2518\nNorm1_AAACCCACACCCTCTA-1      Norm1       7650         2697\nNorm1_AAACCCACACTCCGGA-1      Norm1       9231         2370\nNorm1_AAACCCACAGAGGTTG-1      Norm1       5701         1619\nNorm1_AAACCCAGTACTTCCC-1      Norm1      10002         2421\nNorm1_AAACCCATCTACCACC-1      Norm1       2934         1135\nNorm1_AAACGAAAGTAGGCCA-1      Norm1       6955         2198\nNorm1_AAACGAAAGTCACACT-1      Norm1       7742         1891\n```\n:::\n\n```{.r .cell-code}\ntail(merged_seurat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                           orig.ident nCount_RNA nFeature_RNA\nCancer7_TTTGGAGTCGTGAGAG-1    Cancer7       3568         1525\nCancer7_TTTGGTTAGGATCATA-1    Cancer7       3720         1402\nCancer7_TTTGGTTAGTTGGCTT-1    Cancer7       2591         1112\nCancer7_TTTGGTTGTCACCCTT-1    Cancer7      27107         5367\nCancer7_TTTGGTTGTTCCTACC-1    Cancer7      55055         7556\nCancer7_TTTGGTTGTTTCGCTC-1    Cancer7      66262         7369\nCancer7_TTTGGTTTCCACAAGT-1    Cancer7       2342         1143\nCancer7_TTTGTTGCATCCTAAG-1    Cancer7       3498         1440\nCancer7_TTTGTTGGTGACCTGC-1    Cancer7      74316         8182\nCancer7_TTTGTTGGTGATCATC-1    Cancer7       4245          508\n```\n:::\n\n```{.r .cell-code}\nunique(merged_seurat$orig.ident)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"Norm1\"   \"Norm2\"   \"Norm3\"   \"Norm4\"   \"Norm5\"   \"Cancer1\" \"Cancer2\"\n [8] \"Cancer3\" \"Cancer4\" \"Cancer5\" \"Cancer6\" \"Cancer7\"\n```\n:::\n\n```{.r .cell-code}\n# 将样本信息添加到meta.data的新的一列“sample”中:\nmerged_seurat$sample <- merged_seurat$orig.ident\n```\n:::\n\n\n------------------------------------------------------------------------\n\n## 读取raw_counts形式的数据\n\n案例来自[@Bill2023]。样本来自头颈部鳞状细胞癌（HNSCC）患者，总共52例标本，包括24例原发肿瘤、16例局部复发和12例多器官远处转移。原发部位包括口腔、喉/下咽、口咽和鼻咽。其中15份样本HPV阳性。原始数据：[GSE234933](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE234933)。\n\n可以看到该数据集没有提供标准的10X格式的3个文件。\n\n![](images/截屏2024-01-03%2020.56.56.png)\n\n其中的“raw_counts”文件解压后是52个RDS文件，对应了每个样本的单细胞测序数据，是一个已经包含了表达量、基因名和细胞barcode的矩阵，所以可以通过批量读取这些文件建立Seurat对象。\n\n![](images/截屏2024-01-09%2011.10.35.png){width=\"492\"}\n\n“sample_annotation.txt”文件包含了对每个样本的详细临床病理资料的注释，因此可以将其添加到meta.data中。\n\n![](images/截屏2024-01-09%2011.11.45.png)\n\n“cell_annotation.txt”文件则是原作者对细胞类型的注释，可以不添加。\n\n![](images/截屏2024-01-09%2011.12.14.png)\n\n### 读取raw_counts矩阵 {#sec-read_raw_counts}\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-10_4aedaea4c2d8a1fdb858f1c1988faafd'}\n\n```{.r .cell-code}\nrm(list = ls())\nlibrary(Seurat)\nlibrary(stringr)\nlibrary(tibble)\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-11_d786fed8f4578b526d59e9aab408df15'}\n\n```{.r .cell-code}\n# 获取所有rds文件的列表\nfile_list <- list.files(\"data/sc_supplementary/GSE234933/GSE234933_MGH_HNSCC_gex_raw_counts\", pattern = \".rds\")\nfile_list\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"HN1_gex_raw_counts.rds\"       \"HN13_gex_raw_counts.rds\"     \n [3] \"HN14_gex_raw_counts.rds\"      \"HN17_gex_raw_counts.rds\"     \n [5] \"HN2_gex_raw_counts.rds\"       \"HN20_gex_raw_counts.rds\"     \n [7] \"HN21_gex_raw_counts.rds\"      \"HN22_gex_raw_counts.rds\"     \n [9] \"HN23_gex_raw_counts.rds\"      \"HN25_gex_raw_counts.rds\"     \n[11] \"HN26_gex_raw_counts.rds\"      \"HN27_gex_raw_counts.rds\"     \n[13] \"HN28_gex_raw_counts.rds\"      \"HN29_gex_raw_counts.rds\"     \n[15] \"HN30_gex_raw_counts.rds\"      \"HN31TS_gex_raw_counts.rds\"   \n[17] \"HN32T_gex_raw_counts.rds\"     \"HN33_gex_raw_counts.rds\"     \n[19] \"HN34_gex_raw_counts.rds\"      \"HN35_gex_raw_counts.rds\"     \n[21] \"HN37_gex_raw_counts.rds\"      \"HN38_gex_raw_counts.rds\"     \n[23] \"HN39_gex_raw_counts.rds\"      \"HN40-3-05_gex_raw_counts.rds\"\n[25] \"HN42_gex_raw_counts.rds\"      \"HN43_gex_raw_counts.rds\"     \n[27] \"HN45_gex_raw_counts.rds\"      \"HN46_gex_raw_counts.rds\"     \n[29] \"HN49_gex_raw_counts.rds\"      \"HN50_gex_raw_counts.rds\"     \n[31] \"HN52_gex_raw_counts.rds\"      \"HN55_gex_raw_counts.rds\"     \n[33] \"HN57-1_gex_raw_counts.rds\"    \"HN58_gex_raw_counts.rds\"     \n[35] \"HN59_gex_raw_counts.rds\"      \"HN60_gex_raw_counts.rds\"     \n[37] \"HN61_gex_raw_counts.rds\"      \"HN63_gex_raw_counts.rds\"     \n[39] \"HN64_gex_raw_counts.rds\"      \"HN66_gex_raw_counts.rds\"     \n[41] \"HN67_gex_raw_counts.rds\"      \"HN68_gex_raw_counts.rds\"     \n[43] \"HN7_gex_raw_counts.rds\"       \"HN70_gex_raw_counts.rds\"     \n[45] \"HN71_gex_raw_counts.rds\"      \"HN72_gex_raw_counts.rds\"     \n[47] \"HN73_gex_raw_counts.rds\"      \"HN74_gex_raw_counts.rds\"     \n[49] \"HN75_gex_raw_counts.rds\"      \"HN76_gex_raw_counts.rds\"     \n[51] \"HN77_gex_raw_counts.rds\"      \"HN8_gex_raw_counts.rds\"      \n```\n:::\n\n```{.r .cell-code}\n# 循环读取每个rds文件的数据并创建Seurat对象\nseurat_list <- lapply(file_list, function(file) {\n  # 拼接文件路径\n  data.path <- paste0(\"data/sc_supplementary/GSE234933/GSE234933_MGH_HNSCC_gex_raw_counts/\", file)\n  # 创建Seurat对象\n  seurat_obj <- CreateSeuratObject(counts = readRDS(data.path),\n                                   min.features = 200,\n                                   min.cells = 3)\n  return(seurat_obj)\n})\n\n# 合并Seurat对象\nseurat_combined <- merge(seurat_list[[1]],\n                         y = seurat_list[-1],\n                         add.cell.ids = str_split(string = file_list, \n                                                  pattern = \"_\", \n                                                  simplify = T)[,1])\nseurat_combined\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn object of class Seurat \n26734 features across 330385 samples within 1 assay \nActive assay: RNA (26734 features, 0 variable features)\n 52 layers present: counts.1, counts.2, counts.3, counts.4, counts.5, counts.6, counts.7, counts.8, counts.9, counts.10, counts.11, counts.12, counts.13, counts.14, counts.15, counts.16, counts.17, counts.18, counts.19, counts.20, counts.21, counts.22, counts.23, counts.24, counts.25, counts.26, counts.27, counts.28, counts.29, counts.30, counts.31, counts.32, counts.33, counts.34, counts.35, counts.36, counts.37, counts.38, counts.39, counts.40, counts.41, counts.42, counts.43, counts.44, counts.45, counts.46, counts.47, counts.48, counts.49, counts.50, counts.51, counts.52\n```\n:::\n\n```{.r .cell-code}\nhead(seurat_combined) # 可以看到这个案例实际上不需要添加cell.ids\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                           orig.ident nCount_RNA nFeature_RNA\nHN1_HN1_AAACCTGAGTATTGGA-1        HN1        948          574\nHN1_HN1_AAACCTGAGTTGCAGG-1        HN1       6745          257\nHN1_HN1_AAACCTGCAATAGCAA-1        HN1        677          320\nHN1_HN1_AAACCTGCATTTCACT-1        HN1       4540         1129\nHN1_HN1_AAACCTGTCGGCGGTT-1        HN1        909          444\nHN1_HN1_AAACCTGTCTCGTTTA-1        HN1        633          352\nHN1_HN1_AAACGGGAGCAGCCTC-1        HN1       1262          633\nHN1_HN1_AAACGGGAGCCCAGCT-1        HN1        513          275\nHN1_HN1_AAACGGGAGTACGCGA-1        HN1       1152          416\nHN1_HN1_AAACGGGCACATTTCT-1        HN1        426          249\n```\n:::\n\n```{.r .cell-code}\nunique(seurat_combined$orig.ident)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"HN1\"       \"HN13\"      \"HN14\"      \"HN17\"      \"HN2\"       \"HN20\"     \n [7] \"HN21\"      \"HN22\"      \"HN23\"      \"HN25\"      \"HN26\"      \"HN27\"     \n[13] \"HN28\"      \"HN29\"      \"HN30\"      \"HN31TS\"    \"HN32T\"     \"HN33\"     \n[19] \"HN34\"      \"HN35\"      \"HN37\"      \"HN38\"      \"HN39\"      \"HN40-3-05\"\n[25] \"HN42\"      \"HN43\"      \"HN45\"      \"HN46\"      \"HN49\"      \"HN50\"     \n[31] \"HN52\"      \"HN55\"      \"HN57-1\"    \"HN58\"      \"HN59\"      \"HN60\"     \n[37] \"HN61\"      \"HN63\"      \"HN64\"      \"HN66\"      \"HN67\"      \"HN68\"     \n[43] \"HN7\"       \"HN70\"      \"HN71\"      \"HN72\"      \"HN73\"      \"HN74\"     \n[49] \"HN75\"      \"HN76\"      \"HN77\"      \"HN8\"      \n```\n:::\n:::\n\n\n### 添加样本信息\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-12_b2f8b2ea2a01a9021c2c16a1d026e987'}\n\n```{.r .cell-code}\nsample_anno <- read.table(\"data/sc_supplementary/GSE234933/GSE234933_MGH_HNSCC_sample_annotation.txt\", \n                          sep = \"\\t\", \n                          header = T)\nhead(sample_anno)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Sample    Sex Age HPV.Status Smoking.history Original.anatomic.site\n1    HN1   Male  37   Negative             Yes            Oral cavity\n2    HN2   Male  55   Negative             Yes            Oral cavity\n3    HN7   Male  90   Negative              No            Oral cavity\n4    HN8   Male  89   Negative             Yes     Larynx/Hypopharynx\n5   HN13 Female  64   Negative             Yes     Larynx/Hypopharynx\n6   HN14 Female  53   Negative             Yes             Oropharynx\n  Anatomic.location.of.scRNA.seq.specimen\n1                                 Primary\n2               Distant metastasis (Lung)\n3                                 Primary\n4            Distant metastasis (sternum)\n5               Distant metastasis (skin)\n6             Distant metastasis (pleura)\n```\n:::\n\n```{.r .cell-code}\nsample_anno$Sample\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"HN1\"       \"HN2\"       \"HN7\"       \"HN8\"       \"HN13\"      \"HN14\"     \n [7] \"HN17\"      \"HN20\"      \"HN21\"      \"HN22\"      \"HN23\"      \"HN25\"     \n[13] \"HN26\"      \"HN27\"      \"HN28\"      \"HN29\"      \"HN30\"      \"HN31TS\"   \n[19] \"HN32T\"     \"HN33\"      \"HN34\"      \"HN35\"      \"HN37\"      \"HN38\"     \n[25] \"HN39\"      \"HN40-3-05\" \"HN42\"      \"HN43\"      \"HN45\"      \"HN46\"     \n[31] \"HN49\"      \"HN50\"      \"HN52\"      \"HN55\"      \"HN57-1\"    \"HN58\"     \n[37] \"HN59\"      \"HN60\"      \"HN61\"      \"HN63\"      \"HN64\"      \"HN66\"     \n[43] \"HN67\"      \"HN68\"      \"HN70\"      \"HN71\"      \"HN72\"      \"HN73\"     \n[49] \"HN74\"      \"HN75\"      \"HN76\"      \"HN77\"     \n```\n:::\n\n```{.r .cell-code}\nold_meta.data <- rownames_to_column(seurat_combined@meta.data, var = \"cell_id\")\nnew_meta.data <- merge(x = old_meta.data,\n                       y = sample_anno,\n                       by.x = \"orig.ident\",\n                       by.y = \"Sample\",\n                       all.x = T) \nnew_meta.data$sample <- new_meta.data$orig.ident\nhead(new_meta.data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  orig.ident                    cell_id nCount_RNA nFeature_RNA  Sex Age\n1        HN1 HN1_HN1_AAACCTGAGTATTGGA-1        948          574 Male  37\n2        HN1 HN1_HN1_AAACCTGAGTTGCAGG-1       6745          257 Male  37\n3        HN1 HN1_HN1_AAACCTGCAATAGCAA-1        677          320 Male  37\n4        HN1 HN1_HN1_AAACCTGCATTTCACT-1       4540         1129 Male  37\n5        HN1 HN1_HN1_AAACCTGTCGGCGGTT-1        909          444 Male  37\n6        HN1 HN1_HN1_AAACCTGTCTCGTTTA-1        633          352 Male  37\n  HPV.Status Smoking.history Original.anatomic.site\n1   Negative             Yes            Oral cavity\n2   Negative             Yes            Oral cavity\n3   Negative             Yes            Oral cavity\n4   Negative             Yes            Oral cavity\n5   Negative             Yes            Oral cavity\n6   Negative             Yes            Oral cavity\n  Anatomic.location.of.scRNA.seq.specimen sample\n1                                 Primary    HN1\n2                                 Primary    HN1\n3                                 Primary    HN1\n4                                 Primary    HN1\n5                                 Primary    HN1\n6                                 Primary    HN1\n```\n:::\n\n```{.r .cell-code}\nrownames(new_meta.data) <- new_meta.data$cell_id\nnew_meta.data$cell_id <- NULL\nnew_meta.data[,c(4, 6:10)] <- lapply(new_meta.data[,c(4, 5, 7:10)], as.factor)\nsummary(new_meta.data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  orig.ident          nCount_RNA      nFeature_RNA      Sex        \n Length:330385      Min.   :   215   Min.   : 184   Female: 65737  \n Class :character   1st Qu.:   897   1st Qu.: 471   Male  :264648  \n Mode  :character   Median :  1886   Median : 845                  \n                    Mean   :  3439   Mean   :1107                  \n                    3rd Qu.:  3537   3rd Qu.:1348                  \n                    Max.   :126539   Max.   :8839                  \n                                                                   \n      Age          HPV.Status     Smoking.history        Original.anatomic.site\n Min.   :31.00   64     : 29808   No :177238      Larynx/Hypopharynx: 68470    \n 1st Qu.:56.00   76     : 25982   Yes:153147      Nasopharynx       : 30573    \n Median :64.00   70     : 23193                   Oral cavity       :107833    \n Mean   :63.42   44     : 21985                   Oropharynx        :115022    \n 3rd Qu.:71.00   67     : 21053                   Unknown           :  8487    \n Max.   :91.00   55     : 19302                                                \n                 (Other):189062                                                \n                 Anatomic.location.of.scRNA.seq.specimen     sample      \n Primary                             :190573             HN63   : 25501  \n Locoregional recurrence             : 59176             HN76   : 15798  \n Distant metastasis (Lung)           : 34541             HN68   : 14851  \n Distant metastasis (Liver)          : 23083             HN77   : 13892  \n Unknown primary of the head and neck:  8487             HN42   : 12062  \n Distant metastasis (skin)           :  7073             HN74   : 11863  \n (Other)                             :  7452             (Other):236418  \n```\n:::\n\n```{.r .cell-code}\nseurat_combined@meta.data <- new_meta.data\n```\n:::\n\n\n## 读取txt/tsv/csv等文本文件表达量矩阵信息\n\n以2020的文章：《Single-Cell Transcriptome Analysis Reveals Dynamic Cell Populations and Differential Gene Expression Patterns in Control and Aneurysmal Human Aortic Tissue》[@Li2020] 举例说明。数据集链接：[**GSE155468**](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE155468)**。**\n\n![](images/截屏2024-01-10%2011.02.14.png){width=\"565\"}\n\n该案例提供了11个人体主动脉组织样品的单细胞转录组测序数据，其中8名患者为升胸主动脉瘤（ATAA）and 3名患者作为对照。每个样品都是一个独立的txt文本文件，蕴藏着其表达量矩阵信息。\n\n首先我们读取其中一个文件看一下其形式：\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-13_e7d3fb864e3215f20d9c0d4900b1418a'}\n\n```{.r .cell-code}\nrm(list = ls())\nlibrary(data.table)\nlibrary(Seurat)\nlibrary(ggplot2)\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-14_299eedbcad06d5daca3874247374bf99'}\n\n```{.r .cell-code}\n# 列出所有的文件名\nfiles <- list.files(\"data/sc_supplementary/GSE155468_RAW\")\nfiles\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"GSM4704931_Con4.txt.gz\" \"GSM4704932_Con6.txt.gz\" \"GSM4704933_Con9.txt.gz\"\n [4] \"GSM4704934_TAA1.txt.gz\" \"GSM4704935_TAA2.txt.gz\" \"GSM4704936_TAA3.txt.gz\"\n [7] \"GSM4704937_TAA4.txt.gz\" \"GSM4704938_TAA5.txt.gz\" \"GSM4704939_TAA6.txt.gz\"\n[10] \"GSM4704940_TAA7.txt.gz\" \"GSM4704941_TAA8.txt.gz\"\n```\n:::\n\n```{.r .cell-code}\n# 简化文件名用作样本名\nsamples <- gsub(pattern = \"GSM.*._|.txt.gz\", replacement = \"\", x = files)\nsamples\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"Con4\" \"Con6\" \"Con9\" \"TAA1\" \"TAA2\" \"TAA3\" \"TAA4\" \"TAA5\" \"TAA6\" \"TAA7\"\n[11] \"TAA8\"\n```\n:::\n\n```{.r .cell-code}\n# 试读取其中一个文件\ntest <- fread(\"data/sc_supplementary/GSE155468_RAW/GSM4704931_Con4.txt.gz\", data.table = F)\ntest[1:3, 1:3]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          V1 AAACCCAAGCGGACAT.1 AAACCCAAGCGTCAAG.1\n1 AL627309.1                  0                  0\n2 AL669831.5                  0                  0\n3     FAM87B                  0                  0\n```\n:::\n:::\n\n\n可以看到，该表达矩阵的问题是行名不是基因名没有作为行名，而是以单独的一列显示，因此需要进行预处理后再用上面类似的方法批量读取和创建Seurat对象：\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-15_7406ee77160bec6e8cd07f047423b86f'}\n\n```{.r .cell-code}\nseurat_list <- lapply(files, function(file) {\n  filepath <- paste0(\"data/sc_supplementary/GSE155468_RAW/\", file)\n  counts <- fread(filepath, data.table = F)\n  rownames(counts) <- counts[,1]\n  counts <- counts[,-1]\n  CreateSeuratObject(counts = counts,\n                     project = gsub(pattern = \"GSM.*._|.txt.gz\", \n                                    replacement = \"\", \n                                    x = file),\n                     min.cells = 5,\n                     min.features = 300)\n})\n\n\nmerged_seurat <- merge(x = seurat_list[[1]], \n                       y = seurat_list[-1], \n                       add.cell.ids = samples)\nmerged_seurat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn object of class Seurat \n21210 features across 47881 samples within 1 assay \nActive assay: RNA (21210 features, 0 variable features)\n 11 layers present: counts.Con4, counts.Con6, counts.Con9, counts.TAA1, counts.TAA2, counts.TAA3, counts.TAA4, counts.TAA5, counts.TAA6, counts.TAA7, counts.TAA8\n```\n:::\n\n```{.r .cell-code}\nhead(merged_seurat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                        orig.ident nCount_RNA nFeature_RNA\nCon4_AAACCCAAGCGGACAT.1       Con4       5700         2067\nCon4_AAACCCAAGCGTCAAG.1       Con4      12694         2850\nCon4_AAACCCACATTCTCTA.1       Con4      14713         2946\nCon4_AAACCCAGTCGACTTA.1       Con4       3000          546\nCon4_AAACCCATCCATCAGA.1       Con4      15045         4106\nCon4_AAACGAAAGGAACGCT.1       Con4       9877         2793\nCon4_AAACGAAAGGTAGATT.1       Con4       6860         2050\nCon4_AAACGAAAGTCAATCC.1       Con4       5628         1434\nCon4_AAACGAACACGGCACT.1       Con4       9226         2217\nCon4_AAACGAAGTTCAAAGA.1       Con4       6064         1743\n```\n:::\n\n```{.r .cell-code}\n# 新增样本列\nmerged_seurat$samples <- merged_seurat$orig.ident\n```\n:::\n\n\n简单查看一下细胞/基因数：\n\n\n::: {.cell layout-ncol=\"2\" hash='read_sc_data_cache/html/unnamed-chunk-16_a7b81f43cc3ee99dc02927afee9b7931'}\n\n```{.r .cell-code}\n# Visualize the number of cell counts per sample\nmerged_seurat@meta.data  |> \n    ggplot(aes(x = samples, fill = samples)) + \n    geom_bar() +\n    theme_classic() +\n    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +\n    theme(plot.title = element_text(hjust = 0.5, face = \"bold\")) +\n    ggtitle(\"NCells\")\n```\n\n::: {.cell-output-display}\n![](read_sc_data_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Visualize the number UMIs/transcripts per cell\nmerged_seurat@meta.data |> \n    ggplot(aes(color = samples, x = nCount_RNA, fill = samples)) + \n    geom_density(alpha = 0.2) + \n    scale_x_log10() + \n    theme_classic() +\n    ylab(\"Cell density\") +\n    geom_vline(xintercept = 500)\n```\n\n::: {.cell-output-display}\n![](read_sc_data_files/figure-html/unnamed-chunk-16-2.png){width=672}\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n## 读取非标准大体积文本文件单细胞数据 {#sec-reading_non_standard_large_volume_text}\n\n案例数据来自2020年的文章《[*Single-cell transcriptomics reveals regulators underlying immune cell diversity and immune subtypes associated with prognosis in nasopharyngeal carcinoma*](https://www.nature.com/articles/s41422-020-0374-x)》。该研究以15例鼻咽癌患者作为研究对象，1例慢性鼻咽炎患者的正常鼻咽上皮组织作为对照。所有样品均采用10x genomics V2 3'单细胞RNA测序。数据链接：[**GSE150430**](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE150430)**。**\n\n![](images/截屏2024-01-10%2012.07.54.png)\n\n### 加载包\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-17_c478eaef9efdd609703b4ebe54dacaa5'}\n\n```{.r .cell-code}\nrm(list = ls())\nlibrary(data.table)\nlibrary(stringr)\nlibrary(dplyr)\nlibrary(purrr)\nlibrary(Seurat)\n```\n:::\n\n\n### 数据读取\n\n下载数据之后，首先按照通常做法通过`data.table`包的`fread()`函数尝试读取之后，发现无法正确读取列名，即cell barcode：\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-18_89e930c14747255d03bef0c6c034c49d'}\n\n```{.r .cell-code}\ncounts <- fread(\"data/sc_supplementary/GSE150430_npc_scRNA_hg19_processed_data.txt\",\n                data.table = F)\n```\n:::\n\n\n![](images/截屏2024-01-10%2017.28.25.png)\n\n而用`read.table()`函数读取这个文件是可以正确读取列名的:\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-19_b7aeeb91b80f705149c7cb1dbee12dff'}\n\n```{.r .cell-code}\ncounts <- read.table(\"data/sc_supplementary/GSE150430_npc_scRNA_hg19_processed_data.txt\")\n```\n:::\n\n\n读取后的数据如下：\n\n![](images/截屏2024-01-10%2015.53.59.png)\n\n可以发现该表达矩阵行名为基因，列为cell barcode，同时有代表样本的前缀。但是**第一行为作者注释的细胞类型**，因此，可能是由于这样的表头结构导致`fread`不能正确的读取这个数据。但是用基础的`read.table`读取这种大型数据非常耗时间，因此下面**首先用`read.table`读取前两行的数据，即cell barcode和细胞类型；然后通过`fread`读取剩余的表达矩阵；最后将cell barcode和表达矩阵进行合并以构建Seurat对象**。\n\n### 数据整理\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-20_511178f2883f2009e109ac6d4e09c49a'}\n\n```{.r .cell-code}\n# 单独读取表头\nhead <- read.table(\"data/sc_supplementary/GSE150430_npc_scRNA_hg19_processed_data.txt\",\n                   nrows = 1,\n                   header = T)\n```\n:::\n\n\n![](images/截屏2024-01-11%2020.32.16.png)\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-21_8334736786fb10e09159e328dbd1e6c5'}\n\n```{.r .cell-code}\n# 读取表达矩阵\ncounts <- fread(\"data/sc_supplementary/GSE150430_npc_scRNA_hg19_processed_data.txt\",\n                data.table = F, \n                skip = 2) # 跳过前两行\n```\n:::\n\n\n![](images/截屏2024-01-10%2017.43.49.png)\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-22_e86a417ae35b0fd1d2c9e160b2786d9d'}\n\n```{.r .cell-code}\n# 将第一列（基因名）作为行名\nrownames(counts) <- counts[,1]\ncounts <- counts[,-1]\n\n# 添加列名（cell barcode）\ncolnames(counts) <- colnames(head)\n```\n:::\n\n\n![此时，我们就得到了一个满足Seurat对象构建的counts矩阵了。但是，当我们直接用`CreateSeuratObject()`去创建Seurat对象时，由于该数据包含了所有样本的单细胞测序数据，导致其体积过大超出了R的内存上限。因此，接下来，我们**将这个数据根据样本拆分成不同的RDS文件**，然后再用[上面](#sec-read_raw_counts)类似的方法依次读取这些RDS文件，避免一次性读取导致的内存溢出。](images/截屏2024-01-10%2017.45.43.png)\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-23_4f9a30be7580189d38248d5152a9af73'}\n\n```{.r .cell-code}\n# 提取样本标签\nsamples <-  str_split(string = colnames(counts), \n                      pattern = \"_\", \n                      simplify = T)[,1] %>% \n  unique()\nsamples\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-24_dc8914488386038af10611732cc2418e'}\n\n```{.r .cell-code}\n# [1] \"N01\" \"P01\" \"P03\" \"P05\" \"P06\" \"P09\" \"P11\" \"P12\" \"P13\" \"P14\" \"P15\" \"P02\"\n# [13] \"P04\" \"P07\" \"P08\" \"P10\"\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-25_3f36d1f33765a91f6047578ce768a456'}\n\n```{.r .cell-code}\n# 逐一提取不同样本的测序数据，分别导出为RDS文件\nmap(samples, function(sample) {\n  print(sample)\n  sub_exp <- grep(pattern = sample, \n                  x = colnames(counts)) %>% \n    counts[,.]\n  saveRDS(sub_exp, \n          file = paste0(\"output/sc_supplementary/GSE150430/\", sample, \".rds\"))\n})\n```\n:::\n\n\n### 构建Seurat对象\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-26_d743796d5636187abd8451be54cddccc'}\n\n```{.r .cell-code}\nfilenames <- list.files(\"output/sc_supplementary/GSE150430\")\nfilenames\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-27_41f62d5d7dba151fae738a3bbd089e48'}\n\n```{.r .cell-code}\n#  [1] \"N01.rds\" \"P01.rds\" \"P02.rds\" \"P03.rds\" \"P04.rds\" \"P05.rds\" \"P06.rds\"\n#  [8] \"P07.rds\" \"P08.rds\" \"P09.rds\" \"P10.rds\" \"P11.rds\" \"P12.rds\" \"P13.rds\"\n# [15] \"P14.rds\" \"P15.rds\"\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-28_9f6896b26d362af867f761a9e64ce848'}\n\n```{.r .cell-code}\n# 循环读取每个rds文件的数据并创建Seurat对象\nseurat_list <- lapply(filenames, function(file) {\n  # 拼接文件路径\n  data.path <- paste0(\"output/sc_supplementary/GSE150430/\", file)\n  # 创建Seurat对象\n  seurat_obj <- CreateSeuratObject(counts = readRDS(data.path))\n  return(seurat_obj)\n})\n\n# 合并Seurat对象\nmerged_seurat <- merge(seurat_list[[1]],\n                       y = seurat_list[-1])\nmerged_seurat\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-29_f1d00827d04b0987744050237fd065dd'}\n\n```{.r .cell-code}\n# An object of class Seurat \n# 24720 features across 48584 samples within 1 assay \n# Active assay: RNA (24720 features, 0 variable features)\n#  16 layers present: counts.1, counts.2, counts.3, counts.4, counts.5, counts.6, counts.7, counts.8, counts.9, counts.10, counts.11, counts.12, counts.13, counts.14, counts.15, counts.16\n```\n:::\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-30_e535ed63b8adc75131283787f8cd937e'}\n\n```{.r .cell-code}\nhead(merged_seurat) \n```\n:::\n\n\n![](images/截屏2024-01-11%2020.36.33.png){width=\"434\"}\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-31_05f4bb873ef272c0240916b4a0388b43'}\n\n```{.r .cell-code}\n# 添加样本列\nmerged_seurat$samples <- merged_seurat$orig.ident\n\n# 保存\nsaveRDS(merged_seurat, file = \"output/sc_supplementary/GSE150430_merged_seurat.rds\")\n```\n:::\n\n\n------------------------------------------------------------------------\n\n## 读取SMART-seq测序数据\n\n数据链接：[**GSE140228**](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE140228)**。**\n\n![](images/截屏2024-01-18%2014.41.29.png)\n\n这个数据集用了两种测序技术，即Drop-seq和SMART-seq，分别属于测**3′ 或5′ 端（3′或5′-end sequencing）**的技术和测**全长转录本（full-length transcript sequencing）**的技术。这里我们下载SMART-seq测序数据。\n\n读取barcodes、features和matrix数据:\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-32_8c6073da8d13f3422d226c1e4bedb229'}\n\n```{.r .cell-code}\nrm(list = ls())\nlibrary(Seurat)\nlibrary(data.table)\n\nlist.files(\"data/sc_supplementary/GSE140228\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"GSE140228_cell_info_Smartseq2.tsv.gz\"  \n[2] \"GSE140228_gene_info_Smartseq2.tsv.gz\"  \n[3] \"GSE140228_read_counts_Smartseq2.csv\"   \n[4] \"GSE140228_read_counts_Smartseq2.csv.gz\"\n```\n:::\n\n```{.r .cell-code}\nbarcodes <- fread(\n  \"data/sc_supplementary/GSE140228/GSE140228_cell_info_Smartseq2.tsv.gz\",\n  data.table = F # 返回data.frame型数据\n  )\nhead(barcodes, 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          Barcode     Donor Tissue celltype_sub                 Sample\n1 NL-plus-19-0222 D20170222 Normal  NK-C7-CD160 D20170222-Normal-CD45+\n2 NL-plus-20-0222 D20170222 Normal  CD8-C6-GZMK D20170222-Normal-CD45+\n3  NL-plus-2-0222 D20170222 Normal CD8-C8-PDCD1 D20170222-Normal-CD45+\n4 NL-plus-22-0222 D20170222 Normal  CD8-C6-GZMK D20170222-Normal-CD45+\n5 NL-plus-23-0222 D20170222 Normal CD8-C8-PDCD1 D20170222-Normal-CD45+\n  Histology Tissue_sub\n1       HCC     Normal\n2       HCC     Normal\n3       HCC     Normal\n4       HCC     Normal\n5       HCC     Normal\n```\n:::\n\n```{.r .cell-code}\nfeatures <- fread(\n  \"data/sc_supplementary/GSE140228/GSE140228_gene_info_Smartseq2.tsv.gz\",\n  data.table = F\n  )\nhead(features, 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          ENSEMBL    SYMBOL CHR START   END STRAND\n1 ENSG00000223972   DDX11L1   1 11869 14409      +\n2 ENSG00000278267 MIR6859-1   1 17369 17436      -\n3 ENSG00000284332 MIR1302-2   1 30366 30503      +\n4 ENSG00000237613   FAM138A   1 34554 36081      -\n5 ENSG00000268020    OR4G4P   1 52473 53312      +\n                             BIOTYPE\n1 transcribed_unprocessed_pseudogene\n2                              miRNA\n3                              miRNA\n4                            lincRNA\n5             unprocessed_pseudogene\n```\n:::\n\n```{.r .cell-code}\nmatrix <- fread(\n  \"data/sc_supplementary/GSE140228/GSE140228_read_counts_Smartseq2.csv.gz\",\n  data.table = F,\n  )\nmatrix[1:5, 1:5]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       gene NL-plus-19-0222 NL-plus-20-0222 NL-plus-2-0222 NL-plus-22-0222\n1   DDX11L1               0               0              0               0\n2 MIR6859-1               0               0              0               0\n3 MIR1302-2               0               0              0               0\n4   FAM138A               0               0              0               0\n5    OR4G4P               0               0              0               0\n```\n:::\n:::\n\n\n这个`matrix`第一列为基因名，列名为barcodes。`features`和`barcodes`是对每个基因和细胞的补充信息。所以，接下来我们可以直接用这个`matrix`文件构建counts矩阵。后续如有需要可以将`features`和`barcodes`中的信息补充上去。\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-33_873a0ea3817c4ed83364014107c41732'}\n\n```{.r .cell-code}\n# 构建counts矩阵\ncounts <- matrix\nrow.names(counts) <- counts$gene\ncounts$gene <- NULL\n\n# 创建Seurat对象\nmerged_seurat <- CreateSeuratObject(\n  counts = counts,\n  project = \"HCC\",\n  min.cells = 3,\n  min.features = 200\n)\nmerged_seurat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn object of class Seurat \n44417 features across 7074 samples within 1 assay \nActive assay: RNA (44417 features, 0 variable features)\n 1 layer present: counts\n```\n:::\n\n```{.r .cell-code}\nhead(merged_seurat, 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                orig.ident nCount_RNA nFeature_RNA\nNL-plus-19-0222        HCC   685649.3         4313\nNL-plus-20-0222        HCC   932696.0         4746\nNL-plus-2-0222         HCC   692261.5         4567\nNL-plus-22-0222        HCC   765533.3         4790\nNL-plus-23-0222        HCC   574235.8         3549\n```\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n## 单独提供每个细胞测序结果的数据的读取\n\n数据链接：[**GSE84465**](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE84465)**。**\n\n![](images/截屏2024-01-18%2015.47.01.png){width=\"418\"}![](images/截屏2024-01-18%2015.47.10.png){width=\"591\"}\n\n可以看到，该数据集提供每一个细胞的测序结果。对于这样的数据，可以参考[*单细胞数据下载和Seurat对象的构建（上）*](https://mp.weixin.qq.com/s?__biz=Mzg2MTExNTkwNA==&mid=2247510395&idx=1&sn=f2a2c0e3d2d75656f1dcfceaf708beb8&chksm=ce1eea14f969630295e8988209df55b61e2062178d43b22d9eb41a93badf23772a312830ab49&mpshare=1&scene=1&srcid=1117TnC4m9nO1EleC5e8JIOl&sharer_sharetime=1668645592942&sharer_shareid=568f49cb24905bf546294e6985a632bf#rd)中的方法来读取。\n\n------------------------------------------------------------------------\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n## Session Info\n\n\n::: {.cell hash='read_sc_data_cache/html/unnamed-chunk-34_134fa4df9da792e145655b5dcfd69144'}\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Sonoma 14.2.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] ggplot2_3.4.4      data.table_1.14.10 tibble_3.2.1       stringr_1.5.1     \n[5] Seurat_5.0.1       SeuratObject_5.0.1 sp_2.1-2          \n\nloaded via a namespace (and not attached):\n  [1] deldir_2.0-2           pbapply_1.7-2          gridExtra_2.3         \n  [4] rlang_1.1.3            magrittr_2.0.3         RcppAnnoy_0.0.21      \n  [7] spatstat.geom_3.2-7    matrixStats_1.2.0      ggridges_0.5.5        \n [10] compiler_4.3.2         png_0.1-8              vctrs_0.6.5           \n [13] reshape2_1.4.4         pkgconfig_2.0.3        fastmap_1.1.1         \n [16] ellipsis_0.3.2         utf8_1.2.4             promises_1.2.1        \n [19] rmarkdown_2.25         purrr_1.0.2            xfun_0.41             \n [22] jsonlite_1.8.8         goftest_1.2-3          later_1.3.2           \n [25] spatstat.utils_3.0-4   irlba_2.3.5.1          parallel_4.3.2        \n [28] cluster_2.1.6          R6_2.5.1               ica_1.0-3             \n [31] stringi_1.8.3          RColorBrewer_1.1-3     spatstat.data_3.0-4   \n [34] reticulate_1.34.0      parallelly_1.36.0      lmtest_0.9-40         \n [37] scattermore_1.2        Rcpp_1.0.12            knitr_1.45            \n [40] tensor_1.5             future.apply_1.11.1    zoo_1.8-12            \n [43] R.utils_2.12.3         sctransform_0.4.1      httpuv_1.6.13         \n [46] Matrix_1.6-5           splines_4.3.2          igraph_1.6.0          \n [49] tidyselect_1.2.0       abind_1.4-5            rstudioapi_0.15.0     \n [52] yaml_2.3.8             spatstat.random_3.2-2  codetools_0.2-19      \n [55] miniUI_0.1.1.1         spatstat.explore_3.2-5 listenv_0.9.0         \n [58] lattice_0.22-5         plyr_1.8.9             withr_3.0.0           \n [61] shiny_1.8.0            ROCR_1.0-11            evaluate_0.23         \n [64] Rtsne_0.17             future_1.33.1          fastDummies_1.7.3     \n [67] survival_3.5-7         polyclip_1.10-6        fitdistrplus_1.1-11   \n [70] pillar_1.9.0           KernSmooth_2.23-22     plotly_4.10.4         \n [73] generics_0.1.3         RcppHNSW_0.5.0         munsell_0.5.0         \n [76] scales_1.3.0           globals_0.16.2         xtable_1.8-4          \n [79] glue_1.7.0             lazyeval_0.2.2         tools_4.3.2           \n [82] RSpectra_0.16-1        RANN_2.6.1             leiden_0.4.3.1        \n [85] dotCall64_1.1-1        cowplot_1.1.2          grid_4.3.2            \n [88] tidyr_1.3.0            colorspace_2.1-0       nlme_3.1-164          \n [91] patchwork_1.2.0        cli_3.6.2              spatstat.sparse_3.0-3 \n [94] spam_2.10-0            fansi_1.0.6            viridisLite_0.4.2     \n [97] dplyr_1.1.4            uwot_0.1.16            gtable_0.3.4          \n[100] R.methodsS3_1.8.2      digest_0.6.34          progressr_0.14.0      \n[103] ggrepel_0.9.5          htmlwidgets_1.6.4      R.oo_1.25.0           \n[106] htmltools_0.5.7        lifecycle_1.0.4        httr_1.4.7            \n[109] mime_0.12              MASS_7.3-60.0.1       \n```\n:::\n:::\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}