{
  "hash": "cfb06e88264c8555a9b3413cf26e9af9",
  "result": {
    "markdown": "# 基于SCTransform的单细胞数据标准化 {#sec-sctransform}\n\n> 原文：[*Using sctransform in Seurat*](https://satijalab.org/seurat/articles/sctransform_vignette)\n>\n> 原文发布日期：2023年10月31日\n\n**Biological heterogeneity** in single-cell RNA-seq data is often confounded by technical factors including **sequencing depth**. The **number of molecules detected in each cell** can vary significantly between cells, even within the same celltype. Interpretation of scRNA-seq data requires effective pre-processing and normalization to remove this **technical variability**.\n\nIn our manuscript we introduce a modeling framework for the normalization and variance stabilization of molecular count data from scRNA-seq experiments. This procedure **omits the need for heuristic steps** including pseudocount addition or log-transformation and **improves common downstream analytical tasks** such as variable gene selection, dimensional reduction, and differential expression. We named this method`sctransform`.\n\nInspired by important and rigorous work from Lause et al [@lause2021], we released an updated manuscript [@choudhary2022b] and updated the sctransform software to a v2 version, which is now the default in Seurat v5.\n\n## 载入数据\n\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-1_37c8a60e882b0d29a93bc8fe5f22fc16'}\n\n```{.r .cell-code}\nlibrary(Seurat)\npbmc_data <- Read10X(data.dir = \"data/seurat_official/filtered_gene_bc_matrices/hg19\")\npbmc <- CreateSeuratObject(counts = pbmc_data)\npbmc\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn object of class Seurat \n32738 features across 2700 samples within 1 assay \nActive assay: RNA (32738 features, 0 variable features)\n 1 layer present: counts\n```\n:::\n:::\n\n\n## 质控\n\n这里的质控步骤只简单的计算了线粒体基因的比例。\n\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-2_afd524c523c8ee80970c4148cd69cc24'}\n\n```{.r .cell-code}\npbmc <- PercentageFeatureSet(pbmc, pattern = \"^MT-\", col.name = \"percent.mt\")\nhead(pbmc@meta.data, 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                    orig.ident nCount_RNA nFeature_RNA percent.mt\nAAACATACAACCAC-1 SeuratProject       2421          781  3.0152829\nAAACATTGAGCTAC-1 SeuratProject       4903         1352  3.7935958\nAAACATTGATCAGC-1 SeuratProject       3149         1131  0.8891712\nAAACCGTGCTTCCG-1 SeuratProject       2639          960  1.7430845\nAAACCGTGTATGCG-1 SeuratProject        981          522  1.2232416\n```\n:::\n:::\n\n\n## 运行`SCTransform` {#sec-perform_sctransform}\n\n-   `SCTransform()`替代了传统单细胞数据分析流程中的`NormalizeData()`、`ScaleData()`和`FindVariableFeatures()`函数的功能，因此不再需要运行这些函数。\n\n-   During normalization, we can also remove confounding sources of variation, for example, mitochondrial mapping percentage。`SCTransform`也可以移除一些非期望变异来源，如线粒体基因的比例。这在传统的单细胞数据分析流程中由`ScaleData`来完成（ @sec-scaledata ）。\n\n-   In Seurat v5, SCT v2 is applied by default. You can revert to v1 by setting `vst.flavor = 'v1'`\n\n-   `SCTransform`的运算调用了[`glmGamPoi`](https://bioconductor.org/packages/release/bioc/html/glmGamPoi.html)包以显著提升运算速度。所以事先需要通过BiocManager安装该包。\n\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-3_ab8b047178f648d52cca340aeb29517a'}\n\n```{.r .cell-code}\n# BiocManager::install(\"glmGamPoi\")\npbmc <- SCTransform(pbmc, \n                    vars.to.regress = \"percent.mt\", \n                    verbose = FALSE)\n```\n:::\n\n\nTransformed data will be available in the `SCT assay`, which is set as the default after running `SCTransform`：\n\n![](images/截屏2023-11-23%2019.32.28.png)\n\n-   `pbmc[[\"SCT\"]]$scale.data` contains the residuals (normalized values), and is **used directly as input to PCA**. Please note that **this matrix is non-sparse**, and can therefore take up a lot of memory if stored for all genes. **To save memory, we store these values only for variable genes**, by setting the `return.only.var.genes = TRUE` by default in the `SCTransform()` function call.\n\n-   To assist with visualization and interpretation, we also convert Pearson residuals back to 'corrected' UMI counts. You can interpret these as the UMI counts we would expect to observe if all cells were sequenced to the same depth. If you want to see exactly how we do this, please look at the correct function [here](https://github.com/ChristophH/sctransform/blob/master/R/denoise.R).\n\n-   The 'corrected' UMI counts are stored in `pbmc[[\"SCT\"]]$counts`. We store log-normalized versions of these corrected counts in `pbmc[[\"SCT\"]]$data`, which are very helpful for visualization.\n\n## 降维\n\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-4_b08a762be38fb58050ce76f8e8646016'}\n\n```{.r .cell-code}\npbmc <- RunPCA(pbmc, verbose = FALSE)\npbmc <- RunUMAP(pbmc, dims = 1:30, verbose = FALSE)\n```\n:::\n\n\n降维可视化：\n\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-5_714378158cd084bac1bcbfff0e24657e'}\n\n```{.r .cell-code}\nVizDimLoadings(pbmc, dims = 1:2, reduction = \"pca\")\n```\n\n::: {.cell-output-display}\n![](sctransform_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\nDimPlot(pbmc, reduction = \"umap\")\n```\n\n::: {.cell-output-display}\n![](sctransform_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n\n```{.r .cell-code}\nDimHeatmap(pbmc, dims = 1:15, cells = 1000, balanced = TRUE)\n```\n\n::: {.cell-output-display}\n![](sctransform_files/figure-html/unnamed-chunk-5-3.png){width=672}\n:::\n\n```{.r .cell-code}\nElbowPlot(pbmc)\n```\n\n::: {.cell-output-display}\n![](sctransform_files/figure-html/unnamed-chunk-5-4.png){width=672}\n:::\n:::\n\n\n## 聚类 {#sec-clustering}\n\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-6_0865837d7f5ccd1edd9b065a37906480'}\n\n```{.r .cell-code}\npbmc <- FindNeighbors(pbmc, dims = 1:30, verbose = FALSE)\npbmc <- FindClusters(pbmc, verbose = FALSE)\nDimPlot(pbmc, label = TRUE)\n```\n\n::: {.cell-output-display}\n![](sctransform_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n根据Seurat细胞分群官方教程（ @sec-Determine_pcs_for_subsequent_analyses ），这个数据集\"we can observe an 'elbow' around PC9-10, suggesting that the majority of true signal is captured in the first 10 PCs\"。因此在`FindNeighbors`函数中指定了`dims = 1:10`。但是这里的`FindNeighbors`函数指定了更多的主成分（`dims = 1:30`）。下面的内容对此作出了解释：\n\n::: {.callout-tip collapse=\"true\"}\n## Why can we choose more PCs when using sctransform?\n\nIn the @sec-seurat_cell_clustering_official_tutorial ，we focus on **10 PCs** for this dataset, though we highlight that **the results are similar with higher settings for this parameter**. Interestingly, we've found that when using `SCTransform`, we often **benefit by pushing this parameter even higher**. We believe this is because the `SCTransform` workflow performs more effective normalization, strongly removing technical effects from the data.\n\nEven after standard log-normalization, variation in sequencing depth is still a confounding factor (see [Figure 1](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-019-1874-1)), and this effect can subtly influence higher PCs. In `SCTransform`, this effect is substantially mitigated (see [Figure 3](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-019-1874-1)). This means that **higher PCs are more likely to represent subtle, but biologically relevant, sources of heterogeneity** -- so including them may improve downstream analysis.\n\nIn addition, `SCTransform` **returns 3,000 variable features by default, instead of 2,000**. The rationale is similar, the additional variable features are less likely to be driven by technical differences across cells, and instead may represent more subtle biological fluctuations. In general, we find that results produced with `SCTransform` are less dependent on these parameters (indeed, we achieve nearly identical results when using all genes in the transcriptome, though this does reduce computational efficiency). This can help users generate more robust results, and in addition, enables the application of standard analysis pipelines with identical parameter settings that can quickly be applied to new datasets.\n:::\n\n## Marker基因可视化\n\nUsers can individually annotate clusters based on canonical markers. However, the `SCTransform` normalization reveals **sharper biological distinctions** compared to the standard Seurat workflow（ @sec-seurat_cell_clustering_official_tutorial ）, in a few ways:\n\n-   Clear separation of at least **3 CD8 T cell populations (naive, memory, effector)**, based on **CD8A, GZMK, CCL5, CCR7** expression\n\n-   Clear separation of **three CD4 T cell populations (naive, memory, IFN-activated)** based on **S100A4, CCR7, IL32,** and **ISG15**\n\n-   Additional developmental sub-structure in B cell cluster, based on TCL1A, FCER2\n\n-   Additional separation of NK cells into CD56dim vs. bright clusters, based on XCL1 and FCGR3A\n\n### 小提琴图：\n\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-7_bac6656440220fc341c661d4352605a5'}\n\n```{.r .cell-code}\nVlnPlot(pbmc, \n        features = c(\"CD8A\", \"GZMK\", \"CCL5\", \"S100A4\", \"ANXA1\", \"CCR7\", \"ISG15\", \"CD3D\"),\n    pt.size = 0.2, \n    ncol = 4)\n```\n\n::: {.cell-output-display}\n![](sctransform_files/figure-html/unnamed-chunk-7-1.png){width=960}\n:::\n:::\n\n\n### UMAP图：\n\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-8_ef5618c4a623b22d95eb89b729ca99dd'}\n\n```{.r .cell-code}\nFeaturePlot(pbmc, \n            features = c(\"CD8A\", \"GZMK\", \"CCL5\", \"S100A4\", \"ANXA1\", \"CCR7\"), \n            pt.size = 0.2,\n            ncol = 3)\n```\n\n::: {.cell-output-display}\n![](sctransform_files/figure-html/unnamed-chunk-8-1.png){width=960}\n:::\n:::\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-9_532a2686556800611ff614825185fd13'}\n\n```{.r .cell-code}\nFeaturePlot(pbmc, \n            features = c(\"CD3D\", \"ISG15\", \"TCL1A\", \"FCER2\", \"XCL1\", \"FCGR3A\"), \n            pt.size = 0.2,\n            ncol = 3)\n```\n\n::: {.cell-output-display}\n![](sctransform_files/figure-html/unnamed-chunk-9-1.png){width=960}\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n## Session Info\n\n\n::: {.cell hash='sctransform_cache/html/unnamed-chunk-10_e8b172ddd5ef5096e2642e36581913a2'}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Sonoma 14.2.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] Seurat_5.0.1       SeuratObject_5.0.1 sp_2.1-2          \n\nloaded via a namespace (and not attached):\n  [1] RColorBrewer_1.1-3          rstudioapi_0.15.0          \n  [3] jsonlite_1.8.8              magrittr_2.0.3             \n  [5] ggbeeswarm_0.7.2            spatstat.utils_3.0-4       \n  [7] farver_2.1.1                rmarkdown_2.25             \n  [9] zlibbioc_1.48.0             vctrs_0.6.5                \n [11] ROCR_1.0-11                 DelayedMatrixStats_1.24.0  \n [13] spatstat.explore_3.2-5      RCurl_1.98-1.14            \n [15] S4Arrays_1.2.0              htmltools_0.5.7            \n [17] SparseArray_1.2.3           sctransform_0.4.1          \n [19] parallelly_1.36.0           KernSmooth_2.23-22         \n [21] htmlwidgets_1.6.4           ica_1.0-3                  \n [23] plyr_1.8.9                  plotly_4.10.4              \n [25] zoo_1.8-12                  igraph_1.6.0               \n [27] mime_0.12                   lifecycle_1.0.4            \n [29] pkgconfig_2.0.3             Matrix_1.6-5               \n [31] R6_2.5.1                    fastmap_1.1.1              \n [33] GenomeInfoDbData_1.2.11     MatrixGenerics_1.14.0      \n [35] fitdistrplus_1.1-11         future_1.33.1              \n [37] shiny_1.8.0                 digest_0.6.34              \n [39] colorspace_2.1-0            patchwork_1.2.0            \n [41] S4Vectors_0.40.2            tensor_1.5                 \n [43] RSpectra_0.16-1             irlba_2.3.5.1              \n [45] GenomicRanges_1.54.1        labeling_0.4.3             \n [47] progressr_0.14.0            fansi_1.0.6                \n [49] spatstat.sparse_3.0-3       httr_1.4.7                 \n [51] polyclip_1.10-6             abind_1.4-5                \n [53] compiler_4.3.2              withr_3.0.0                \n [55] fastDummies_1.7.3           R.utils_2.12.3             \n [57] MASS_7.3-60.0.1             DelayedArray_0.28.0        \n [59] tools_4.3.2                 vipor_0.4.7                \n [61] lmtest_0.9-40               beeswarm_0.4.0             \n [63] httpuv_1.6.13               future.apply_1.11.1        \n [65] goftest_1.2-3               R.oo_1.25.0                \n [67] glmGamPoi_1.14.0            glue_1.7.0                 \n [69] nlme_3.1-164                promises_1.2.1             \n [71] grid_4.3.2                  Rtsne_0.17                 \n [73] cluster_2.1.6               reshape2_1.4.4             \n [75] generics_0.1.3              gtable_0.3.4               \n [77] spatstat.data_3.0-4         R.methodsS3_1.8.2          \n [79] tidyr_1.3.0                 data.table_1.14.10         \n [81] XVector_0.42.0              utf8_1.2.4                 \n [83] BiocGenerics_0.48.1         spatstat.geom_3.2-7        \n [85] RcppAnnoy_0.0.21            ggrepel_0.9.5              \n [87] RANN_2.6.1                  pillar_1.9.0               \n [89] stringr_1.5.1               spam_2.10-0                \n [91] RcppHNSW_0.5.0              later_1.3.2                \n [93] splines_4.3.2               dplyr_1.1.4                \n [95] lattice_0.22-5              survival_3.5-7             \n [97] deldir_2.0-2                tidyselect_1.2.0           \n [99] miniUI_0.1.1.1              pbapply_1.7-2              \n[101] knitr_1.45                  gridExtra_2.3              \n[103] IRanges_2.36.0              SummarizedExperiment_1.32.0\n[105] scattermore_1.2             stats4_4.3.2               \n[107] xfun_0.41                   Biobase_2.62.0             \n[109] matrixStats_1.2.0           stringi_1.8.3              \n[111] lazyeval_0.2.2              yaml_2.3.8                 \n[113] evaluate_0.23               codetools_0.2-19           \n[115] tibble_3.2.1                cli_3.6.2                  \n[117] uwot_0.1.16                 xtable_1.8-4               \n[119] reticulate_1.34.0           munsell_0.5.0              \n[121] Rcpp_1.0.12                 GenomeInfoDb_1.38.5        \n[123] globals_0.16.2              spatstat.random_3.2-2      \n[125] png_0.1-8                   ggrastr_1.0.2              \n[127] parallel_4.3.2              ellipsis_0.3.2             \n[129] ggplot2_3.4.4               dotCall64_1.1-1            \n[131] sparseMatrixStats_1.14.0    bitops_1.0-7               \n[133] listenv_0.9.0               viridisLite_0.4.2          \n[135] scales_1.3.0                ggridges_0.5.5             \n[137] crayon_1.5.2                leiden_0.4.3.1             \n[139] purrr_1.0.2                 rlang_1.1.3                \n[141] cowplot_1.1.2              \n```\n:::\n:::\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}