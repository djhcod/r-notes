{
  "hash": "6bbf3cef5ba1730e96d882f681e61bc0",
  "result": {
    "markdown": "---\ntitle: \"细胞分群质量评估\"\n---\n\n\n::: callout-note\n###### Learning Objectives:\n\n-   Evaluate whether clustering artifacts are present\n-   Determine the quality of clustering with PCA and UMAP plots, and decide when to re-cluster\n-   Assess known cell type markers to hypothesize cell type identities of clusters\n:::\n\n![](images/sc_workflow_2022-01.jpg){width=\"545\"}\n\nAfter separating cells into clusters, it is crtical to evaluate whether they are **biologically meaningful** or not. At this point we can also decide **if we need to re-cluster and/or potentialy go back to a previous QC step**.\\\nIn this lesson you will:\n\n-   Check to see that clusters are not influenced by uninteresting sources of variation\n\n-   Check to see whether the major principal components are driving the different clusters\n\n-   Explore the cell type identities by looking at the expression for known markers across the clusters.\n\n# Exploration of quality control metrics\n\nTo determine whether our clusters might be due to artifacts such as cell cycle phase or mitochondrial expression, it can be useful to explore these metrics visually to see if any clusters exhibit enrichment or are different from the other clusters. However, if enrichment or differences are observed for particular clusters it may not be worrisome if it can be explained by the cell type.\n\nTo explore and visualize the various quality metrics, we will use the versatile `DimPlot()` and `FeaturePlot()` functions from Seurat.\n\n# 数据读取\n\n载入上一节中完成细胞分群的数据`seurat_clustered`。\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-1_a3bc674dcb365fc97e00a63f11c3498b'}\n\n```{.r .cell-code}\nlibrary(Seurat)\nseurat_clustered <- readRDS(\"output/scRNA-seq_online/seurat_clustered.rds\")\nseurat_clustered\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn object of class Seurat \n31130 features across 29629 samples within 3 assays \nActive assay: integrated (3000 features, 3000 variable features)\n 2 layers present: data, scale.data\n 2 other assays present: RNA, SCT\n 2 dimensional reductions calculated: pca, umap\n```\n:::\n\n```{.r .cell-code}\nhead(seurat_clustered, 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                      orig.ident nCount_RNA nFeature_RNA\nctrl_AAACATACAATGCC-1       ctrl       2344          874\nctrl_AAACATACATTTCC-1       ctrl       3124          895\nctrl_AAACATACCAGAAA-1       ctrl       2578          725\nctrl_AAACATACCAGCTA-1       ctrl       3260          978\nctrl_AAACATACCATGCA-1       ctrl        746          362\n                                      seq_folder nUMI nGene log10GenesPerUMI\nctrl_AAACATACAATGCC-1 ctrl_raw_feature_bc_matrix 2344   874        0.8728630\nctrl_AAACATACATTTCC-1 ctrl_raw_feature_bc_matrix 3125   896        0.8447596\nctrl_AAACATACCAGAAA-1 ctrl_raw_feature_bc_matrix 2578   725        0.8384933\nctrl_AAACATACCAGCTA-1 ctrl_raw_feature_bc_matrix 3261   979        0.8512622\nctrl_AAACATACCATGCA-1 ctrl_raw_feature_bc_matrix  746   362        0.8906861\n                       mitoRatio                 cells sample     S.Score\nctrl_AAACATACAATGCC-1 0.01962457 ctrl_AAACATACAATGCC-1   ctrl  0.04330502\nctrl_AAACATACATTTCC-1 0.01792000 ctrl_AAACATACATTTCC-1   ctrl  0.02661900\nctrl_AAACATACCAGAAA-1 0.01551590 ctrl_AAACATACCAGAAA-1   ctrl -0.04670650\nctrl_AAACATACCAGCTA-1 0.01379945 ctrl_AAACATACCAGCTA-1   ctrl -0.05832833\nctrl_AAACATACCATGCA-1 0.02144772 ctrl_AAACATACCATGCA-1   ctrl  0.03929605\n                        G2M.Score Phase      mitoFr nCount_SCT nFeature_SCT\nctrl_AAACATACAATGCC-1  0.05422631   G2M      Medium       1572          829\nctrl_AAACATACATTTCC-1  0.05159679   G2M      Medium       1572          718\nctrl_AAACATACCAGAAA-1 -0.04841661    G1      Medium       1553          648\nctrl_AAACATACCAGCTA-1  0.05045960   G2M         Low       1576          756\nctrl_AAACATACCATGCA-1 -0.02995512     S Medium high       1075          363\n                      integrated_snn_res.0.4 integrated_snn_res.0.6\nctrl_AAACATACAATGCC-1                      2                      1\nctrl_AAACATACATTTCC-1                      0                      2\nctrl_AAACATACCAGAAA-1                      0                      3\nctrl_AAACATACCAGCTA-1                      0                      3\nctrl_AAACATACCATGCA-1                      5                      6\n                      integrated_snn_res.0.8 integrated_snn_res.1\nctrl_AAACATACAATGCC-1                      2                    2\nctrl_AAACATACATTTCC-1                      1                    0\nctrl_AAACATACCAGAAA-1                      3                   15\nctrl_AAACATACCAGCTA-1                      3                    3\nctrl_AAACATACCATGCA-1                      4                   12\n                      integrated_snn_res.1.4 seurat_clusters\nctrl_AAACATACAATGCC-1                      5               5\nctrl_AAACATACATTTCC-1                      0               0\nctrl_AAACATACCAGAAA-1                     19              19\nctrl_AAACATACCAGCTA-1                      3               3\nctrl_AAACATACCATGCA-1                     13              13\n```\n:::\n:::\n\n\n# 分析样本类型是否影响细胞分群\n\n首先通过UMAP图，直观查看不同样本类型的细胞分群情况：\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-2_62da6534101324fb1123d6d94c40296b'}\n\n```{.r .cell-code}\n# 先简单查看一下分群情况及不同cluster的细胞数\ntable(seurat_clustered@active.ident)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n   0    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15 \n4220 3718 3649 3004 2164 1959 1810 1646 1504 1375 1208 1174  858  468  459  289 \n  16 \n 124 \n```\n:::\n\n```{.r .cell-code}\n# UMAP of cells in each cluster by sample\nDimPlot(seurat_clustered, \n        label = TRUE, \n        split.by = \"sample\") + \n  NoLegend()\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n> 从UMAP图上可以直观的发现不同样本（ctrl vs. stim）的细胞分群非常一致，这是符合预期的。\n\n接下来通过提取不同样本类型中各cluster的细胞数来以数据的形式验证这种一致性。下面是实现方法：\n\n1.  通过`Seurat`包的`FetchData()`函数可以从Seurat对象中提取指定的变量并形成行为细胞列为变量的数据框。这里通过关键词“ident”提取“active.ident”（即每个细胞所在的cluster的编号）；并提取\"orig.ident\"变量，即每个细胞对应的样本类型（ctrl vs. stim）（也可以提取“sample”）\n\n    ![](images/截屏2023-12-20%2010.10.43.png){width=\"313\"}\n\n2.  然后通过`dplyr`包的`count()`函数统计每个样本类型内每个cluster的细胞数量\n\n    ![](images/截屏2023-12-20%2010.10.22.png){width=\"278\"}\n\n3.  最后，通过`tidyr`包的`pivot_wider()`函数将长数据转换成宽数据。其中的`names_from`参数用于指定原数据中要拆分的那一列的名字（会在转换后的数据中变成列名）；`values_from`参数用于指定新数据集中单元格的值由旧数据的哪个（或哪些）变量的值填充\n\n    ![](images/截屏2023-12-20%2010.43.50.png)\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-3_9ad0699e6309e6a3e990ed72f9398522'}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(tidyr)\nn_cells <- FetchData(seurat_clustered, \n                     vars = c(\"ident\", \"orig.ident\")) |>\n        count(ident, orig.ident) |>\n        pivot_wider(names_from = ident,\n                    values_from = n)\nn_cells\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 18\n  orig.ident   `0`   `1`   `2`   `3`   `4`   `5`   `6`   `7`   `8`   `9`  `10`\n  <chr>      <int> <int> <int> <int> <int> <int> <int> <int> <int> <int> <int>\n1 ctrl        2017  2398  1840  1076  1112   976   952   830   775   661   600\n2 stim        2203  1320  1809  1928  1052   983   858   816   729   714   608\n# ℹ 6 more variables: `11` <int>, `12` <int>, `13` <int>, `14` <int>,\n#   `15` <int>, `16` <int>\n```\n:::\n:::\n\n\n> 从该表中可以看出，不同样本类型下的各细胞群的细胞数量基本一致。These clusters look pretty similar between conditions, which is good since we expected similar cell types to be present in both control and stimulated conditions.\n\n::: callout-caution\nGenerally, we expect to see the majority of the cell type clusters to be present in all conditions; however, depending on the experiment we might expect to see some **condition-specific cell types** present.\n:::\n\n# 分析细胞周期是否影响细胞分群\n\nNext, we can explore whether the **cells cluster influenced by the different cell cycle phases**. We did not regress out variation due to cell cycle phase when we performed the `SCTransform` normalization (见[Normalization and regressing out unwanted variation](/single_cell/scRNA-seq_online/06_SC_SCT_normalization.qmd#sec-evaluating_effects_of_cell_cycle)). **If our cell clusters showed large differences in cell cycle expression, this would be an indication we would want to re-run the `SCTransform` and add the `S.Score` and `G2M.Score` to our variables to regress, then re-run the rest of the steps.**\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-4_3d96f320f2c062904b4bb855bc89f13e'}\n\n```{.r .cell-code}\n# Explore whether clusters segregate by cell cycle phase\nDimPlot(seurat_clustered,\n        label = TRUE, \n        split.by = \"Phase\") + \n  NoLegend()\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-4-1.png){width=960}\n:::\n:::\n\n\n> We do not see much clustering by cell cycle score, so we can proceed with the QC.\n\n# 分析其他非期望变异来源是否会影响细胞分群\n\nNext we will explore additional metrics, such as the **number of UMIs** and **genes per cell**, **S-phase and G2M-phase markers**, and **mitochondrial gene expression** by UMAP. Looking at the individual S and G2M scores can give us additional information to checking the phase as we did previously.\n\n::: callout-tip\nThe `order` argument will plot the positive cells above the negative cells, while the `min.cutoff` argument will determine the threshold for shading. A `min.cutoff` of `q10` translates to the 10% of cells with the lowest expression of the gene will not exhibit any purple shading (completely gray) (`min.cutoff`定义着色阈值。这里指定值最低的10%的细胞不着色).\n:::\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-5_e91bcd2986efe8bd595a27d5a1748f95'}\n\n```{.r .cell-code}\n# Determine metrics to plot present in seurat_clustered@meta.data\nmetrics <-  c(\"nUMI\", \"nGene\", \"S.Score\", \"G2M.Score\", \"mitoRatio\")\n\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = metrics,\n            pt.size = 0.4, \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-5-1.png){width=960}\n:::\n:::\n\n\n> The metrics seem to be relatively even across the clusters, with the exception of `nGene` exhibiting slightly higher values in clusters to the left of the plot. We can keep an eye on these clusters to see whether the cell types may explain the increase.\n>\n> If we see differences corresponding to any of these metrics at this point in time, then we will often note them and then decide after identifying the cell type identities whether to take any further action.\n\n# 分析主成分（PCs）对细胞分群的影响 {#sec-Effect_of_pcs_clustering}\n\nWe can also explore how well our clusters separate by the different PCs; **we hope that the defined PCs separate the cell types well**. To visualize this information, we need to extract the UMAP coordinate information for the cells along with their corresponding scores for each of the PCs to view by UMAP.\n\nFirst, we identify the information we would like to extract from the Seurat object, then, we can use the `FetchData()` function to extract it.\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-6_21a0d75ddbd682053d02d8630f1da712'}\n\n```{.r .cell-code}\n# Defining the information in the seurat object of interest\ncolumns <- c(\"ident\", paste0(\"PC_\", 1:16), \"UMAP_1\", \"UMAP_2\")\n\n# Extracting this data from the seurat object\npc_data <- FetchData(seurat_clustered, \n                     vars = columns)\nhead(pc_data, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                      ident      PC_1      PC_2      PC_3      PC_4       PC_5\nctrl_AAACATACAATGCC-1     2 -14.97782 -2.879193 -5.059351 -1.602766  0.8728779\nctrl_AAACATACATTTCC-1     1  22.39233 -5.296913  4.951958  3.112632  0.3379874\nctrl_AAACATACCAGAAA-1     3  28.98473  1.203408 -5.947993 -1.042701 -7.5690434\n                           PC_6        PC_7       PC_8       PC_9     PC_10\nctrl_AAACATACAATGCC-1 -1.501420   0.5327841 -0.5855545  0.8866479 0.8223524\nctrl_AAACATACATTTCC-1 -7.873002   2.2740054 -5.8362430 -0.9666741 0.2170141\nctrl_AAACATACCAGAAA-1  5.477813 -10.7953185 19.5052392 -1.8312647 2.1803084\n                          PC_11      PC_12      PC_13       PC_14     PC_15\nctrl_AAACATACAATGCC-1 -1.722880 -0.1832132  0.2985759 -0.04539058  1.260942\nctrl_AAACATACATTTCC-1  3.105132 -0.7964707  2.8982516  0.04362601 -3.189937\nctrl_AAACATACCAGAAA-1 -7.796582 -1.3324607 -2.3117140  3.06677862  1.663382\n                           PC_16     UMAP_1    UMAP_2\nctrl_AAACATACAATGCC-1  0.1993319   7.270473 0.9072988\nctrl_AAACATACATTTCC-1  5.3805322  -8.742020 1.5622634\nctrl_AAACATACCAGAAA-1 -3.0593032 -10.032904 4.7139827\n```\n:::\n:::\n\n\n::: callout-tip\nHow did we know in the `FetchData()` function to include `UMAP_1` to obtain the UMAP coordinates? [Seurat常用函数清单](/single_cell/seurat/seurat_command_list.qmd) describes the function as being able to pull any data from the expression matrices, cell embeddings, or metadata.\n\nFor instance, if you explore the `seurat_clustered@reductions` list object, the first component is for PCA, and includes a slot for `cell.embeddings` (坐标数据). We can use the column names (`PC_1`, `PC_2`, `PC_3`, etc.) to pull out the coordinates or PC scores corresponding to each cell for each of the PCs (提取每个细胞在指定主成分上的坐标).\n\nWe could do the same thing for UMAP:\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-7_e18727bd660ed2c1dd9d4c25a9c28820'}\n\n```{.r .cell-code}\n# 提取前5个细胞在前两个UMAP主成分上的坐标\nseurat_clustered@reductions[[\"umap\"]]@cell.embeddings[1:5, 1:2]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                          UMAP_1     UMAP_2\nctrl_AAACATACAATGCC-1   7.270473  0.9072988\nctrl_AAACATACATTTCC-1  -8.742020  1.5622634\nctrl_AAACATACCAGAAA-1 -10.032904  4.7139827\nctrl_AAACATACCAGCTA-1  -8.363044  5.0377137\nctrl_AAACATACCATGCA-1   6.875784 -4.6442526\n```\n:::\n:::\n\n\n等价于：\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-8_536b245aa02e81a3014b5bff8992450b'}\n\n```{.r .cell-code}\nFetchData(seurat_clustered, vars = c(\"UMAP_1\", \"UMAP_2\")) |> head(5)\n```\n:::\n\n\nThe `FetchData()` function just allows us to extract the data more easily.\n:::\n\n::: callout-caution\nThe pre-existing `seurat_clustered` loaded in previously was created using an older version of Seurat. As such the columns we `Fetch()` are in upper case (i.e `UMAP_1`). **If you are using your own seurat object using a newer version of Seurat you will need to change the column names as shown below.** Alternatively, explore your Seurat object to see how they have been stored.\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-9_d3000e458ca21f8e23b3f3a9e089d654'}\n\n```{.r .cell-code}\n # Defining the information in the seurat object of interest\n columns <- c(\"ident\", paste0(\"PC_\", 1:16), \"umap_1\", \"umap_2\")\n```\n:::\n\n:::\n\nIn the UMAP plots below, the cells are colored by their PC score for each respective principal component.\n\nLet's take a quick look at the top 16 PCs:\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-10_78692eb6ace70cee45b28e308ca9a959'}\n\n```{.r .cell-code}\n# Adding cluster label to center of cluster on UMAP\numap_label <- FetchData(seurat_clustered, \n                        vars = c(\"ident\", \"UMAP_1\", \"UMAP_2\")) |>\n  group_by(ident) |> # 指定分组计算依据\n  summarise(UMAP1_mean = mean(UMAP_1), UMAP2_mean = mean(UMAP_2)) # 根据指定的分组依据进行分组计算\nhead(umap_label)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 3\n  ident UMAP1_mean UMAP2_mean\n  <fct>      <dbl>      <dbl>\n1 0          8.42       1.99 \n2 1         -9.18       1.84 \n3 2          5.51       1.68 \n4 3         -8.49       3.87 \n5 4          6.67      -2.58 \n6 5          0.359      0.115\n```\n:::\n\n```{.r .cell-code}\n# Plotting a UMAP plot for each of the PCs\nlibrary(purrr)\nlibrary(ggplot2)\nlibrary(cowplot)\nlibrary(dplyr)\nmap(paste0(\"PC_\", 1:16), \n    function(pc) {\n      ggplot(pc_data, \n             aes(UMAP_1, UMAP_2)) +\n        geom_point(aes_string(color = pc), \n                   alpha = 0.7) +\n        scale_color_gradient(low = \"grey90\", \n                             high = \"blue\") +\n        geom_text(data = umap_label, \n                  aes(label = ident, UMAP1_mean, UMAP2_mean)) +\n        ggtitle(pc)\n      }) %>% \n  plot_grid(plotlist = .)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-10-1.png){width=1920}\n:::\n:::\n\n\nWe can see how the clusters are represented by the different PCs. For instance, the genes driving `PC_2` exhibit higher expression in **clusters 8 and 12**. We could look back at our genes driving this PC to get an idea of what the cell types might be:\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-11_883be88f04b3d46b1a01fe017094d1e4'}\n\n```{.r .cell-code}\n# 提取PCA信息中的第二主成分，并展示对该主成分影响最大的前5个基因名\nprint(seurat_clustered[[\"pca\"]], dims = 2, nfeatures = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nPC_ 2 \nPositive:  GNLY, CCL5, NKG7, GZMB, FGFBP2 \nNegative:  CD74, IGHM, IGKC, HLA-DRA, CD79A \n```\n:::\n:::\n\n\nWith the **GNLY** and **NKG7** genes as positive markers of `PC_2`, **we can hypothesize that clusters 8 and 12 correspond to NK cells (** @tbl-cell_type_markers **)**. This just hints at what the clusters identity could be, with the identities of the clusters being determined through a combination of the PCs.\n\nTo truly determine the identity of the clusters and whether the `resolution` is appropriate, it is helpful to explore a handful of known gene markers for the cell types expected.\n\n# 探索已知的cell type markers的表达 {#sec-explore_known_markers}\n\nWith the cells clustered, we can explore the cell type identities by looking for known markers. 下面给出了本案例的cell type markers及其对应的细胞类型：\n\n|          Cell Type           |            Marker            |\n|:----------------------------:|:----------------------------:|\n|       CD14+ monocytes        |          CD14, LYZ           |\n|      FCGR3A+ monocytes       |        FCGR3A, MS4A7         |\n| Conventional dendritic cells |         FCER1A, CST3         |\n| Plasmacytoid dendritic cells | IL3RA, GZMB, SERPINF1, ITM2C |\n|         Macrophages          |     MARCO, ITGAM, ADGRE1     |\n|           B cells            |         CD79A, MS4A1         |\n|           T cells            |             CD3D             |\n|         CD4+ T cells         |       CD3D, IL7R, CCR7       |\n|         CD8+ T cells         |          CD3D, CD8A          |\n|           NK cells           |          GNLY, NKG7          |\n|        Megakaryocytes        |             PPBP             |\n|         Erythrocytes         |          HBB, HBA2           |\n\n: 细胞类型marker基因 {#tbl-cell_type_markers}\n\n::: {.callout-tip collapse=\"true\"}\n###### 常用的**marker注释数据库**：\n\n-   [**SingleR**](https://github.com/dviraran/SingleR)是一个用于单细胞RNA测序数据细胞类型注释的工具，使用已知的细胞类型基因表达模式来预测未知细胞类型。\n\n-   [**CellMarker 2.0**](http://117.50.127.228/CellMarker/index.html)是人类和小鼠细胞类型标记物数据库，收集了已知细胞表面分子和转录因子的信息，并提供了细胞类型注释的参考。\n\n-   [**Human Protein Atlas**](https://www.proteinatlas.org)是一个用于人类蛋白组学的数据库，其中包含各种组织和细胞类型的蛋白质表达信息，可以用于细胞类型的注释。\n\n这些marker数据库的注释可以通过基因名称、蛋白名称或细胞类型进行查询，以获取特定细胞类型的标记物。\n:::\n\nThe `FeaturePlot()` function from Seurat makes it easy to visualize a handful of genes using the gene IDs stored in the Seurat object. We can easily explore the expression of known gene markers on top of our UMAP visualizations. Let's go through and determine the identities of the clusters.\n\n::: callout-caution\nThe `SCTransform` normalization was performed only on the **3000** most variable genes, so many of our genes of interest may not be present in this data (见[Seurat-运行`SCTransform`](/single_cell/seurat/sctransform.qmd#sec-perform_sctransform)).\n:::\n\n::: callout-warning\n在[原教程](https://hbctraining.github.io/scRNA-seq_online/lessons/08_SC_clustering_quality_control.html)中，由于采用了Seurat V5之前的工作流（如[此前章节](/single_cell/scRNA-seq_online/07_SC_clustering_cells_SCT.qmd#sec-Load_case_data)所述），所以为了准确可视化marker基因的表达情况，将默认的assay改回了“RNA”，然后运行`NormalizeData`：\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-12_9541c04da210d8b8041130dfdd3bb9c5'}\n\n```{.r .cell-code}\nDefaultAssay(seurat_clustered) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"integrated\"\n```\n:::\n\n```{.r .cell-code}\n# Select the RNA counts slot to be the default assay\nDefaultAssay(seurat_clustered) <- \"RNA\"\n\n# Normalize RNA data for visualization purposes\nseurat_clustered <- NormalizeData(seurat_clustered, verbose = FALSE)\n```\n:::\n\n\n*Assay is a slot defined in the Seurat object, it has multiple slots within it. In a given assay, the `counts` slot stores non-normalized raw counts, and the `data` slot stores normalized expression data. Therefore, when we run the `NormalizeData()` function in the above code, the normalized data will be stored in the `data` slot of the RNA assay while the `counts` slot will remain unaltered.*\n\n而在[Seurat V5的官方教程](/single_cell/seurat/sctransform.qmd)中，经过了`SCTransform`之后绘制marker基因的表达情况时，并没有执行这一步，默认的assay仍然是“SCT”。这里为了和原教程的图像一致，所以也进行这一步。而对于以后的Seurat V5工作流考虑按照官方教程的做法。\n:::\n\nDepending on our markers of interest, they could be positive or negative markers for a particular cell type. The combined expression of our chosen handful of markers should give us an idea on whether a cluster corresponds to that particular cell type.\n\nFor the markers used here, we are looking for positive markers and consistency of expression of the markers across the clusters. For example, if there are two markers for a cell type and only one of them is expressed in a cluster - then we cannot reliably assign that cluster to the cell type.\n\n## CD14+ monocyte markers\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-13_58d04de668f75afa6aca9b889a88442b'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"CD14\", \"LYZ\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-13-1.png){width=960}\n:::\n:::\n\n\nCD14+ monocytes appear to correspond to **clusters 1, and 3**. We wouldn't include clusters 14 and 10 because they do not highly express both of these markers.\n\n## FCGR3A+ monocyte markers {#sec-fcgr3a_monocyte_markers}\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-14_1642f968965efae7067f1a21e200c932'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"FCGR3A\", \"MS4A7\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-14-1.png){width=960}\n:::\n:::\n\n\nFCGR3A+ monocytes markers distinctly highlight **cluster 10**, although we do see some decent expression in clusters 1 and 3. We would like to see additional markers for FCGR3A+ cells show up when we perform the marker identification.\n\n## Conventional dendritic cell markers\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-15_2fbc7ec806058a2ef7c8455d16892e49'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"FCER1A\", \"CST3\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-15-1.png){width=960}\n:::\n:::\n\n\nThe markers corresponding to conventional dendritic cells identify **cluster 14** (both markers consistently show expression).\n\n## Plasmacytoid dendritic cell markers\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-16_8c78eac6d6c1cfe5ccfc6ef8834635f7'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"IL3RA\", \"GZMB\", \"SERPINF1\", \"ITM2C\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-16-1.png){width=960}\n:::\n:::\n\n\nPlasmacytoid dendritic cells represent **cluster 16**. While there are a lot of differences in the expression of these markers, we see cluster 16 (though small) is consistently strongly expressed.\n\n## Macrophages\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-17_56c93d2f4e5cdca8fb2dc37ac67b7972'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"MARCO\", \"ITGAM\", \"ADGRE1\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-17-1.png){width=960}\n:::\n:::\n\n\nWe don't see much overlap of our markers, so no clusters appear to correspond to macrophages; perhaps cell culture conditions negatively selected for macrophages (more highly adherent).\n\n## B cells\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-18_c182f0532f3367c39a8bf1006ec504fb'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"CD79A\", \"MS4A1\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-18-1.png){width=960}\n:::\n:::\n\n\n可以看出，cluster 11, 7, 13属于B细胞。\n\n## T cells\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-19_3b17812373f9563a43c1163375ac9de6'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"CD3D\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\nT细胞的标志物在大量的cluster中均表达，包括cluster 0, 2, 6, 4, 5, 9。\n\n## CD4+ T cells {#sec-cd4_t_cells}\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-20_50255fc174425ac6375af1358aaa075a'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"CD3D\", \"IL7R\", \"CCR7\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-20-1.png){width=960}\n:::\n:::\n\n\n大致看出cluster 4, 0, 6, 2属于CD4+ T 细胞。\n\n## CD8+ T cells\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-21_383f1c294aa4853122ceed1fbaaf6e9e'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"CD3D\", \"CD8A\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-21-1.png){width=960}\n:::\n:::\n\n\ncluster 5和 cluster 9属于CD8+ T细胞。\n\n## NK cells\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-22_49d1a534ccd5b010568752a3f2b85128'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"GNLY\", \"NKG7\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-22-1.png){width=960}\n:::\n:::\n\n\ncluster 8, 12属于NK细胞。这和我们在前面的 @sec-Effect_of_pcs_clustering 中的结论（第二主成分的top基因GNLY和NKG7在cluster 8和cluster 12中高表达）一致。\n\n## Megakaryocytes（巨核细胞）\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-23_4f538bcefbcf8f0ecd8a7efc553d4414'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"PPBP\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\ncluster 15属于巨核细胞。\n\n## Erythrocytes（红细胞）\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-24_53354e467af2dafde02e7f4844ad96a9'}\n\n```{.r .cell-code}\nFeaturePlot(seurat_clustered, \n            reduction = \"umap\", \n            features = c(\"HBB\", \"HBA2\"), \n            order = TRUE,\n            min.cutoff = 'q10', \n            label = TRUE)\n```\n\n::: {.cell-output-display}\n![](08_SC_clustering_quality_control_files/figure-html/unnamed-chunk-24-1.png){width=960}\n:::\n:::\n\n\n可以看到，红细胞的marker gene基本没有明显的表达。\n\n------------------------------------------------------------------------\n\n# **细胞类型初步鉴定结果** {#sec-Preliminary_cell_type_identification_results}\n\n根据上面的marker表达情况，我们大致可以确定如下细胞类型鉴定结果:\n\n|          Cell Type           |     Clusters     |\n|:----------------------------:|:----------------:|\n|       CD14+ monocytes        |       1, 3       |\n|      FCGR3A+ monocytes       |        10        |\n| Conventional dendritic cells |        14        |\n| Plasmacytoid dendritic cells |        16        |\n|         Marcrophages         |        \\-        |\n|           B cells            |    11, 7, 13     |\n|           T cells            | 0, 2, 6, 4, 5, 9 |\n|         CD4+ T cells         |    4, 0, 6, 2    |\n|         CD8+ T cells         |       5, 9       |\n|           NK cells           |      8, 12       |\n|        Megakaryocytes        |        15        |\n|         Erythrocytes         |        \\-        |\n|           Unknown            |        \\-        |\n\n------------------------------------------------------------------------\n\n::: callout-important\nIf any cluster appears to contain two separate cell types, it's helpful to i**ncrease our clustering resolution** to properly subset the clusters. Alternatively, if we still can't separate out the clusters using increased resolution, then it's possible that we had used **too few principal components** such that we are just not separating out these cell types of interest. To inform our choice of PCs, we could look at our PC gene expression overlapping the UMAP plots and determine whether our cell populations are separating by the PCs included.\n:::\n\nNow we have a decent idea as to the cell types corresponding to the majority of the clusters, but some questions remain:\n\n1.  *T cell markers appear to be highly expressed in many clusters. How can we differentiate and subset the larger group into smaller subset of cells?*\n2.  *Do the clusters corresponding to the same cell types have biologically meaningful differences? Are there subpopulations of these cell types?*\n3.  *Can we acquire higher confidence in these cell type identities by identifying other marker genes for these clusters?*\n\nMarker identification analysis can help us address all of these questions!!\n\nThe next step will be to perform marker identification analysis, which will output the genes that significantly differ in expression between clusters. Using these genes we can determine or improve confidence in the identities of the clusters/subclusters.\n\n# 保存数据\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-25_e94c32bab1b282111ca0e4ddeb560210'}\n\n```{.r .cell-code}\nsaveRDS(seurat_clustered, file = \"output/scRNA-seq_online/seurat_clustered_qc.rds\")\n```\n:::\n\n\n------------------------------------------------------------------------\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n## Session Info\n\n\n::: {.cell hash='08_SC_clustering_quality_control_cache/html/unnamed-chunk-26_d062c5e4c003943e67666d0f21cdb23d'}\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Sonoma 14.3\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Asia/Shanghai\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] cowplot_1.1.2      ggplot2_3.4.4      purrr_1.0.2        tidyr_1.3.0       \n[5] dplyr_1.1.4        Seurat_5.0.1       SeuratObject_5.0.1 sp_2.1-2          \n\nloaded via a namespace (and not attached):\n  [1] deldir_2.0-2           pbapply_1.7-2          gridExtra_2.3         \n  [4] rlang_1.1.3            magrittr_2.0.3         RcppAnnoy_0.0.21      \n  [7] spatstat.geom_3.2-7    matrixStats_1.2.0      ggridges_0.5.5        \n [10] compiler_4.3.2         png_0.1-8              vctrs_0.6.5           \n [13] reshape2_1.4.4         stringr_1.5.1          pkgconfig_2.0.3       \n [16] fastmap_1.1.1          ellipsis_0.3.2         labeling_0.4.3        \n [19] utf8_1.2.4             promises_1.2.1         rmarkdown_2.25        \n [22] xfun_0.41              jsonlite_1.8.8         goftest_1.2-3         \n [25] later_1.3.2            spatstat.utils_3.0-4   irlba_2.3.5.1         \n [28] parallel_4.3.2         cluster_2.1.6          R6_2.5.1              \n [31] ica_1.0-3              stringi_1.8.3          RColorBrewer_1.1-3    \n [34] spatstat.data_3.0-4    reticulate_1.34.0      parallelly_1.36.0     \n [37] lmtest_0.9-40          scattermore_1.2        Rcpp_1.0.12           \n [40] knitr_1.45             tensor_1.5             future.apply_1.11.1   \n [43] zoo_1.8-12             sctransform_0.4.1      httpuv_1.6.13         \n [46] Matrix_1.6-5           splines_4.3.2          igraph_1.6.0          \n [49] tidyselect_1.2.0       abind_1.4-5            rstudioapi_0.15.0     \n [52] yaml_2.3.8             spatstat.random_3.2-2  codetools_0.2-19      \n [55] miniUI_0.1.1.1         spatstat.explore_3.2-5 listenv_0.9.0         \n [58] lattice_0.22-5         tibble_3.2.1           plyr_1.8.9            \n [61] withr_3.0.0            shiny_1.8.0            ROCR_1.0-11           \n [64] evaluate_0.23          Rtsne_0.17             future_1.33.1         \n [67] fastDummies_1.7.3      survival_3.5-7         polyclip_1.10-6       \n [70] fitdistrplus_1.1-11    pillar_1.9.0           KernSmooth_2.23-22    \n [73] plotly_4.10.4          generics_0.1.3         RcppHNSW_0.5.0        \n [76] munsell_0.5.0          scales_1.3.0           globals_0.16.2        \n [79] xtable_1.8-4           glue_1.7.0             lazyeval_0.2.2        \n [82] tools_4.3.2            data.table_1.14.10     RSpectra_0.16-1       \n [85] RANN_2.6.1             leiden_0.4.3.1         dotCall64_1.1-1       \n [88] grid_4.3.2             colorspace_2.1-0       nlme_3.1-164          \n [91] patchwork_1.2.0        cli_3.6.2              spatstat.sparse_3.0-3 \n [94] spam_2.10-0            fansi_1.0.6            viridisLite_0.4.2     \n [97] uwot_0.1.16            gtable_0.3.4           digest_0.6.34         \n[100] progressr_0.14.0       ggrepel_0.9.5          farver_2.1.1          \n[103] htmlwidgets_1.6.4      htmltools_0.5.7        lifecycle_1.0.4       \n[106] httr_1.4.7             mime_0.12              MASS_7.3-60.0.1       \n```\n:::\n:::\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}