<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>R语言学习笔记：从数据清洗到高级统计学和生物信息学 - 基于dplyr包的数据处理</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../r_basic/character.html" rel="next">
<link href="../r_basic/basic_data_function.html" rel="prev">
<link href="../images/logo.jpg" rel="icon" type="image/jpeg">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-G2HZEXHNCE"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-G2HZEXHNCE', { 'anonymize_ip': true});
</script><script type="application/json" class="js-hypothesis-config">
{
  "theme": "classic",
  "openSidebar": false,
  "showHighlights": "always",
  "enableExperimentalNewNoteButton": true
}
</script><script async="" src="https://hypothes.is/embed.js"></script>
<meta property="og:title" content="R语言学习笔记：从数据清洗到高级统计学和生物信息学 - 基于dplyr包的数据处理">
<meta property="og:description" content="">
<meta property="og:image" content="https://djhcod.github.io/r-notes/r_basic/images/logo-2.png">
<meta property="og:site-name" content="R语言学习笔记：从数据清洗到高级统计学和生物信息学">
<meta property="og:image:height" content="277">
<meta property="og:image:width" content="240">
<meta name="twitter:title" content="R语言学习笔记：从数据清洗到高级统计学和生物信息学 - 基于dplyr包的数据处理">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://djhcod.github.io/r-notes/r_basic/images/logo-2.png">
<meta name="twitter:image-height" content="277">
<meta name="twitter:image-width" content="240">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/logo.jpg" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">R语言学习笔记</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link active" href="../index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../r_basic/r_basics.html" rel="" target="">
 <span class="menu-text">R语言基础</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">单细胞数据分析</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-">
<li>
    <a class="dropdown-item" href="../single_cell/single_cell_intro.html" rel="" target="">
 <span class="dropdown-text">单细胞数据分析介绍</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../single_cell/seurat/seurat_intro.html" rel="" target="">
 <span class="dropdown-text">Seurat v5官方文档</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../single_cell/scRNA-seq_online/00_intro.html" rel="" target="">
 <span class="dropdown-text">scRNA-seq_online学习材料</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../single_cell/sc_supplementary/sc_supplementary_intro.html" rel="" target="">
 <span class="dropdown-text">单细胞补充内容</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../quarto_foundation/quarto_foundation.html" rel="" target="">
 <span class="menu-text">Quarto基础</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="https://bookdown.org" rel="" target=""><i class="bi bi-book-fill" role="img">
</i> 
 <span class="menu-text">Bookdown</span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/djhcod/r-notes" rel="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../r_basic/r_basics.html">R语言基础</a></li><li class="breadcrumb-item"><a href="../r_basic/dplyr.html">基于dplyr包的数据处理</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">主页</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../r_basic/r_basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R语言基础</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../r_basic/environment_configuration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rstudio环境配置</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../r_basic/data_input_output.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">数据的读取与输出</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../r_basic/basic_data_function.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">数据处理基本函数</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../r_basic/dplyr.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">基于dplyr包的数据处理</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../r_basic/character.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">字符的处理</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../r_basic/loop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">循环</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../single_cell/single_cell_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">单细胞数据分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">单细胞测序技术介绍</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/generation_of_count_matrix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">单细胞RNA测序—从raw data到count matrix</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../single_cell/seurat/seurat_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Seurat v5官方文档</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/seurat_command_list.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Seurat常用函数清单</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/seurat_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Seurat细胞分群官方教程</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/data_visualization_methods_in_seurat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Seurat中的数据可视化方法</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/sctransform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">基于SCTransform的单细胞数据标准化</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/cell_cycle_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">消除细胞周期的影响</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">整合（integration）</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/integrative_analysis_in_seurat_v5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Seurat v5单细胞数据整合分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/marker_gene_identification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">寻找marker gene</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/de_vignette.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">寻找不同样本类型间同一细胞类型内的差异基因</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/seurat/mapping_and_annotating_query_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">基于参考集的细胞注释</span></a>
  </div>
</li>
      </ul>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../single_cell/scRNA-seq_online/00_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">scRNA-seq_online学习材料</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_online/03_SC_quality_control-setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">数据导入与Seurat对象构建</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_online/04_SC_quality_control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">质控</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_online/postQC_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Single-cell RNA-seq Clustering Workflow</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_online/05_theory_of_PCA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PCA原理</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_online/06_SC_SCT_normalization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Normalization and regressing out unwanted variation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_online/06_integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">单细胞数据整合（Integration）</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_online/07_SC_clustering_cells_SCT.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">细胞聚类（clustering analysis）</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_online/08_SC_clustering_quality_control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">细胞分群质量评估</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/scRNA-seq_online/09_merged_SC_marker_identification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">寻找marker基因+细胞注释</span></a>
  </div>
</li>
      </ul>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../single_cell/sc_supplementary/sc_supplementary_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">单细胞补充内容</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/sc_supplementary/read_sc_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">读取非标准格式的单细胞数据</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/sc_supplementary/universal_marker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">细胞分群通用marker</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/sc_supplementary/integrated_analysis_multiple_single_cell_datasets_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">多个单细胞数据集整合分析（上）</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/sc_supplementary/integrated_analysis_multiple_single_cell_datasets_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">多个单细胞数据集整合分析（下）</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../single_cell/sc_supplementary/DecontX.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">预测和去除单细胞转录组的环境游离RNA污染</span></a>
  </div>
</li>
      </ul>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../quarto_foundation/quarto_foundation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quarto基础</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto_foundation/yaml_settings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">YAML设置</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto_foundation/images_settings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">图片设置</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto_foundation/cross_references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">交叉引用</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto_foundation/insert_other_content.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">插入其他内容</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto_foundation/quarto_shiny.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">在Quarto中嵌入Shiny应用程序</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto_foundation/quarto_books.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quarto Books</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto_foundation/github_pages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">发布到GitHub Pages</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#%E4%BB%8B%E7%BB%8D" id="toc-介绍" class="nav-link active" data-scroll-target="#%E4%BB%8B%E7%BB%8D"><span class="header-section-number">1</span> 介绍</a></li>
  <li>
<a href="#%E7%AE%A1%E9%81%93%E6%93%8D%E4%BD%9C%E7%AC%A6" id="toc-管道操作符" class="nav-link" data-scroll-target="#%E7%AE%A1%E9%81%93%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="header-section-number">2</span> 管道操作符</a>
  <ul class="collapse">
<li><a href="#%E7%AE%A1%E9%81%93%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95" id="toc-管道的基本用法" class="nav-link" data-scroll-target="#%E7%AE%A1%E9%81%93%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="header-section-number">2.1</span> 管道的基本用法</a></li>
  <li><a href="#%E7%AE%A1%E9%81%93%E7%9A%84%E8%BF%9B%E9%98%B6%E7%94%A8%E6%B3%95" id="toc-管道的进阶用法" class="nav-link" data-scroll-target="#%E7%AE%A1%E9%81%93%E7%9A%84%E8%BF%9B%E9%98%B6%E7%94%A8%E6%B3%95"><span class="header-section-number">2.2</span> <strong>管道的进阶用法</strong></a></li>
  <li>
<a href="#%E7%89%B9%E6%AE%8A%E7%AE%A1%E9%81%93%E7%AC%A6" id="toc-特殊管道符" class="nav-link" data-scroll-target="#%E7%89%B9%E6%AE%8A%E7%AE%A1%E9%81%93%E7%AC%A6"><span class="header-section-number">2.3</span> 特殊管道符</a>
  <ul class="collapse">
<li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"><code>%$%</code></a></li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1"><code>%&lt;&gt;%</code></a></li>
  <li><a href="#t" id="toc-t" class="nav-link" data-scroll-target="#t"><code>%T&gt;%</code></a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#%E5%AF%B9%E8%A1%8C%E7%9A%84%E6%93%8D%E4%BD%9C" id="toc-对行的操作" class="nav-link" data-scroll-target="#%E5%AF%B9%E8%A1%8C%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="header-section-number">3</span> 对行的操作</a>
  <ul class="collapse">
<li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter"><span class="header-section-number">3.1</span> <code>filter()</code></a></li>
  <li><a href="#arrange" id="toc-arrange" class="nav-link" data-scroll-target="#arrange"><span class="header-section-number">3.2</span> <code>arrange()</code></a></li>
  <li><a href="#distinct" id="toc-distinct" class="nav-link" data-scroll-target="#distinct"><span class="header-section-number">3.3</span> <code>distinct()</code></a></li>
  </ul>
</li>
  <li>
<a href="#%E5%AF%B9%E5%88%97%E7%9A%84%E6%93%8D%E4%BD%9C" id="toc-对列的操作" class="nav-link" data-scroll-target="#%E5%AF%B9%E5%88%97%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="header-section-number">4</span> 对列的操作</a>
  <ul class="collapse">
<li><a href="#mutate" id="toc-mutate" class="nav-link" data-scroll-target="#mutate"><span class="header-section-number">4.1</span> <code>mutate()</code></a></li>
  <li><a href="#select" id="toc-select" class="nav-link" data-scroll-target="#select"><span class="header-section-number">4.2</span> <code>select()</code></a></li>
  <li>
<a href="#rename" id="toc-rename" class="nav-link" data-scroll-target="#rename"><span class="header-section-number">4.3</span> <code>rename()</code></a>
  <ul class="collapse">
<li><a href="#rename_with" id="toc-rename_with" class="nav-link" data-scroll-target="#rename_with"><code>rename_with()</code></a></li>
  </ul>
</li>
  <li><a href="#relocate" id="toc-relocate" class="nav-link" data-scroll-target="#relocate"><span class="header-section-number">4.4</span> <code>relocate()</code></a></li>
  </ul>
</li>
  <li>
<a href="#%E5%88%86%E7%BB%84%E7%BB%9F%E8%AE%A1" id="toc-分组统计" class="nav-link" data-scroll-target="#%E5%88%86%E7%BB%84%E7%BB%9F%E8%AE%A1"><span class="header-section-number">5</span> 分组统计</a>
  <ul class="collapse">
<li><a href="#group_by" id="toc-group_by" class="nav-link" data-scroll-target="#group_by"><span class="header-section-number">5.1</span> <code>group_by()</code></a></li>
  <li><a href="#summarize" id="toc-summarize" class="nav-link" data-scroll-target="#summarize"><span class="header-section-number">5.2</span> <code>summarize()</code></a></li>
  <li><a href="#slice_%E7%B3%BB%E5%88%97%E5%87%BD%E6%95%B0" id="toc-slice_系列函数" class="nav-link" data-scroll-target="#slice_%E7%B3%BB%E5%88%97%E5%87%BD%E6%95%B0"><span class="header-section-number">5.3</span> <code>slice_</code>系列函数</a></li>
  <li><a href="#%E5%A4%9A%E5%8F%98%E9%87%8F%E5%88%86%E7%BB%84%E7%BB%9F%E8%AE%A1" id="toc-多变量分组统计" class="nav-link" data-scroll-target="#%E5%A4%9A%E5%8F%98%E9%87%8F%E5%88%86%E7%BB%84%E7%BB%9F%E8%AE%A1"><span class="header-section-number">5.4</span> 多变量分组统计</a></li>
  <li><a href="#ungroup" id="toc-ungroup" class="nav-link" data-scroll-target="#ungroup"><span class="header-section-number">5.5</span> <code>ungroup()</code></a></li>
  <li><a href="#by" id="toc-by" class="nav-link" data-scroll-target="#by"><span class="header-section-number">5.6</span> <code>.by</code></a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/djhcod/r-notes/blob/main/r_basic/dplyr.qmd" class="toc-action">View source</a></p><p><a href="https://github.com/djhcod/r-notes/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">基于dplyr包的数据处理</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><blockquote class="blockquote">
<p>参考：</p>
<p><a href="https://dplyr.tidyverse.org/index.html"><em>dplyr官方文档</em></a></p>
<p><a href="https://r4ds.hadley.nz/data-transform"><em>Data transformation chapter</em></a> <em>in R for Data Science</em></p>
</blockquote>
<p><img src="images/logo-2.png" class="img-fluid" width="205"></p>
<section id="介绍" class="level1" data-number="1"><h1 data-number="1">
<span class="header-section-number">1</span> 介绍</h1>
<p><code>dplyr</code>包是<code>tidyverse</code>的核心包之一，为数据处理提供了一系列方便快捷的函数。本章将以<code>nycflights13</code>包中的flights案例数据来介绍基于dplyr包的数据处理语法。该数据集包含 2013 年从纽约市起飞的所有 336,776 次航班的信息。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-1_c011a339dc938c4fae6d7098eb02e6c9">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">flights</span>, package <span class="op">=</span> <span class="st">"nycflights13"</span><span class="op">)</span></span>
<span><span class="va">flights</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>这里的flights数据是一个 tibble，这是一种升级版的data.frame，被 tidyverse 用来避免一些data.frame的常见问题。Tibbles 和data.frame之间的一个重要的区别在于 tibbles 打印数据的方式：tibbles 是为大型数据集设计的，因此只显示前几行和适应屏幕宽度的列（如上）。可以使用 <code>print(flights, width = Inf)</code> 显示所有列，或者使用 <code><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse()</a></code>：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-2_3337a29fffb03af76a072b7d14b02ac7">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 336,776
Columns: 19
$ year           &lt;int&gt; 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2…
$ month          &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ day            &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ dep_time       &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558, …
$ sched_dep_time &lt;int&gt; 515, 529, 540, 545, 600, 558, 600, 600, 600, 600, 600, …
$ dep_delay      &lt;dbl&gt; 2, 4, 2, -1, -6, -4, -5, -3, -3, -2, -2, -2, -2, -2, -1…
$ arr_time       &lt;int&gt; 830, 850, 923, 1004, 812, 740, 913, 709, 838, 753, 849,…
$ sched_arr_time &lt;int&gt; 819, 830, 850, 1022, 837, 728, 854, 723, 846, 745, 851,…
$ arr_delay      &lt;dbl&gt; 11, 20, 33, -18, -25, 12, 19, -14, -8, 8, -2, -3, 7, -1…
$ carrier        &lt;chr&gt; "UA", "UA", "AA", "B6", "DL", "UA", "B6", "EV", "B6", "…
$ flight         &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, 4…
$ tailnum        &lt;chr&gt; "N14228", "N24211", "N619AA", "N804JB", "N668DN", "N394…
$ origin         &lt;chr&gt; "EWR", "LGA", "JFK", "JFK", "LGA", "EWR", "EWR", "LGA",…
$ dest           &lt;chr&gt; "IAH", "IAH", "MIA", "BQN", "ATL", "ORD", "FLL", "IAD",…
$ air_time       &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, 1…
$ distance       &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733, …
$ hour           &lt;dbl&gt; 5, 5, 5, 5, 6, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6, 6…
$ minute         &lt;dbl&gt; 15, 29, 40, 45, 0, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 0…
$ time_hour      &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 0…</code></pre>
</div>
</div>
<p>在这两种视图中，变量名下方或后面都有相应的缩写，代表每个变量的类型：<code>&lt;int&gt;</code> 代表整数型数据，<dbl> 代表数值型数据，<chr> 代表字符型数据，<dttm> 代表日期时间型数据。这些变量非常重要，因为对列进行的操作在很大程度上取决于该列的 “类型”。更多关于tibble的说明参考<code>tibble</code>包的<a href="https://tibble.tidyverse.org/index.html">官方文档</a>。</dttm></chr></dbl></p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure"><p><a href="https://tibble.tidyverse.org/index.html"><img src="images/logo.png" class="img-fluid figure-img" width="157"></a></p>
</figure>
</div>
<p><code>dplyr</code>语法的共同特点：</p>
<ul>
<li><p>第一个参数始终是数据集（tibble或data.frame）的名字。</p></li>
<li><p>后面的参数通常使用变量名（不带引号）来描述要对哪些列进行操作。</p></li>
<li><p>输出总是一个新的tibble或data.frame。</p></li>
</ul>
<p><code>dplyr</code> 的函数可以根据它们的操作对象分为四类：分别是对行进行操作的函数、对列进行操作的函数、对表进行操作的函数以及分组统计函数，同时还包括一个特殊的管道符号<code>%&gt;%</code>。本章将介绍除对表进行操作之外的函数。</p>
</section><section id="管道操作符" class="level1" data-number="2"><h1 data-number="2">
<span class="header-section-number">2</span> 管道操作符</h1>
<blockquote class="blockquote">
<p>参考：<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512157&amp;idx=1&amp;sn=47466392bd7c54e17c57b232b29b551b&amp;chksm=fa457560cd32fc76da55c346ef08917343322ecb5d24b3b591d9c65549ed1f0ca10f57f1105d&amp;mpshare=1&amp;scene=1&amp;srcid=0407dIwqephXlKmnMrPSvpRb&amp;sharer_sharetime=1680842848403&amp;sharer_shareid=568f49cb24905bf546294e6985a632bf#rd"><em>生信菜鸟团-R tips: R管道的用法</em></a></p>
</blockquote>
<p>R中有两种管道操作符（pipe operator)，分别是R自带的来自<code>base</code>包的<code>|&gt;</code>，和来自<code>magrittr</code><strong>包（上级包是</strong><code>dplyr</code>和<code>tidyverse</code><strong>）</strong>的<code>%&gt;%</code>。我们可以将管道操作符理解为车间里的流水线，经过前一步加工的产品才能进入后一步进一步加工，其作用是将上一步的结果直接传参给下一步的函数，从而<strong>省略了中间的赋值步骤</strong>，可以大量<strong>减少中间变量</strong>，节省内存。例如：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-3_611839ab288940fee989815a2e0576c5">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 不使用管道操作服</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="dplyr_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-4_7a7e21695bfc5bcb89da5cbc25c35c7e">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 管道调用</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># or</span></span>
<span><span class="fl">10</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果<code>x</code>, <code>y</code>并不会被后面的代码用到的话，那么减少这种中间变量的产生是有利于代码的整洁和降低变量冲突的风险的。</p>
<p>如果不使用管道操作，同时要避免产生中间变量的话就需要嵌套代码，而管道操作则通过一种链式调用的方式去写嵌套调用的代码，使代码更清晰和易于理解。比如：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-5_2d1e5dcc0cb8c51f21be540a5bc007cb">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 嵌套调用</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 管道调用</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>很明显管道的调用逻辑要比嵌套调用更加清晰而符合直觉。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>来自<code>magrittr</code><strong>包</strong>的管道符<code>%&gt;%</code>和<code>base</code>包的<code>|&gt;</code>存在一些语法上的区别，<code>%&gt;%</code>的功能更多（见下文）。</p></li>
<li><p>在一般使用时，如果不需要<code>%&gt;%</code>的高级功能，建议直接用从2021年的R 4.1.0开始原生支持的<code>|&gt;</code>作为默认管道符。如果需要用到高级功能，或习惯tidyverse包的数据处理语法，则再考虑使用<code>%&gt;%</code>。</p></li>
<li>
<p>RStudio目前通过快捷键<code>Command</code>+<code>Shift</code>+<code>M</code>默认插入的是<code>%&gt;%</code>符号，可以通过在设置中勾选如下选项来让该快捷键默认插入<code>|&gt;</code>。</p>
<p><img src="images/截屏2024-02-02 15.41.06.png" class="img-fluid" width="573"></p>
</li>
</ul>
</div>
</div>
<section id="管道的基本用法" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="管道的基本用法">
<span class="header-section-number">2.1</span> 管道的基本用法</h2>
<p>管道的用法就是通过管道符<code>|&gt;</code>或<code>%&gt;%</code>串联起来前后的两个函数调用，先计算管道符号左边的函数调用，然后将其结果自动传递给管道符号右边函数的<strong>第一个参数（默认）</strong>，然后对运行这个函数，正如上面的例子中提到的一样。<strong>如果不想把值传递给第一个参数，则可以用占位符<code>_</code>（适用于</strong><code>|&gt;</code>）或<strong><code>.</code>（适用于<code>%&gt;%</code>）的形式指定把前面的运算结果传递给哪个参数</strong>。</p>
<p>比如想在mtcars数据集的车名中寻找所有以“M”开头的车名，则可以通过如下方式寻找：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-6_d48dd4a2f8d2b221237c4334d96ca0d2">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^M"</span>, x <span class="op">=</span> <span class="va">_</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1  2  8  9 10 11 12 13 14 31</code></pre>
</div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#或用%&gt;%形式</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span> <span class="co"># 也可以直接加载dplyr或tidyverse包，便于后续调用其他tidyverse函数</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"^M"</span>, x <span class="op">=</span> <span class="va">.</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1  2  8  9 10 11 12 13 14 31</code></pre>
</div>
</div>
<p>解释如下：在<code>grep</code>函数那里，由于我们想在车名（这里是行名）中找到符合特定<code>pattern</code>的车名位置，因此需要把车名传给<code>grep</code>的第二个参数<code>x</code>，所以就可以<code>.</code>或<code>_</code>的形式将前面的值传给<code>grep</code>的<code>x</code>。</p>
<p><strong>⚠️注意：传给其他位置的<code>.</code>必须是独立的</strong>，不能在一个表达式（函数）中，比如如下情况，我只想寻找前10个车名中以“M”开头的车名位置：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-7_4251ec8bc4b829f494c52ef2e60a4171">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 错误 ---------------</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">rownames</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^M"</span>, x <span class="op">=</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in grep(., "^M", x = .[1:10]): argument 'pattern' has length &gt; 1 and
only the first element will be used</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2</code></pre>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 正确 ---------------</span></span>
<span><span class="va">mtcars</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">rownames</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^M"</span>, x <span class="op">=</span> <span class="va">.</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1  2  8  9 10</code></pre>
</div>
</div>
<p>上面的错误调用中，传递给<code>grep</code>的<code>x</code>参数的是一个表达式<code>.[1:10]</code>，不是一个单独的<code>.</code>了，因此失去了调整前面值的位置的作用，它就等价于如下调用：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-8_00f6bffe0365a2a93dc1b3a3e7c41706">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 错误  ---------------</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">rownames</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^M"</span>, x <span class="op">=</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 等价于 --------------</span></span>
<span><span class="co"># 还是把前面的值传递给第一个参数：</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">rownames</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"^M"</span>, x <span class="op">=</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="管道的进阶用法" class="level2" data-number="2.2"><h2 data-number="2.2" class="anchored" data-anchor-id="管道的进阶用法">
<span class="header-section-number">2.2</span> <strong>管道的进阶用法</strong>
</h2>
<p>我们可以通过“{}”符号包裹后续函数，在“{}”内的代码，可以任意的使用多个占位符<code>.</code>去传递管道前的值。还是上面的例子：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-9_6af3978432bf10e4bd401c295af19e75">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mtcars</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^M"</span>, x <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 用“{}”的形式 ---------------</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">rownames</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^M"</span>, x <span class="op">=</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>⚠️注意，<code>|&gt;</code>不支持“{}”形式：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-10_7a2a295b0776969e50d290cc07c70f6a">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 错误：</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">|&gt;</span> <span class="fu">rownames</span>() <span class="sc">|&gt;</span> {<span class="fu">grep</span>(<span class="st">"^M"</span>, <span class="at">x =</span> _[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这也反映出<code>base</code>包<code>|&gt;</code>功能的局限性。</p>
<p>本质上“{}”是<code>magrittr</code>改写的一个匿名函数，只有唯一的一个参数，也就是<code>.</code> ：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-11_172c31e62235fb636d90978f8d599de4">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># any code</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>比如想要获取mtcars的前5行前5列，然后更改行名和列名后，再返回这个数据框：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-12_4a2ed4a56c588035a0737d2b1d83d1c0">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"row"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"col"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="va">.</span> <span class="co"># &lt;---------- 不要忘了返回这个数据框</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">df</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     col1 col2 col3 col4 col5
row1 21.0    6  160  110 3.90
row2 21.0    6  160  110 3.90
row3 22.8    4  108   93 3.85
row4 21.4    6  258  110 3.08
row5 18.7    8  360  175 3.15</code></pre>
</div>
</div>
<p>⚠️注意，在整个“{}”包括的语句中，如果再使用管道要注意这时的占位符.代表的是“{}”内的对象。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-13_4f0f35db305a177f4b313b8713ca7c28">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"row"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"col"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span> <span class="co"># cbind里面的.不指代{}外面的值</span></span>
<span>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     col1 col2 col3 col4 col5 col1 col2 col3 col4 col5
row1 21.0    6  160  110 3.90 21.0    6  160  110 3.90
row2 21.0    6  160  110 3.90 21.0    6  160  110 3.90
row3 22.8    4  108   93 3.85 22.8    4  108   93 3.85</code></pre>
</div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 等价：</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"row"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"col"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="va">.</span></span>
<span>  <span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     col1 col2 col3 col4 col5 col1 col2 col3 col4 col5
row1 21.0    6  160  110 3.90 21.0    6  160  110 3.90
row2 21.0    6  160  110 3.90 21.0    6  160  110 3.90
row3 22.8    4  108   93 3.85 22.8    4  108   93 3.85</code></pre>
</div>
</div>
</section><section id="特殊管道符" class="level2" data-number="2.3"><h2 data-number="2.3" class="anchored" data-anchor-id="特殊管道符">
<span class="header-section-number">2.3</span> 特殊管道符</h2>
<p><code>magrittr</code>包内除了<code>%&gt;%</code>管道符外，还提供了<code>%$%</code>、<code>%&lt;&gt;%</code>、<code>%T&gt;%</code>、<code>%!&gt;%</code>，他们的作用简述如下：</p>
<section id="section" class="level3"><h3 class="anchored" data-anchor-id="section"><code>%$%</code></h3>
<p>用于传递管道左侧数据的names：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-14_d86f545e341baf7ccc1c016b4de6a4bc">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "mpg"  "cyl"  "disp" "hp"   "drat" "wt"   "qsec" "vs"   "am"   "gear"
[11] "carb"</code></pre>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># mtcars的每个元素都可以被后面的函数所使用</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/exposition.html">%$%</a></span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">cyl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="dplyr_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-15_dc5ec39ba6fdea74b633599904065f59">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 等价于</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">.</span><span class="op">[</span>,<span class="st">"mpg"</span><span class="op">]</span>, <span class="va">.</span><span class="op">[</span>, <span class="st">"cyl"</span><span class="op">]</span><span class="op">)</span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="dplyr_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 840.9</code></pre>
</div>
</div>
</section><section id="section-1" class="level3"><h3 class="anchored" data-anchor-id="section-1"><code>%&lt;&gt;%</code></h3>
<p>将管道的结果最终再赋值回最左侧的变量：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-16_8baa8fbc74890db8228b56ebc3b5b458">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">x</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.2070657  0.2774292  1.0844412 -2.3456977  0.4291247</code></pre>
</div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># x排序后加上10，最后再赋值给x</span></span>
<span><span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="va">.</span> <span class="op">+</span> <span class="fl">10</span><span class="op">}</span></span>
<span><span class="va">x</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  7.654302  8.792934 10.277429 10.429125 11.084441</code></pre>
</div>
</div>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-17_0a5e11fd5e1be8ce1177dd05cfe878ad">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 等价于</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="va">.</span> <span class="op">+</span> <span class="fl">10</span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="t" class="level3"><h3 class="anchored" data-anchor-id="t"><code>%T&gt;%</code></h3>
<p>分支管道，传入左侧的值并运算后将原始值而不是运算结果传递给后续管道。这在多个管道中间使用<code><a href="https://rdrr.io/r/base/print.html">print()</a></code>、<code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code>或<code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>这些函数返回信息时非常有用。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-18_31d99e96fea320e03d940c51187c3611">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 传递给sum()的是前面所有函数的运算结果，由于plot()不返回任何数值，所以sum()的结果为0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/tee.html">%T&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 传递给sum()的是1:5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="dplyr_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15</code></pre>
</div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 另一个例子</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/tee.html">%T&gt;%</a></span></span>
<span>  <span class="va">plot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 传递给colSums()的是“rnorm(200) %&gt;% matrix(ncol = 2)”</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="dplyr_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -15.23708   7.82692</code></pre>
</div>
</div>
<hr></section></section></section><section id="对行的操作" class="level1" data-number="3"><h1 data-number="3">
<span class="header-section-number">3</span> 对行的操作</h1>
<section id="filter" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="filter">
<span class="header-section-number">3.1</span> <code>filter()</code>
</h2>
<p><img src="images/截屏2024-02-02 17.29.00.png" class="img-fluid" width="173"></p>
<p>用于提取满足某（些）条件的行，基本等同于<a href="../r_basic/basic_data_function.html#sec-筛选数据"><code>subset()</code></a>。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-19_b26a1c381fc344cd3e78d12ca8cfc84e">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 查找所有晚点 120 分钟（两小时）以上起飞的航班：</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">dep_delay</span> <span class="op">&gt;</span> <span class="fl">120</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,723 × 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      848           1835       853     1001           1950
 2  2013     1     1      957            733       144     1056            853
 3  2013     1     1     1114            900       134     1447           1222
 4  2013     1     1     1540           1338       122     2020           1825
 5  2013     1     1     1815           1325       290     2120           1542
 6  2013     1     1     1842           1422       260     1958           1535
 7  2013     1     1     1856           1645       131     2212           2005
 8  2013     1     1     1934           1725       129     2126           1855
 9  2013     1     1     1938           1703       155     2109           1823
10  2013     1     1     1942           1705       157     2124           1830
# ℹ 9,713 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 查找一月或二月起飞的航班</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 51,955 × 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 51,945 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
</section><section id="arrange" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="arrange">
<span class="header-section-number">3.2</span> <code>arrange()</code>
</h2>
<p>排序，以某列为依据对行进行排序（在前面的数据<a href="../r_basic/basic_data_function.html#sec-排序">处理基本函数</a>一章中已涉及该函数）。对应的功能在<code>base</code>包中是<code><a href="https://rdrr.io/r/base/order.html">order()</a></code>函数。如果提供的列名不止一个，则依次根据提供的列的顺序对数据进行排序。例如，下面的代码按航班出发时间排序，出发时间分布在四列中。我们首先得到最早的年份，然后在一年内得到最早的月份，依此类推。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-20_935c9354168899f58c684ee23cbd4151">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">dep_time</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>可以加上<code><a href="https://dplyr.tidyverse.org/reference/desc.html">desc()</a></code>实现降序排列：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-21_0b3a5585110a6ae40f48c991dec1f9ec">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">dep_delay</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     9      641            900      1301     1242           1530
 2  2013     6    15     1432           1935      1137     1607           2120
 3  2013     1    10     1121           1635      1126     1239           1810
 4  2013     9    20     1139           1845      1014     1457           2210
 5  2013     7    22      845           1600      1005     1044           1815
 6  2013     4    10     1100           1900       960     1342           2211
 7  2013     3    17     2321            810       911      135           1020
 8  2013     6    27      959           1900       899     1236           2226
 9  2013     7    22     2257            759       898      121           1026
10  2013    12     5      756           1700       896     1058           2020
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
</section><section id="distinct" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="distinct">
<span class="header-section-number">3.3</span> <code>distinct()</code>
</h2>
<p><img src="images/截屏2024-02-02 17.29.29.png" class="img-fluid" width="212"></p>
<p>查找数据集中所有唯一的行。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-22_ff85d38ee38969c5e85b8ac99d78add0">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 移除所有完全相同的行</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 查找所有唯一的出发地和目的地配对</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">origin</span>, <span class="va">dest</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 224 × 2
   origin dest 
   &lt;chr&gt;  &lt;chr&gt;
 1 EWR    IAH  
 2 LGA    IAH  
 3 JFK    MIA  
 4 JFK    BQN  
 5 LGA    ATL  
 6 EWR    ORD  
 7 EWR    FLL  
 8 LGA    IAD  
 9 JFK    MCO  
10 LGA    ORD  
# ℹ 214 more rows</code></pre>
</div>
</div>
<p>可以看到，如果根据某列或某几列为依据来查找非重复值，那么默认只输出这几列，我们可以通过加入<code>.keep_all = TRUE</code>参数来保留其他列。<code>.</code>表示 <code>.keep_all</code> 是函数的一个参数，而不另一个变量的名称。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-23_46472f891fc73946b0a2ce563776e6b9">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">origin</span>, <span class="va">dest</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 224 × 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 214 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>可以发现所有这些不同的航班都是在 1 月 1 日，这绝非巧合：distinct() 会在数据集中找到唯一值第一次出现的那一行，并舍弃其他行。</p>
<p>如果要得到每种出发地和目的地配对出现的次数，可以将 <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> 换成 <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code>，并可使用 <code>sort = TRUE</code> 参数按出现次数降序排列。<code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code>同样来自<code>dplyr</code>包，用于快速统计一个或多个变量的唯一值的出现次数。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-24_10a5df190f09236c1b8b12db09467fe8">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">origin</span>, <span class="va">dest</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 224 × 3
   origin dest      n
   &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;
 1 JFK    LAX   11262
 2 LGA    ATL   10263
 3 LGA    ORD    8857
 4 JFK    SFO    8204
 5 LGA    CLT    6168
 6 EWR    ORD    6100
 7 JFK    BOS    5898
 8 LGA    MIA    5781
 9 JFK    MCO    5464
10 EWR    BOS    5327
# ℹ 214 more rows</code></pre>
</div>
</div>
</section></section><section id="对列的操作" class="level1" data-number="4"><h1 data-number="4">
<span class="header-section-number">4</span> 对列的操作</h1>
<section id="mutate" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="mutate">
<span class="header-section-number">4.1</span> <code>mutate()</code>
</h2>
<p><img src="images/截屏2024-02-02 17.31.09.png" class="img-fluid" width="199"></p>
<p><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>的作用是根据现有列计算并添加新列。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-25_c990018a1104a914836f45debca186f5">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 计算延误航班在空中停留的时间（gain）以及平均速度（speed，英里/小时）：</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>  <span class="va">flights</span>,</span>
<span>  gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>  speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 21
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 13 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, gain &lt;dbl&gt;, speed &lt;dbl&gt;</code></pre>
</div>
</div>
<p>默认情况下，<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 会在数据集的最右侧添加计算后的新列，因此很难看到这里发生了什么。我们可以使用 <code>.before</code> 参数将变量添加到数据集的左侧：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-26_4475d7d9283d573fe35b026fd885f2a1">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>  <span class="va">flights</span>,</span>
<span>  gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>  speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span>,</span>
<span>  .before <span class="op">=</span> <span class="fl">1</span> <span class="co"># 添加到第一列</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 21
    gain speed  year month   day dep_time sched_dep_time dep_delay arr_time
   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
 1    -9  370.  2013     1     1      517            515         2      830
 2   -16  374.  2013     1     1      533            529         4      850
 3   -31  408.  2013     1     1      542            540         2      923
 4    17  517.  2013     1     1      544            545        -1     1004
 5    19  394.  2013     1     1      554            600        -6      812
 6   -16  288.  2013     1     1      554            558        -4      740
 7   -24  404.  2013     1     1      555            600        -5      913
 8    11  259.  2013     1     1      557            600        -3      709
 9     5  405.  2013     1     1      557            600        -3      838
10   -10  319.  2013     1     1      558            600        -2      753
# ℹ 336,766 more rows
# ℹ 12 more variables: sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,
#   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,
#   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>也可以使用 <code>.after</code> 指定新变量应该在哪个变量后添加，在 <code>.before</code> 和 <code>.after</code> 中，都可以使用变量名和列数两种方法指定新变量出现的位置。例如，我们可以在 “day” 之后添加新变量：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-27_cd540c45efc9822f4ba9149843414e19">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>  <span class="va">flights</span>,</span>
<span>  gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>  speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span>,</span>
<span>  .after <span class="op">=</span> <span class="va">day</span> <span class="co"># 添加到第一列</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 21
    year month   day  gain speed dep_time sched_dep_time dep_delay arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
 1  2013     1     1    -9  370.      517            515         2      830
 2  2013     1     1   -16  374.      533            529         4      850
 3  2013     1     1   -31  408.      542            540         2      923
 4  2013     1     1    17  517.      544            545        -1     1004
 5  2013     1     1    19  394.      554            600        -6      812
 6  2013     1     1   -16  288.      554            558        -4      740
 7  2013     1     1   -24  404.      555            600        -5      913
 8  2013     1     1    11  259.      557            600        -3      709
 9  2013     1     1     5  405.      557            600        -3      838
10  2013     1     1   -10  319.      558            600        -2      753
# ℹ 336,766 more rows
# ℹ 12 more variables: sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,
#   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,
#   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>另外，也可以使用 <code>.keep</code> 参数来控制在计算新变量后哪些变量会被保留:</p>
<ul>
<li><p><code>.keep = "all"</code>：默认。保留所有变量</p></li>
<li><p><code>.keep = "used"</code>：保留用于计算新变量的旧变量。这可以用于检查我们的新变量是否计算正确，因为它和原始变量一起展示。</p></li>
<li><p><code>.keep = "unused"</code>：保留其他不用于计算新变量的旧变量。</p></li>
</ul>
<p>例如，下面的输出将只包含旧变量 “dep_delay”、“arr_delay”、“distance”、“air_time”，以及新变量“gain”、“speed”：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-28_44c5df1cf7c465bec89e07af1018696a">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>  <span class="va">flights</span>,</span>
<span>  gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>  speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span>,</span>
<span>  .keep <span class="op">=</span> <span class="st">"used"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 6
   dep_delay arr_delay air_time distance  gain speed
       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1         2        11      227     1400    -9  370.
 2         4        20      227     1416   -16  374.
 3         2        33      160     1089   -31  408.
 4        -1       -18      183     1576    17  517.
 5        -6       -25      116      762    19  394.
 6        -4        12      150      719   -16  288.
 7        -5        19      158     1065   -24  404.
 8        -3       -14       53      229    11  259.
 9        -3        -8      140      944     5  405.
10        -2         8      138      733   -10  319.
# ℹ 336,766 more rows</code></pre>
</div>
</div>
</section><section id="select" class="level2" data-number="4.2"><h2 data-number="4.2" class="anchored" data-anchor-id="select">
<span class="header-section-number">4.2</span> <code>select()</code>
</h2>
<p><img src="images/截屏2024-02-02 17.30.02.png" class="img-fluid" width="201"></p>
<p>选择并输出某几列。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-29_806aa6be7a345412b87e3b8b18cee5b0">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 根据列名选择某几列</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 3
    year month   day
   &lt;int&gt; &lt;int&gt; &lt;int&gt;
 1  2013     1     1
 2  2013     1     1
 3  2013     1     1
 4  2013     1     1
 5  2013     1     1
 6  2013     1     1
 7  2013     1     1
 8  2013     1     1
 9  2013     1     1
10  2013     1     1
# ℹ 336,766 more rows</code></pre>
</div>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 选择“year”和“day”及其之间的所有列</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">year</span><span class="op">:</span><span class="va">day</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 3
    year month   day
   &lt;int&gt; &lt;int&gt; &lt;int&gt;
 1  2013     1     1
 2  2013     1     1
 3  2013     1     1
 4  2013     1     1
 5  2013     1     1
 6  2013     1     1
 7  2013     1     1
 8  2013     1     1
 9  2013     1     1
10  2013     1     1
# ℹ 336,766 more rows</code></pre>
</div>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 选择不在“year”和“day”及其之间的所有列</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, <span class="op">!</span><span class="va">year</span><span class="op">:</span><span class="va">day</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 16
   dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay carrier
      &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt; &lt;chr&gt;  
 1      517            515         2      830            819        11 UA     
 2      533            529         4      850            830        20 UA     
 3      542            540         2      923            850        33 AA     
 4      544            545        -1     1004           1022       -18 B6     
 5      554            600        -6      812            837       -25 DL     
 6      554            558        -4      740            728        12 UA     
 7      555            600        -5      913            854        19 B6     
 8      557            600        -3      709            723       -14 EV     
 9      557            600        -3      838            846        -8 B6     
10      558            600        -2      753            745         8 AA     
# ℹ 336,766 more rows
# ℹ 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,
#   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 选择所有字符型的列</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.character</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 4
   carrier tailnum origin dest 
   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;
 1 UA      N14228  EWR    IAH  
 2 UA      N24211  LGA    IAH  
 3 AA      N619AA  JFK    MIA  
 4 B6      N804JB  JFK    BQN  
 5 DL      N668DN  LGA    ATL  
 6 UA      N39463  EWR    ORD  
 7 B6      N516JB  EWR    FLL  
 8 EV      N829AS  LGA    IAD  
 9 B6      N593JB  JFK    MCO  
10 AA      N3ALAA  LGA    ORD  
# ℹ 336,766 more rows</code></pre>
</div>
</div>
<p>在select()内有许多经常可以组合使用的函数：</p>
<ul>
<li><p><code>starts_with("abc")</code>: 以特定字符开头的列名.</p></li>
<li><p><code>ends_with("xyz")</code>: 以特定字符结尾的列名.</p></li>
<li><p><code>contains("ijk")</code>: 包含特定字符的列名.</p></li>
<li><p><code>num_range("x", 1:3)</code>: 列名<code>x1</code>,&nbsp;<code>x2</code> 和 <code>x3</code>.</p></li>
</ul>
<p>可以在选择变量的同时使用 <code>=</code> 对这些变量进行重命名。新变量名在 <code>=</code> 的左侧，旧变量名在右侧（<code>new_name = old_name</code>）：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-30_3a9ca9cae0eddbe66b7836f034fdb920">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, tail_num <span class="op">=</span> <span class="va">tailnum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 1
   tail_num
   &lt;chr&gt;   
 1 N14228  
 2 N24211  
 3 N619AA  
 4 N804JB  
 5 N668DN  
 6 N39463  
 7 N516JB  
 8 N829AS  
 9 N593JB  
10 N3ALAA  
# ℹ 336,766 more rows</code></pre>
</div>
</div>
</section><section id="rename" class="level2" data-number="4.3"><h2 data-number="4.3" class="anchored" data-anchor-id="rename">
<span class="header-section-number">4.3</span> <code>rename()</code>
</h2>
<p>重命名列。新变量名在 <code>=</code> 的左侧，旧变量名在右侧。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-31_a5c00510a2e4d0948819ad3115ca0b53">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span></span>
<span>  <span class="va">flights</span>, </span>
<span>  years <span class="op">=</span> <span class="va">year</span>, </span>
<span>  months <span class="op">=</span> <span class="va">month</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
   years months   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt;  &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013      1     1      517            515         2      830            819
 2  2013      1     1      533            529         4      850            830
 3  2013      1     1      542            540         2      923            850
 4  2013      1     1      544            545        -1     1004           1022
 5  2013      1     1      554            600        -6      812            837
 6  2013      1     1      554            558        -4      740            728
 7  2013      1     1      555            600        -5      913            854
 8  2013      1     1      557            600        -3      709            723
 9  2013      1     1      557            600        -3      838            846
10  2013      1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>⚠️和其他<code>dplyr</code>中的函数一样，<code>rename</code>不会对原始数据进行修改，因此需要将<code>rename</code>后的数据重新赋值给新的对象或覆盖原来的对象以应用对变量名的修改。</p>
<p>如果我们有一个提供了重命名依据的字符串向量，那么可以通过<code><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of()</a></code>来基于这个字符串向量对数据集的列进行重命名：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-32_a43c53405eeb6296734f3370e2443800">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  years <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>  months <span class="op">=</span> <span class="st">"month"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
   years months   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt;  &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013      1     1      517            515         2      830            819
 2  2013      1     1      533            529         4      850            830
 3  2013      1     1      542            540         2      923            850
 4  2013      1     1      544            545        -1     1004           1022
 5  2013      1     1      554            600        -6      812            837
 6  2013      1     1      554            558        -4      740            728
 7  2013      1     1      555            600        -5      913            854
 8  2013      1     1      557            600        -3      709            723
 9  2013      1     1      557            600        -3      838            846
10  2013      1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>如果提供重命名依据的字符串向量中有的变量是原数据集中不存在的，那么可以用 <code><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of()</a></code>代替 <code><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of()</a></code> 来实现：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-33_57b9cd0c5fb82b423718cdc97f152fe5">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  years <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>  months <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>  new <span class="op">=</span> <span class="st">"unknown"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
   years months   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt;  &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013      1     1      517            515         2      830            819
 2  2013      1     1      533            529         4      850            830
 3  2013      1     1      542            540         2      923            850
 4  2013      1     1      544            545        -1     1004           1022
 5  2013      1     1      554            600        -6      812            837
 6  2013      1     1      554            558        -4      740            728
 7  2013      1     1      555            600        -5      913            854
 8  2013      1     1      557            600        -3      709            723
 9  2013      1     1      557            600        -3      838            846
10  2013      1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<section id="rename_with" class="level3"><h3 class="anchored" data-anchor-id="rename_with"><code>rename_with()</code></h3>
<p>根据函数批量重命名列。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-34_e4cab28d40f18475283b9485b0fefc33">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 将所有列名变为大写</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">toupper</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
    YEAR MONTH   DAY DEP_TIME SCHED_DEP_TIME DEP_DELAY ARR_TIME SCHED_ARR_TIME
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: ARR_DELAY &lt;dbl&gt;, CARRIER &lt;chr&gt;, FLIGHT &lt;int&gt;,
#   TAILNUM &lt;chr&gt;, ORIGIN &lt;chr&gt;, DEST &lt;chr&gt;, AIR_TIME &lt;dbl&gt;, DISTANCE &lt;dbl&gt;,
#   HOUR &lt;dbl&gt;, MINUTE &lt;dbl&gt;, TIME_HOUR &lt;dttm&gt;</code></pre>
</div>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 将所有以“dep_"开头的列名转换为大写</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">toupper</span>, .cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"dep_"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
    year month   day DEP_TIME sched_dep_time DEP_DELAY arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 将列名中所有的"_"替换成“.”，并将所有列名转换成大写</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span></span>
<span>  <span class="va">flights</span>, </span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"_"</span>, replacement <span class="op">=</span> <span class="st">"."</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
    YEAR MONTH   DAY DEP.TIME SCHED.DEP.TIME DEP.DELAY ARR.TIME SCHED.ARR.TIME
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: ARR.DELAY &lt;dbl&gt;, CARRIER &lt;chr&gt;, FLIGHT &lt;int&gt;,
#   TAILNUM &lt;chr&gt;, ORIGIN &lt;chr&gt;, DEST &lt;chr&gt;, AIR.TIME &lt;dbl&gt;, DISTANCE &lt;dbl&gt;,
#   HOUR &lt;dbl&gt;, MINUTE &lt;dbl&gt;, TIME.HOUR &lt;dttm&gt;</code></pre>
</div>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 匿名函数形式</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span><span class="va">flights</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"_"</span>, replacement <span class="op">=</span> <span class="st">"."</span>, x<span class="op">=</span> <span class="va">.x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
    YEAR MONTH   DAY DEP.TIME SCHED.DEP.TIME DEP.DELAY ARR.TIME SCHED.ARR.TIME
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: ARR.DELAY &lt;dbl&gt;, CARRIER &lt;chr&gt;, FLIGHT &lt;int&gt;,
#   TAILNUM &lt;chr&gt;, ORIGIN &lt;chr&gt;, DEST &lt;chr&gt;, AIR.TIME &lt;dbl&gt;, DISTANCE &lt;dbl&gt;,
#   HOUR &lt;dbl&gt;, MINUTE &lt;dbl&gt;, TIME.HOUR &lt;dttm&gt;</code></pre>
</div>
</div>
</section></section><section id="relocate" class="level2" data-number="4.4"><h2 data-number="4.4" class="anchored" data-anchor-id="relocate">
<span class="header-section-number">4.4</span> <code>relocate()</code>
</h2>
<p>调整列的顺序。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-35_bcfeb5d9460a295277153ba0307d702c">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 将“day”和“year”放到最前面</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">day</span>, <span class="va">year</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
     day  year month dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1     1  2013     1      517            515         2      830            819
 2     1  2013     1      533            529         4      850            830
 3     1  2013     1      542            540         2      923            850
 4     1  2013     1      544            545        -1     1004           1022
 5     1  2013     1      554            600        -6      812            837
 6     1  2013     1      554            558        -4      740            728
 7     1  2013     1      555            600        -5      913            854
 8     1  2013     1      557            600        -3      709            723
 9     1  2013     1      557            600        -3      838            846
10     1  2013     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>也可以和上面的[mutate()]一样通过<code>.before</code>&nbsp;和&nbsp;<code>.after</code>&nbsp;参数指定放置位置：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-36_c42770d6b0eec835374882d8761ba2d0">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 将“year”和“dep_time”及其之间的列放到“sched_dep_time”之后</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">year</span><span class="op">:</span><span class="va">dep_time</span>, .after <span class="op">=</span> <span class="va">sched_dep_time</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
   sched_dep_time  year month   day dep_time dep_delay arr_time sched_arr_time
            &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1            515  2013     1     1      517         2      830            819
 2            529  2013     1     1      533         4      850            830
 3            540  2013     1     1      542         2      923            850
 4            545  2013     1     1      544        -1     1004           1022
 5            600  2013     1     1      554        -6      812            837
 6            558  2013     1     1      554        -4      740            728
 7            600  2013     1     1      555        -5      913            854
 8            600  2013     1     1      557        -3      709            723
 9            600  2013     1     1      557        -3      838            846
10            600  2013     1     1      558        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 将所有以“dep_”开头的列放到“sched_dep_time”之前</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"dep_"</span><span class="op">)</span>, .before <span class="op">=</span> <span class="va">sched_dep_time</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
    year month   day dep_time dep_delay sched_dep_time arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;     &lt;dbl&gt;          &lt;int&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517         2            515      830            819
 2  2013     1     1      533         4            529      850            830
 3  2013     1     1      542         2            540      923            850
 4  2013     1     1      544        -1            545     1004           1022
 5  2013     1     1      554        -6            600      812            837
 6  2013     1     1      554        -4            558      740            728
 7  2013     1     1      555        -5            600      913            854
 8  2013     1     1      557        -3            600      709            723
 9  2013     1     1      557        -3            600      838            846
10  2013     1     1      558        -2            600      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
</section></section><section id="分组统计" class="level1" data-number="5"><h1 data-number="5">
<span class="header-section-number">5</span> 分组统计</h1>
<section id="group_by" class="level2" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="group_by">
<span class="header-section-number">5.1</span> <code>group_by()</code>
</h2>
<p><img src="images/截屏2024-02-02 17.26.52.png" class="img-fluid" width="240"></p>
<p>根据某一列或几列将数据分组，便于后续的分组统计/运算。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-37_0a2121d5b57d056b13b1a6f1404877b1">
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">month</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 19
# Groups:   month [12]
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p><code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>本身不会改变数据，除了在输出结果中出现了<code># Groups: month [12]</code>，提示我们该数据集进行了分组。这意味着随后的操作将按不同的月份分别进行。<code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>向数据添加了这个分组特性（称为类），从而改变了接下来对数据应用的函数的行为。</p>
</section><section id="summarize" class="level2" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="summarize">
<span class="header-section-number">5.2</span> <code>summarize()</code>
</h2>
<p>分组汇总数据。根据某列或某几列的数据汇总一个包含了统计数据的新表。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-38_3b32c1a1c33e1448a69e74e43766625b">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 计算每月的平均起飞延误时间</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 2
   month avg_delay
   &lt;int&gt;     &lt;dbl&gt;
 1     1        NA
 2     2        NA
 3     3        NA
 4     4        NA
 5     5        NA
 6     6        NA
 7     7        NA
 8     8        NA
 9     9        NA
10    10        NA
11    11        NA
12    12        NA</code></pre>
</div>
</div>
<p>可以看到，这里出现了问题，所有的结果都是“NA”。这是因为一些航班在延误时间（dep_delay）列中有缺失数据，所以当我们计算包括这些缺失值的平均值时，得到了一个NA结果。所以需要在mean()中设置参数 <code>na.rm = TRUE</code> 来忽略所有缺失值：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-39_6877b6f6fcb2a689b3a3992a99ede0e8">
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 计算每月的平均起飞延误时间</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 2
   month avg_delay
   &lt;int&gt;     &lt;dbl&gt;
 1     1     10.0 
 2     2     10.8 
 3     3     13.2 
 4     4     13.9 
 5     5     13.0 
 6     6     20.8 
 7     7     21.7 
 8     8     12.6 
 9     9      6.72
10    10      6.24
11    11      5.44
12    12     16.6 </code></pre>
</div>
</div>
<p>可以在单次对summarize()的调用中创建任意数量的数据汇总。但其中一个非常有用的汇总函数是<code><a href="https://dplyr.tidyverse.org/reference/context.html">n()</a></code>，它返回每个组中行数：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-40_10fe22c5da519766a12c3e0cd89f8520">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 计算每月的平均起飞延误时间和延误航班数量</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 3
   month avg_delay     n
   &lt;int&gt;     &lt;dbl&gt; &lt;int&gt;
 1     1     10.0  27004
 2     2     10.8  24951
 3     3     13.2  28834
 4     4     13.9  28330
 5     5     13.0  28796
 6     6     20.8  28243
 7     7     21.7  29425
 8     8     12.6  29327
 9     9      6.72 27574
10    10      6.24 28889
11    11      5.44 27268
12    12     16.6  28135</code></pre>
</div>
</div>
</section><section id="slice_系列函数" class="level2" data-number="5.3"><h2 data-number="5.3" class="anchored" data-anchor-id="slice_系列函数">
<span class="header-section-number">5.3</span> <code>slice_</code>系列函数</h2>
<p>分组提取数据。</p>
<ul>
<li><p><code>df |&gt; slice_head(n = 1)</code>&nbsp;从每一组中取前n行数据.</p></li>
<li><p><code>df |&gt; slice_tail(n = 1)</code>&nbsp;从每一组中取后n行数据.</p></li>
<li><p><code>df |&gt; slice_min(x, n = 1)</code>&nbsp;从每一组中取<code>x</code>列的值最小的n行数据.</p></li>
<li><p><code>df |&gt; slice_max(x, n = 1)</code>&nbsp;从每一组中取<code>x</code>列的值最大的n行数据.</p></li>
<li><p><code>df |&gt; slice_sample(n = 1)</code>&nbsp;从每一组中随机取n行数据.</p></li>
</ul>
<p>其中的<code>n</code>参数指定需要提取的行数，同时，也可以用<code>prop</code>参数指定从每组中提取多少比例的行。例如，<code>prop = 0.1</code> 表示从每组中提取10%的行。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-41_6fa1d6b356613e6ecf9e45fb5630aaea">
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 找出到达每个目的地的延误最严重的航班</span></span>
<span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">arr_delay</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">dest</span>, <span class="va">arr_delay</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/tee.html">%T&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 108 × 19
# Groups:   dest [105]
   dest  arr_delay  year month   day dep_time sched_dep_time dep_delay arr_time
   &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
 1 ABQ         153  2013     7    22     2145           2007        98      132
 2 ACK         221  2013     7    23     1139            800       219     1250
 3 ALB         328  2013     1    25      123           2000       323      229
 4 ANC          39  2013     8    17     1740           1625        75     2042
 5 ATL         895  2013     7    22     2257            759       898      121
 6 AUS         349  2013     7    10     2056           1505       351     2347
 7 AVL         228  2013     8    13     1156            832       204     1417
 8 BDL         266  2013     2    21     1728           1316       252     1839
 9 BGR         238  2013    12     1     1504           1056       248     1628
10 BHM         291  2013     4    10       25           1900       325      136
# ℹ 98 more rows
# ℹ 10 more variables: sched_arr_time &lt;int&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
#   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 108</code></pre>
</div>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 336776</code></pre>
</div>
</div>
<p>上面的例子中，<code><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate()</a></code>函数后用到了分支管道[%T&gt;%]，先通过<code><a href="https://rdrr.io/r/base/print.html">print()</a></code>把分组统计的结果打印出来，然后通过<code><a href="https://rdrr.io/r/base/nrow.html">nrow()</a></code>返回分组统计数据的行数。结果发现有108行，和原来数据的105行不符合，这是因为有的目的地可能有几架次并列延误最严重的航班。例如，第22行和23行的航班信息：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-42_4600e1cbb28bb77ed8fedc3ade23ae81">
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">arr_delay</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">dest</span>, <span class="va">arr_delay</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="va">_</span><span class="op">[</span><span class="fl">22</span><span class="op">:</span><span class="fl">23</span>,<span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 19
# Groups:   dest [1]
  dest  arr_delay  year month   day dep_time sched_dep_time dep_delay arr_time
  &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
1 CHS         331  2013     3     8     1202            751       251     1530
2 CHS         331  2013     9     2     1906           1359       307     2134
# ℹ 10 more variables: sched_arr_time &lt;int&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
#   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
</section><section id="多变量分组统计" class="level2" data-number="5.4"><h2 data-number="5.4" class="anchored" data-anchor-id="多变量分组统计">
<span class="header-section-number">5.4</span> 多变量分组统计</h2>
<p>例如分别统计每个日期（年+月+日）的航班数量：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-43_a83be93f90371f097aa608f842e13847">
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span></span>
<span></span>
<span><span class="va">daily</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 365 × 4
# Groups:   year, month [12]
    year month   day flights
   &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;
 1  2013     1     1     842
 2  2013     1     2     943
 3  2013     1     3     914
 4  2013     1     4     915
 5  2013     1     5     720
 6  2013     1     6     832
 7  2013     1     7     933
 8  2013     1     8     899
 9  2013     1     9     902
10  2013     1    10     932
# ℹ 355 more rows</code></pre>
</div>
</div>
<p>需要注意到结果中的第一行提示我们 <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> 后的数据按照“year”和“month”进行了<code>group</code>处理。这是因为<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> 在处理超过一个分组的数据时，输出的结果默认去除最后一个分组依据。这一行为可以通过设定<code>.groups</code>参数进行修改：</p>
<ul>
<li><p><code>.groups = "drop_last"</code>：默认。<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code>后丢掉最后一个分组依据。</p></li>
<li><p><code>.groups = "drop"</code>：<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code>后取消分组。</p></li>
<li><p><code>.groups = "keep"</code>：<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code>后保留原分组。</p></li>
</ul>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-44_6d5287c7346de66ea1e759bfc433732b">
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"keep"</span></span>
<span>    <span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 365 × 4
# Groups:   year, month, day [365]
    year month   day flights
   &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;
 1  2013     1     1     842
 2  2013     1     2     943
 3  2013     1     3     914
 4  2013     1     4     915
 5  2013     1     5     720
 6  2013     1     6     832
 7  2013     1     7     933
 8  2013     1     8     899
 9  2013     1     9     902
10  2013     1    10     932
# ℹ 355 more rows</code></pre>
</div>
</div>
</section><section id="ungroup" class="level2" data-number="5.5"><h2 data-number="5.5" class="anchored" data-anchor-id="ungroup">
<span class="header-section-number">5.5</span> <code>ungroup()</code>
</h2>
<p>取消分组。</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-45_4fe5036686dbc2df4e391732a7fc58ba">
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  avg_delay flights
      &lt;dbl&gt;   &lt;int&gt;
1      12.6  336776</code></pre>
</div>
</div>
</section><section id="by" class="level2" data-number="5.6"><h2 data-number="5.6" class="anchored" data-anchor-id="by">
<span class="header-section-number">5.6</span> <code>.by</code>
</h2>
<div class="quarto-figure quarto-figure-left">
<figure class="figure"><p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="images/截屏2024-02-02 17.05.04.png" class="img-fluid figure-img" width="147"></a></p>
</figure>
</div>
<p>dplyr从1.1.0版本开始包括了一个新的实验性语法，用于直接在统计函数中指定分组依据，即 <code>.by</code> 参数。<code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup()</a></code> 不会消失，但现在也可以使用 <code>.by</code> 参数来在单个操作中进行分组：</p>
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-46_d916e64191607d58c770b033fdb63552">
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="va">month</span> <span class="co"># 按“month”分组统计</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 3
   month avg_delay flights
   &lt;int&gt;     &lt;dbl&gt;   &lt;int&gt;
 1     1     10.0    27004
 2     2     10.8    24951
 3     3     13.2    28834
 4     4     13.9    28330
 5     5     13.0    28796
 6     6     20.8    28243
 7     7     21.7    29425
 8     8     12.6    29327
 9     9      6.72   27574
10    10      6.24   28889
11    11      5.44   27268
12    12     16.6    28135</code></pre>
</div>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 等价于:</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 3
   month avg_delay flights
   &lt;int&gt;     &lt;dbl&gt;   &lt;int&gt;
 1     1     10.0    27004
 2     2     10.8    24951
 3     3     13.2    28834
 4     4     13.9    28330
 5     5     13.0    28796
 6     6     20.8    28243
 7     7     21.7    29425
 8     8     12.6    29327
 9     9      6.72   27574
10    10      6.24   28889
11    11      5.44   27268
12    12     16.6    28135</code></pre>
</div>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 支持指定多个分组依据</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">dest</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">dest</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 224 × 4
   origin dest  avg_delay flights
   &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt;   &lt;int&gt;
 1 EWR    ALB       23.6      439
 2 EWR    ANC       12.9        8
 3 EWR    ATL       15.5     5022
 4 EWR    AUS       11.5      968
 5 EWR    AVL        8.62     265
 6 EWR    BDL       17.7      443
 7 EWR    BNA       17.7     2336
 8 EWR    BOS       12.5     5327
 9 EWR    BQN       23.9      297
10 EWR    BTV       17.8      931
# ℹ 214 more rows</code></pre>
</div>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 等价于：</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">dest</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    avg_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 224 × 4
   origin dest  avg_delay flights
   &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt;   &lt;int&gt;
 1 EWR    ALB       23.6      439
 2 EWR    ANC       12.9        8
 3 EWR    ATL       15.5     5022
 4 EWR    AUS       11.5      968
 5 EWR    AVL        8.62     265
 6 EWR    BDL       17.7      443
 7 EWR    BNA       17.7     2336
 8 EWR    BOS       12.5     5327
 9 EWR    BQN       23.9      297
10 EWR    BTV       17.8      931
# ℹ 214 more rows</code></pre>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Session Info
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-hash="dplyr_cache/html/unnamed-chunk-47_e870b88a95bb6330876a39d054cd9a4d">
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.2 (2023-10-31)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Sonoma 14.3

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Asia/Shanghai
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] magrittr_2.0.3 dplyr_1.1.4   

loaded via a namespace (and not attached):
 [1] digest_0.6.34     utf8_1.2.4        R6_2.5.1          codetools_0.2-19 
 [5] fastmap_1.1.1     tidyselect_1.2.0  xfun_0.41         glue_1.7.0       
 [9] tibble_3.2.1      knitr_1.45        pkgconfig_2.0.3   htmltools_0.5.7  
[13] generics_0.1.3    rmarkdown_2.25    lifecycle_1.0.4   cli_3.6.2        
[17] fansi_1.0.6       vctrs_0.6.5       withr_3.0.0       compiler_4.3.2   
[21] rstudioapi_0.15.0 tools_4.3.2       pillar_1.9.0      evaluate_0.23    
[25] yaml_2.3.8        rlang_1.1.3       jsonlite_1.8.8    htmlwidgets_1.6.4</code></pre>
</div>
</div>
</div>
</div>
</div>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("https:\/\/djhcod\.github\.io\/r-notes\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script><script src="https://giscus.app/client.js" data-repo="djhcod/r-notes" data-repo-id="R_kgDOKw7GMg" data-category="General" data-category-id="DIC_kwDOKw7GMs4Cbz4B" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../r_basic/basic_data_function.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">数据处理基本函数</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../r_basic/character.html" class="pagination-link">
        <span class="nav-page-text">字符的处理</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb128" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "基于dplyr包的数据处理"</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 参考：</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">*dplyr官方文档*</span><span class="co">](https://dplyr.tidyverse.org/index.html)</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">*Data transformation chapter*</span><span class="co">](https://r4ds.hadley.nz/data-transform)</span><span class="at"> *in R for Data Science*</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/logo-2.png)</span>{width="205"}</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a><span class="fu"># 介绍</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a><span class="in">`dplyr`</span>包是<span class="in">`tidyverse`</span>的核心包之一，为数据处理提供了一系列方便快捷的函数。本章将以<span class="in">`nycflights13`</span>包中的flights案例数据来介绍基于dplyr包的数据处理语法。该数据集包含 2013 年从纽约市起飞的所有 336,776 次航班的信息。</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(flights, <span class="at">package =</span> <span class="st">"nycflights13"</span>)</span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>flights</span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>这里的flights数据是一个 tibble，这是一种升级版的data.frame，被 tidyverse 用来避免一些data.frame的常见问题。Tibbles 和data.frame之间的一个重要的区别在于 tibbles 打印数据的方式：tibbles 是为大型数据集设计的，因此只显示前几行和适应屏幕宽度的列（如上）。可以使用 <span class="in">`print(flights, width = Inf)`</span> 显示所有列，或者使用 <span class="in">`glimpse()`</span>：</span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(flights)</span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a>在这两种视图中，变量名下方或后面都有相应的缩写，代表每个变量的类型：<span class="in">`&lt;int&gt;`</span> 代表整数型数据，<span class="kw">&lt;dbl&gt;</span> 代表数值型数据，<span class="kw">&lt;chr&gt;</span> 代表字符型数据，<span class="kw">&lt;dttm&gt;</span> 代表日期时间型数据。这些变量非常重要，因为对列进行的操作在很大程度上取决于该列的 "类型"。更多关于tibble的说明参考<span class="in">`tibble`</span>包的<span class="co">[</span><span class="ot">官方文档</span><span class="co">](https://tibble.tidyverse.org/index.html)</span>。</span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="al">![](images/logo.png)</span><span class="ot">{width="157"}</span><span class="co">](https://tibble.tidyverse.org/index.html)</span></span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a><span class="in">`dplyr`</span>语法的共同特点：</span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-40"><a href="#cb128-40" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>第一个参数始终是数据集（tibble或data.frame）的名字。</span>
<span id="cb128-41"><a href="#cb128-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-42"><a href="#cb128-42" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>后面的参数通常使用变量名（不带引号）来描述要对哪些列进行操作。</span>
<span id="cb128-43"><a href="#cb128-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-44"><a href="#cb128-44" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>输出总是一个新的tibble或data.frame。</span>
<span id="cb128-45"><a href="#cb128-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-46"><a href="#cb128-46" aria-hidden="true" tabindex="-1"></a><span class="in">`dplyr`</span> 的函数可以根据它们的操作对象分为四类：分别是对行进行操作的函数、对列进行操作的函数、对表进行操作的函数以及分组统计函数，同时还包括一个特殊的管道符号<span class="in">`%&gt;%`</span>。本章将介绍除对表进行操作之外的函数。</span>
<span id="cb128-47"><a href="#cb128-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-48"><a href="#cb128-48" aria-hidden="true" tabindex="-1"></a><span class="fu"># 管道操作符</span></span>
<span id="cb128-49"><a href="#cb128-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-50"><a href="#cb128-50" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 参考：</span><span class="co">[</span><span class="ot">*生信菜鸟团-R tips: R管道的用法*</span><span class="co">](https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512157&amp;idx=1&amp;sn=47466392bd7c54e17c57b232b29b551b&amp;chksm=fa457560cd32fc76da55c346ef08917343322ecb5d24b3b591d9c65549ed1f0ca10f57f1105d&amp;mpshare=1&amp;scene=1&amp;srcid=0407dIwqephXlKmnMrPSvpRb&amp;sharer_sharetime=1680842848403&amp;sharer_shareid=568f49cb24905bf546294e6985a632bf#rd)</span></span>
<span id="cb128-51"><a href="#cb128-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-52"><a href="#cb128-52" aria-hidden="true" tabindex="-1"></a>R中有两种管道操作符（pipe operator)，分别是R自带的来自<span class="in">`base`</span>包的<span class="in">`|&gt;`</span>，和来自<span class="in">`magrittr`</span>**包（上级包是**`dplyr`和`tidyverse`**）**的`%&gt;%`。我们可以将管道操作符理解为车间里的流水线，经过前一步加工的产品才能进入后一步进一步加工，其作用是将上一步的结果直接传参给下一步的函数，从而**省略了中间的赋值步骤**，可以大量**减少中间变量**，节省内存。例如：</span>
<span id="cb128-53"><a href="#cb128-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-56"><a href="#cb128-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-57"><a href="#cb128-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 不使用管道操作服</span></span>
<span id="cb128-58"><a href="#cb128-58" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb128-59"><a href="#cb128-59" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sort</span>(x)</span>
<span id="cb128-60"><a href="#cb128-60" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y)</span>
<span id="cb128-61"><a href="#cb128-61" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-62"><a href="#cb128-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-65"><a href="#cb128-65" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-66"><a href="#cb128-66" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb128-67"><a href="#cb128-67" aria-hidden="true" tabindex="-1"></a><span class="co"># 管道调用</span></span>
<span id="cb128-68"><a href="#cb128-68" aria-hidden="true" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">sort</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb128-69"><a href="#cb128-69" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb128-70"><a href="#cb128-70" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span> <span class="sc">|&gt;</span> <span class="fu">rnorm</span>() <span class="sc">|&gt;</span> <span class="fu">sort</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb128-71"><a href="#cb128-71" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-72"><a href="#cb128-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-73"><a href="#cb128-73" aria-hidden="true" tabindex="-1"></a>如果<span class="in">`x`</span>, <span class="in">`y`</span>并不会被后面的代码用到的话，那么减少这种中间变量的产生是有利于代码的整洁和降低变量冲突的风险的。</span>
<span id="cb128-74"><a href="#cb128-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-75"><a href="#cb128-75" aria-hidden="true" tabindex="-1"></a>如果不使用管道操作，同时要避免产生中间变量的话就需要嵌套代码，而管道操作则通过一种链式调用的方式去写嵌套调用的代码，使代码更清晰和易于理解。比如：</span>
<span id="cb128-76"><a href="#cb128-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-79"><a href="#cb128-79" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-80"><a href="#cb128-80" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb128-81"><a href="#cb128-81" aria-hidden="true" tabindex="-1"></a><span class="co"># 嵌套调用</span></span>
<span id="cb128-82"><a href="#cb128-82" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">sort</span>(<span class="fu">rnorm</span>(<span class="dv">10</span>)))</span>
<span id="cb128-83"><a href="#cb128-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-84"><a href="#cb128-84" aria-hidden="true" tabindex="-1"></a><span class="co"># 管道调用</span></span>
<span id="cb128-85"><a href="#cb128-85" aria-hidden="true" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">sort</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb128-86"><a href="#cb128-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-87"><a href="#cb128-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-88"><a href="#cb128-88" aria-hidden="true" tabindex="-1"></a>很明显管道的调用逻辑要比嵌套调用更加清晰而符合直觉。</span>
<span id="cb128-89"><a href="#cb128-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-90"><a href="#cb128-90" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb128-91"><a href="#cb128-91" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>来自<span class="in">`magrittr`</span>**包**的管道符<span class="in">`%&gt;%`</span>和<span class="in">`base`</span>包的<span class="in">`|&gt;`</span>存在一些语法上的区别，<span class="in">`%&gt;%`</span>的功能更多（见下文）。</span>
<span id="cb128-92"><a href="#cb128-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-93"><a href="#cb128-93" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>在一般使用时，如果不需要<span class="in">`%&gt;%`</span>的高级功能，建议直接用从2021年的R 4.1.0开始原生支持的<span class="in">`|&gt;`</span>作为默认管道符。如果需要用到高级功能，或习惯tidyverse包的数据处理语法，则再考虑使用<span class="in">`%&gt;%`</span>。</span>
<span id="cb128-94"><a href="#cb128-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-95"><a href="#cb128-95" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>RStudio目前通过快捷键<span class="in">`Command`</span>+<span class="in">`Shift`</span>+<span class="in">`M`</span>默认插入的是<span class="in">`%&gt;%`</span>符号，可以通过在设置中勾选如下选项来让该快捷键默认插入<span class="in">`|&gt;`</span>。</span>
<span id="cb128-96"><a href="#cb128-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-97"><a href="#cb128-97" aria-hidden="true" tabindex="-1"></a>    <span class="al">![](images/截屏2024-02-02%2015.41.06.png)</span>{width="573"}</span>
<span id="cb128-98"><a href="#cb128-98" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb128-99"><a href="#cb128-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-100"><a href="#cb128-100" aria-hidden="true" tabindex="-1"></a><span class="fu">## 管道的基本用法</span></span>
<span id="cb128-101"><a href="#cb128-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-102"><a href="#cb128-102" aria-hidden="true" tabindex="-1"></a>管道的用法就是通过管道符<span class="in">`|&gt;`</span>或<span class="in">`%&gt;%`</span>串联起来前后的两个函数调用，先计算管道符号左边的函数调用，然后将其结果自动传递给管道符号右边函数的**第一个参数（默认）**，然后对运行这个函数，正如上面的例子中提到的一样。**如果不想把值传递给第一个参数，则可以用占位符`_`（适用于**`|&gt;`）或**`.`（适用于`%&gt;%`）的形式指定把前面的运算结果传递给哪个参数**。</span>
<span id="cb128-103"><a href="#cb128-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-104"><a href="#cb128-104" aria-hidden="true" tabindex="-1"></a>比如想在mtcars数据集的车名中寻找所有以“M”开头的车名，则可以通过如下方式寻找：</span>
<span id="cb128-105"><a href="#cb128-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-108"><a href="#cb128-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-109"><a href="#cb128-109" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">|&gt;</span> <span class="fu">rownames</span>() <span class="sc">|&gt;</span> <span class="fu">grep</span>(<span class="st">"^M"</span>, <span class="at">x =</span> _)</span>
<span id="cb128-110"><a href="#cb128-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-111"><a href="#cb128-111" aria-hidden="true" tabindex="-1"></a><span class="co">#或用%&gt;%形式</span></span>
<span id="cb128-112"><a href="#cb128-112" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr) <span class="co"># 也可以直接加载dplyr或tidyverse包，便于后续调用其他tidyverse函数</span></span>
<span id="cb128-113"><a href="#cb128-113" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span>  <span class="fu">rownames</span>() <span class="sc">%&gt;%</span>  <span class="fu">grep</span>(<span class="at">pattern =</span> <span class="st">"^M"</span>, <span class="at">x =</span> .)</span>
<span id="cb128-114"><a href="#cb128-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-115"><a href="#cb128-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-116"><a href="#cb128-116" aria-hidden="true" tabindex="-1"></a>解释如下：在<span class="in">`grep`</span>函数那里，由于我们想在车名（这里是行名）中找到符合特定<span class="in">`pattern`</span>的车名位置，因此需要把车名传给<span class="in">`grep`</span>的第二个参数<span class="in">`x`</span>，所以就可以<span class="in">`.`</span>或<span class="in">`_`</span>的形式将前面的值传给<span class="in">`grep`</span>的<span class="in">`x`</span>。</span>
<span id="cb128-117"><a href="#cb128-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-118"><a href="#cb128-118" aria-hidden="true" tabindex="-1"></a>**⚠️注意：传给其他位置的`.`必须是独立的**，不能在一个表达式（函数）中，比如如下情况，我只想寻找前10个车名中以“M”开头的车名位置：</span>
<span id="cb128-119"><a href="#cb128-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-122"><a href="#cb128-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-123"><a href="#cb128-123" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: true</span></span>
<span id="cb128-124"><a href="#cb128-124" aria-hidden="true" tabindex="-1"></a><span class="co"># 错误 ---------------</span></span>
<span id="cb128-125"><a href="#cb128-125" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> rownames <span class="sc">%&gt;%</span> <span class="fu">grep</span>(<span class="st">"^M"</span>, <span class="at">x =</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])</span>
<span id="cb128-126"><a href="#cb128-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-127"><a href="#cb128-127" aria-hidden="true" tabindex="-1"></a><span class="co"># 正确 ---------------</span></span>
<span id="cb128-128"><a href="#cb128-128" aria-hidden="true" tabindex="-1"></a>mtcars[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ] <span class="sc">%&gt;%</span> rownames <span class="sc">%&gt;%</span> <span class="fu">grep</span>(<span class="st">"^M"</span>, <span class="at">x =</span> .)</span>
<span id="cb128-129"><a href="#cb128-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-130"><a href="#cb128-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-131"><a href="#cb128-131" aria-hidden="true" tabindex="-1"></a>上面的错误调用中，传递给<span class="in">`grep`</span>的<span class="in">`x`</span>参数的是一个表达式<span class="in">`.[1:10]`</span>，不是一个单独的<span class="in">`.`</span>了，因此失去了调整前面值的位置的作用，它就等价于如下调用：</span>
<span id="cb128-132"><a href="#cb128-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-135"><a href="#cb128-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-136"><a href="#cb128-136" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb128-137"><a href="#cb128-137" aria-hidden="true" tabindex="-1"></a><span class="co"># 错误  ---------------</span></span>
<span id="cb128-138"><a href="#cb128-138" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> rownames <span class="sc">%&gt;%</span> <span class="fu">grep</span>(<span class="st">"^M"</span>, <span class="at">x =</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])</span>
<span id="cb128-139"><a href="#cb128-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-140"><a href="#cb128-140" aria-hidden="true" tabindex="-1"></a><span class="co"># 等价于 --------------</span></span>
<span id="cb128-141"><a href="#cb128-141" aria-hidden="true" tabindex="-1"></a><span class="co"># 还是把前面的值传递给第一个参数：</span></span>
<span id="cb128-142"><a href="#cb128-142" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> rownames <span class="sc">%&gt;%</span> <span class="fu">grep</span>(., <span class="st">"^M"</span>, <span class="at">x =</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])</span>
<span id="cb128-143"><a href="#cb128-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-144"><a href="#cb128-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-145"><a href="#cb128-145" aria-hidden="true" tabindex="-1"></a><span class="fu">## **管道的进阶用法**</span></span>
<span id="cb128-146"><a href="#cb128-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-147"><a href="#cb128-147" aria-hidden="true" tabindex="-1"></a>我们可以通过“{}”符号包裹后续函数，在“{}”内的代码，可以任意的使用多个占位符<span class="in">`.`</span>去传递管道前的值。还是上面的例子：</span>
<span id="cb128-148"><a href="#cb128-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-151"><a href="#cb128-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-152"><a href="#cb128-152" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb128-153"><a href="#cb128-153" aria-hidden="true" tabindex="-1"></a>mtcars[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ] <span class="sc">%&gt;%</span>  <span class="fu">rownames</span>() <span class="sc">%&gt;%</span>  <span class="fu">grep</span>(<span class="st">"^M"</span>, <span class="at">x =</span> .) <span class="sc">%&gt;%</span> <span class="fu">plot</span>()</span>
<span id="cb128-154"><a href="#cb128-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-155"><a href="#cb128-155" aria-hidden="true" tabindex="-1"></a><span class="co"># 用“{}”的形式 ---------------</span></span>
<span id="cb128-156"><a href="#cb128-156" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> rownames <span class="sc">%&gt;%</span> {<span class="fu">grep</span>(<span class="st">"^M"</span>, <span class="at">x =</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])} <span class="sc">%&gt;%</span> <span class="fu">plot</span>()</span>
<span id="cb128-157"><a href="#cb128-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-158"><a href="#cb128-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-159"><a href="#cb128-159" aria-hidden="true" tabindex="-1"></a>⚠️注意，<span class="in">`|&gt;`</span>不支持“{}”形式：</span>
<span id="cb128-160"><a href="#cb128-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-163"><a href="#cb128-163" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-164"><a href="#cb128-164" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb128-165"><a href="#cb128-165" aria-hidden="true" tabindex="-1"></a><span class="co"># 错误：</span></span>
<span id="cb128-166"><a href="#cb128-166" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">|&gt;</span> <span class="fu">rownames</span>() <span class="sc">|&gt;</span> {<span class="fu">grep</span>(<span class="st">"^M"</span>, <span class="at">x =</span> _[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])}</span>
<span id="cb128-167"><a href="#cb128-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-168"><a href="#cb128-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-169"><a href="#cb128-169" aria-hidden="true" tabindex="-1"></a>这也反映出<span class="in">`base`</span>包<span class="in">`|&gt;`</span>功能的局限性。</span>
<span id="cb128-170"><a href="#cb128-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-171"><a href="#cb128-171" aria-hidden="true" tabindex="-1"></a>本质上“{}”是<span class="in">`magrittr`</span>改写的一个匿名函数，只有唯一的一个参数，也就是<span class="in">`.`</span> ：</span>
<span id="cb128-172"><a href="#cb128-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-175"><a href="#cb128-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-176"><a href="#cb128-176" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb128-177"><a href="#cb128-177" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span>(.) {</span>
<span id="cb128-178"><a href="#cb128-178" aria-hidden="true" tabindex="-1"></a>  <span class="co"># any code</span></span>
<span id="cb128-179"><a href="#cb128-179" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb128-180"><a href="#cb128-180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-181"><a href="#cb128-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-182"><a href="#cb128-182" aria-hidden="true" tabindex="-1"></a>比如想要获取mtcars的前5行前5列，然后更改行名和列名后，再返回这个数据框：</span>
<span id="cb128-183"><a href="#cb128-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-186"><a href="#cb128-186" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-187"><a href="#cb128-187" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="sc">%&gt;%</span></span>
<span id="cb128-188"><a href="#cb128-188" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb128-189"><a href="#cb128-189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(.) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"row"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb128-190"><a href="#cb128-190" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(.) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"col"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb128-191"><a href="#cb128-191" aria-hidden="true" tabindex="-1"></a>    . <span class="co"># &lt;---------- 不要忘了返回这个数据框</span></span>
<span id="cb128-192"><a href="#cb128-192" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-193"><a href="#cb128-193" aria-hidden="true" tabindex="-1"></a>df</span>
<span id="cb128-194"><a href="#cb128-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-195"><a href="#cb128-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-196"><a href="#cb128-196" aria-hidden="true" tabindex="-1"></a>⚠️注意，在整个“{}”包括的语句中，如果再使用管道要注意这时的占位符.代表的是“{}”内的对象。</span>
<span id="cb128-197"><a href="#cb128-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-200"><a href="#cb128-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-201"><a href="#cb128-201" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="sc">%&gt;%</span></span>
<span id="cb128-202"><a href="#cb128-202" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb128-203"><a href="#cb128-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(.) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"row"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb128-204"><a href="#cb128-204" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(.) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"col"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb128-205"><a href="#cb128-205" aria-hidden="true" tabindex="-1"></a>    .[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, ] <span class="sc">%&gt;%</span> <span class="fu">cbind</span>(., .) <span class="co"># cbind里面的.不指代{}外面的值</span></span>
<span id="cb128-206"><a href="#cb128-206" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-207"><a href="#cb128-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-208"><a href="#cb128-208" aria-hidden="true" tabindex="-1"></a><span class="co"># 等价：</span></span>
<span id="cb128-209"><a href="#cb128-209" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="sc">%&gt;%</span></span>
<span id="cb128-210"><a href="#cb128-210" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb128-211"><a href="#cb128-211" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(.) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"row"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb128-212"><a href="#cb128-212" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(.) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"col"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb128-213"><a href="#cb128-213" aria-hidden="true" tabindex="-1"></a>    .</span>
<span id="cb128-214"><a href="#cb128-214" aria-hidden="true" tabindex="-1"></a>  } <span class="sc">%&gt;%</span> </span>
<span id="cb128-215"><a href="#cb128-215" aria-hidden="true" tabindex="-1"></a>  .[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, ] <span class="sc">%&gt;%</span> </span>
<span id="cb128-216"><a href="#cb128-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(., .)</span>
<span id="cb128-217"><a href="#cb128-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-218"><a href="#cb128-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-219"><a href="#cb128-219" aria-hidden="true" tabindex="-1"></a><span class="fu">## 特殊管道符</span></span>
<span id="cb128-220"><a href="#cb128-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-221"><a href="#cb128-221" aria-hidden="true" tabindex="-1"></a><span class="in">`magrittr`</span>包内除了<span class="in">`%&gt;%`</span>管道符外，还提供了<span class="in">`%$%`</span>、<span class="in">`%&lt;&gt;%`</span>、<span class="in">`%T&gt;%`</span>、<span class="in">`%!&gt;%`</span>，他们的作用简述如下：</span>
<span id="cb128-222"><a href="#cb128-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-223"><a href="#cb128-223" aria-hidden="true" tabindex="-1"></a><span class="fu">### `%$%`</span></span>
<span id="cb128-224"><a href="#cb128-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-225"><a href="#cb128-225" aria-hidden="true" tabindex="-1"></a>用于传递管道左侧数据的names：</span>
<span id="cb128-226"><a href="#cb128-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-229"><a href="#cb128-229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-230"><a href="#cb128-230" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(mtcars)</span>
<span id="cb128-231"><a href="#cb128-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-232"><a href="#cb128-232" aria-hidden="true" tabindex="-1"></a><span class="co"># mtcars的每个元素都可以被后面的函数所使用</span></span>
<span id="cb128-233"><a href="#cb128-233" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%$%</span> <span class="fu">plot</span>(mpg, cyl)</span>
<span id="cb128-234"><a href="#cb128-234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-235"><a href="#cb128-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-238"><a href="#cb128-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-239"><a href="#cb128-239" aria-hidden="true" tabindex="-1"></a><span class="co"># 等价于</span></span>
<span id="cb128-240"><a href="#cb128-240" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> {<span class="fu">plot</span>(.[,<span class="st">"mpg"</span>], .[, <span class="st">"cyl"</span>])}</span>
<span id="cb128-241"><a href="#cb128-241" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(mtcars<span class="sc">$</span>mpg, mtcars<span class="sc">$</span>cyl)</span>
<span id="cb128-242"><a href="#cb128-242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-243"><a href="#cb128-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-244"><a href="#cb128-244" aria-hidden="true" tabindex="-1"></a><span class="fu">### `%&lt;&gt;%`</span></span>
<span id="cb128-245"><a href="#cb128-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-246"><a href="#cb128-246" aria-hidden="true" tabindex="-1"></a>将管道的结果最终再赋值回最左侧的变量：</span>
<span id="cb128-247"><a href="#cb128-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-250"><a href="#cb128-250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-251"><a href="#cb128-251" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb128-252"><a href="#cb128-252" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb128-253"><a href="#cb128-253" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb128-254"><a href="#cb128-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-255"><a href="#cb128-255" aria-hidden="true" tabindex="-1"></a><span class="co"># x排序后加上10，最后再赋值给x</span></span>
<span id="cb128-256"><a href="#cb128-256" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&lt;&gt;%</span> <span class="fu">sort</span>() <span class="sc">%&gt;%</span> {. <span class="sc">+</span> <span class="dv">10</span>}</span>
<span id="cb128-257"><a href="#cb128-257" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb128-258"><a href="#cb128-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-259"><a href="#cb128-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-262"><a href="#cb128-262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-263"><a href="#cb128-263" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb128-264"><a href="#cb128-264" aria-hidden="true" tabindex="-1"></a><span class="co"># 等价于</span></span>
<span id="cb128-265"><a href="#cb128-265" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">sort</span>() <span class="sc">%&gt;%</span> {. <span class="sc">+</span> <span class="dv">10</span>}</span>
<span id="cb128-266"><a href="#cb128-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-267"><a href="#cb128-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-268"><a href="#cb128-268" aria-hidden="true" tabindex="-1"></a><span class="fu">### `%T&gt;%`</span></span>
<span id="cb128-269"><a href="#cb128-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-270"><a href="#cb128-270" aria-hidden="true" tabindex="-1"></a>分支管道，传入左侧的值并运算后将原始值而不是运算结果传递给后续管道。这在多个管道中间使用<span class="in">`print()`</span>、<span class="in">`plot()`</span>或<span class="in">`summary()`</span>这些函数返回信息时非常有用。</span>
<span id="cb128-271"><a href="#cb128-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-274"><a href="#cb128-274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-275"><a href="#cb128-275" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">%&gt;%</span> <span class="fu">plot</span>() <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># 传递给sum()的是前面所有函数的运算结果，由于plot()不返回任何数值，所以sum()的结果为0</span></span>
<span id="cb128-276"><a href="#cb128-276" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">%T&gt;%</span> <span class="fu">plot</span>() <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># 传递给sum()的是1:5</span></span>
<span id="cb128-277"><a href="#cb128-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-278"><a href="#cb128-278" aria-hidden="true" tabindex="-1"></a><span class="co"># 另一个例子</span></span>
<span id="cb128-279"><a href="#cb128-279" aria-hidden="true" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="dv">200</span>) <span class="sc">%&gt;%</span></span>
<span id="cb128-280"><a href="#cb128-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">%T&gt;%</span></span>
<span id="cb128-281"><a href="#cb128-281" aria-hidden="true" tabindex="-1"></a>  plot <span class="sc">%&gt;%</span> </span>
<span id="cb128-282"><a href="#cb128-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colSums</span>() <span class="co"># 传递给colSums()的是“rnorm(200) %&gt;% matrix(ncol = 2)”</span></span>
<span id="cb128-283"><a href="#cb128-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-284"><a href="#cb128-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-285"><a href="#cb128-285" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb128-286"><a href="#cb128-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-287"><a href="#cb128-287" aria-hidden="true" tabindex="-1"></a><span class="fu"># 对行的操作</span></span>
<span id="cb128-288"><a href="#cb128-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-289"><a href="#cb128-289" aria-hidden="true" tabindex="-1"></a><span class="fu">## `filter()`</span></span>
<span id="cb128-290"><a href="#cb128-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-291"><a href="#cb128-291" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/截屏2024-02-02%2017.29.00.png)</span>{width="173"}</span>
<span id="cb128-292"><a href="#cb128-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-293"><a href="#cb128-293" aria-hidden="true" tabindex="-1"></a>用于提取满足某（些）条件的行，基本等同于<span class="co">[</span><span class="ot">`subset()`</span><span class="co">](/r_basic/basic_data_function.qmd#sec-筛选数据)</span>。</span>
<span id="cb128-294"><a href="#cb128-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-297"><a href="#cb128-297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-298"><a href="#cb128-298" aria-hidden="true" tabindex="-1"></a><span class="co"># 查找所有晚点 120 分钟（两小时）以上起飞的航班：</span></span>
<span id="cb128-299"><a href="#cb128-299" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(flights, dep_delay <span class="sc">&gt;</span> <span class="dv">120</span>)</span>
<span id="cb128-300"><a href="#cb128-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-301"><a href="#cb128-301" aria-hidden="true" tabindex="-1"></a><span class="co"># 查找一月或二月起飞的航班</span></span>
<span id="cb128-302"><a href="#cb128-302" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(flights, month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb128-303"><a href="#cb128-303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-304"><a href="#cb128-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-305"><a href="#cb128-305" aria-hidden="true" tabindex="-1"></a><span class="fu">## `arrange()`</span></span>
<span id="cb128-306"><a href="#cb128-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-307"><a href="#cb128-307" aria-hidden="true" tabindex="-1"></a>排序，以某列为依据对行进行排序（在前面的数据<span class="co">[</span><span class="ot">处理基本函数</span><span class="co">](/r_basic/basic_data_function.qmd#sec-排序)</span>一章中已涉及该函数）。对应的功能在<span class="in">`base`</span>包中是<span class="in">`order()`</span>函数。如果提供的列名不止一个，则依次根据提供的列的顺序对数据进行排序。例如，下面的代码按航班出发时间排序，出发时间分布在四列中。我们首先得到最早的年份，然后在一年内得到最早的月份，依此类推。</span>
<span id="cb128-308"><a href="#cb128-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-311"><a href="#cb128-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-312"><a href="#cb128-312" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(flights, year, month, day, dep_time)</span>
<span id="cb128-313"><a href="#cb128-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-314"><a href="#cb128-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-315"><a href="#cb128-315" aria-hidden="true" tabindex="-1"></a>可以加上<span class="in">`desc()`</span>实现降序排列：</span>
<span id="cb128-316"><a href="#cb128-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-319"><a href="#cb128-319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-320"><a href="#cb128-320" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(flights, <span class="fu">desc</span>(dep_delay))</span>
<span id="cb128-321"><a href="#cb128-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-322"><a href="#cb128-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-323"><a href="#cb128-323" aria-hidden="true" tabindex="-1"></a><span class="fu">## `distinct()`</span></span>
<span id="cb128-324"><a href="#cb128-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-325"><a href="#cb128-325" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/截屏2024-02-02%2017.29.29.png)</span>{width="212"}</span>
<span id="cb128-326"><a href="#cb128-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-327"><a href="#cb128-327" aria-hidden="true" tabindex="-1"></a>查找数据集中所有唯一的行。</span>
<span id="cb128-328"><a href="#cb128-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-331"><a href="#cb128-331" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-332"><a href="#cb128-332" aria-hidden="true" tabindex="-1"></a><span class="co"># 移除所有完全相同的行</span></span>
<span id="cb128-333"><a href="#cb128-333" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(flights)</span>
<span id="cb128-334"><a href="#cb128-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-335"><a href="#cb128-335" aria-hidden="true" tabindex="-1"></a><span class="co"># 查找所有唯一的出发地和目的地配对</span></span>
<span id="cb128-336"><a href="#cb128-336" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(flights, origin, dest)</span>
<span id="cb128-337"><a href="#cb128-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-338"><a href="#cb128-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-339"><a href="#cb128-339" aria-hidden="true" tabindex="-1"></a>可以看到，如果根据某列或某几列为依据来查找非重复值，那么默认只输出这几列，我们可以通过加入<span class="in">`.keep_all = TRUE`</span>参数来保留其他列。<span class="in">`.`</span>表示 <span class="in">`.keep_all`</span> 是函数的一个参数，而不另一个变量的名称。</span>
<span id="cb128-340"><a href="#cb128-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-343"><a href="#cb128-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-344"><a href="#cb128-344" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(flights, origin, dest, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb128-345"><a href="#cb128-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-346"><a href="#cb128-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-347"><a href="#cb128-347" aria-hidden="true" tabindex="-1"></a>可以发现所有这些不同的航班都是在 1 月 1 日，这绝非巧合：distinct() 会在数据集中找到唯一值第一次出现的那一行，并舍弃其他行。</span>
<span id="cb128-348"><a href="#cb128-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-349"><a href="#cb128-349" aria-hidden="true" tabindex="-1"></a>如果要得到每种出发地和目的地配对出现的次数，可以将 <span class="in">`distinct()`</span> 换成 <span class="in">`count()`</span>，并可使用 <span class="in">`sort = TRUE`</span> 参数按出现次数降序排列。<span class="in">`count()`</span>同样来自<span class="in">`dplyr`</span>包，用于快速统计一个或多个变量的唯一值的出现次数。</span>
<span id="cb128-350"><a href="#cb128-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-353"><a href="#cb128-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-354"><a href="#cb128-354" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(flights, origin, dest, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span>
<span id="cb128-355"><a href="#cb128-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-356"><a href="#cb128-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-357"><a href="#cb128-357" aria-hidden="true" tabindex="-1"></a><span class="fu"># 对列的操作</span></span>
<span id="cb128-358"><a href="#cb128-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-359"><a href="#cb128-359" aria-hidden="true" tabindex="-1"></a><span class="fu">## `mutate()`</span></span>
<span id="cb128-360"><a href="#cb128-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-361"><a href="#cb128-361" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/截屏2024-02-02%2017.31.09.png)</span>{width="199"}</span>
<span id="cb128-362"><a href="#cb128-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-363"><a href="#cb128-363" aria-hidden="true" tabindex="-1"></a><span class="in">`mutate()`</span>的作用是根据现有列计算并添加新列。</span>
<span id="cb128-364"><a href="#cb128-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-367"><a href="#cb128-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-368"><a href="#cb128-368" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算延误航班在空中停留的时间（gain）以及平均速度（speed，英里/小时）：</span></span>
<span id="cb128-369"><a href="#cb128-369" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb128-370"><a href="#cb128-370" aria-hidden="true" tabindex="-1"></a>  flights,</span>
<span id="cb128-371"><a href="#cb128-371" aria-hidden="true" tabindex="-1"></a>  <span class="at">gain =</span> dep_delay <span class="sc">-</span> arr_delay,</span>
<span id="cb128-372"><a href="#cb128-372" aria-hidden="true" tabindex="-1"></a>  <span class="at">speed =</span> distance <span class="sc">/</span> air_time <span class="sc">*</span> <span class="dv">60</span></span>
<span id="cb128-373"><a href="#cb128-373" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb128-374"><a href="#cb128-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-375"><a href="#cb128-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-376"><a href="#cb128-376" aria-hidden="true" tabindex="-1"></a>默认情况下，<span class="in">`mutate()`</span> 会在数据集的最右侧添加计算后的新列，因此很难看到这里发生了什么。我们可以使用 <span class="in">`.before`</span> 参数将变量添加到数据集的左侧：</span>
<span id="cb128-377"><a href="#cb128-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-380"><a href="#cb128-380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-381"><a href="#cb128-381" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb128-382"><a href="#cb128-382" aria-hidden="true" tabindex="-1"></a>  flights,</span>
<span id="cb128-383"><a href="#cb128-383" aria-hidden="true" tabindex="-1"></a>  <span class="at">gain =</span> dep_delay <span class="sc">-</span> arr_delay,</span>
<span id="cb128-384"><a href="#cb128-384" aria-hidden="true" tabindex="-1"></a>  <span class="at">speed =</span> distance <span class="sc">/</span> air_time <span class="sc">*</span> <span class="dv">60</span>,</span>
<span id="cb128-385"><a href="#cb128-385" aria-hidden="true" tabindex="-1"></a>  <span class="at">.before =</span> <span class="dv">1</span> <span class="co"># 添加到第一列</span></span>
<span id="cb128-386"><a href="#cb128-386" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb128-387"><a href="#cb128-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-388"><a href="#cb128-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-389"><a href="#cb128-389" aria-hidden="true" tabindex="-1"></a>也可以使用 <span class="in">`.after`</span> 指定新变量应该在哪个变量后添加，在 <span class="in">`.before`</span> 和 <span class="in">`.after`</span> 中，都可以使用变量名和列数两种方法指定新变量出现的位置。例如，我们可以在 “day” 之后添加新变量：</span>
<span id="cb128-390"><a href="#cb128-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-393"><a href="#cb128-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-394"><a href="#cb128-394" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb128-395"><a href="#cb128-395" aria-hidden="true" tabindex="-1"></a>  flights,</span>
<span id="cb128-396"><a href="#cb128-396" aria-hidden="true" tabindex="-1"></a>  <span class="at">gain =</span> dep_delay <span class="sc">-</span> arr_delay,</span>
<span id="cb128-397"><a href="#cb128-397" aria-hidden="true" tabindex="-1"></a>  <span class="at">speed =</span> distance <span class="sc">/</span> air_time <span class="sc">*</span> <span class="dv">60</span>,</span>
<span id="cb128-398"><a href="#cb128-398" aria-hidden="true" tabindex="-1"></a>  <span class="at">.after =</span> day <span class="co"># 添加到第一列</span></span>
<span id="cb128-399"><a href="#cb128-399" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb128-400"><a href="#cb128-400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-401"><a href="#cb128-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-402"><a href="#cb128-402" aria-hidden="true" tabindex="-1"></a>另外，也可以使用 <span class="in">`.keep`</span> 参数来控制在计算新变量后哪些变量会被保留:</span>
<span id="cb128-403"><a href="#cb128-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-404"><a href="#cb128-404" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`.keep = "all"`</span>：默认。保留所有变量</span>
<span id="cb128-405"><a href="#cb128-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-406"><a href="#cb128-406" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`.keep = "used"`</span>：保留用于计算新变量的旧变量。这可以用于检查我们的新变量是否计算正确，因为它和原始变量一起展示。</span>
<span id="cb128-407"><a href="#cb128-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-408"><a href="#cb128-408" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`.keep = "unused"`</span>：保留其他不用于计算新变量的旧变量。</span>
<span id="cb128-409"><a href="#cb128-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-410"><a href="#cb128-410" aria-hidden="true" tabindex="-1"></a>例如，下面的输出将只包含旧变量 “dep_delay”、“arr_delay”、“distance”、“air_time”，以及新变量“gain”、“speed”：</span>
<span id="cb128-411"><a href="#cb128-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-414"><a href="#cb128-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-415"><a href="#cb128-415" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb128-416"><a href="#cb128-416" aria-hidden="true" tabindex="-1"></a>  flights,</span>
<span id="cb128-417"><a href="#cb128-417" aria-hidden="true" tabindex="-1"></a>  <span class="at">gain =</span> dep_delay <span class="sc">-</span> arr_delay,</span>
<span id="cb128-418"><a href="#cb128-418" aria-hidden="true" tabindex="-1"></a>  <span class="at">speed =</span> distance <span class="sc">/</span> air_time <span class="sc">*</span> <span class="dv">60</span>,</span>
<span id="cb128-419"><a href="#cb128-419" aria-hidden="true" tabindex="-1"></a>  <span class="at">.keep =</span> <span class="st">"used"</span></span>
<span id="cb128-420"><a href="#cb128-420" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb128-421"><a href="#cb128-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-422"><a href="#cb128-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-423"><a href="#cb128-423" aria-hidden="true" tabindex="-1"></a><span class="fu">## `select()`</span></span>
<span id="cb128-424"><a href="#cb128-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-425"><a href="#cb128-425" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/截屏2024-02-02%2017.30.02.png)</span>{width="201"}</span>
<span id="cb128-426"><a href="#cb128-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-427"><a href="#cb128-427" aria-hidden="true" tabindex="-1"></a>选择并输出某几列。</span>
<span id="cb128-428"><a href="#cb128-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-431"><a href="#cb128-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-432"><a href="#cb128-432" aria-hidden="true" tabindex="-1"></a><span class="co"># 根据列名选择某几列</span></span>
<span id="cb128-433"><a href="#cb128-433" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(flights, year, month, day)</span>
<span id="cb128-434"><a href="#cb128-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-435"><a href="#cb128-435" aria-hidden="true" tabindex="-1"></a><span class="co"># 选择“year”和“day”及其之间的所有列</span></span>
<span id="cb128-436"><a href="#cb128-436" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(flights, year<span class="sc">:</span>day)</span>
<span id="cb128-437"><a href="#cb128-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-438"><a href="#cb128-438" aria-hidden="true" tabindex="-1"></a><span class="co"># 选择不在“year”和“day”及其之间的所有列</span></span>
<span id="cb128-439"><a href="#cb128-439" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(flights, <span class="sc">!</span>year<span class="sc">:</span>day)</span>
<span id="cb128-440"><a href="#cb128-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-441"><a href="#cb128-441" aria-hidden="true" tabindex="-1"></a><span class="co"># 选择所有字符型的列</span></span>
<span id="cb128-442"><a href="#cb128-442" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(flights, <span class="fu">where</span>(is.character))</span>
<span id="cb128-443"><a href="#cb128-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-444"><a href="#cb128-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-445"><a href="#cb128-445" aria-hidden="true" tabindex="-1"></a>在select()内有许多经常可以组合使用的函数：</span>
<span id="cb128-446"><a href="#cb128-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-447"><a href="#cb128-447" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`starts_with("abc")`</span>: 以特定字符开头的列名.</span>
<span id="cb128-448"><a href="#cb128-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-449"><a href="#cb128-449" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`ends_with("xyz")`</span>: 以特定字符结尾的列名.</span>
<span id="cb128-450"><a href="#cb128-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-451"><a href="#cb128-451" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`contains("ijk")`</span>: 包含特定字符的列名.</span>
<span id="cb128-452"><a href="#cb128-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-453"><a href="#cb128-453" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`num_range("x", 1:3)`</span>: 列名<span class="in">`x1`</span>,&nbsp;<span class="in">`x2`</span> 和 <span class="in">`x3`</span>.</span>
<span id="cb128-454"><a href="#cb128-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-455"><a href="#cb128-455" aria-hidden="true" tabindex="-1"></a>可以在选择变量的同时使用 <span class="in">`=`</span> 对这些变量进行重命名。新变量名在 <span class="in">`=`</span> 的左侧，旧变量名在右侧（<span class="in">`new_name = old_name`</span>）：</span>
<span id="cb128-456"><a href="#cb128-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-459"><a href="#cb128-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-460"><a href="#cb128-460" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(flights, <span class="at">tail_num =</span> tailnum)</span>
<span id="cb128-461"><a href="#cb128-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-462"><a href="#cb128-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-463"><a href="#cb128-463" aria-hidden="true" tabindex="-1"></a><span class="fu">## `rename()`</span></span>
<span id="cb128-464"><a href="#cb128-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-465"><a href="#cb128-465" aria-hidden="true" tabindex="-1"></a>重命名列。新变量名在 <span class="in">`=`</span> 的左侧，旧变量名在右侧。</span>
<span id="cb128-466"><a href="#cb128-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-469"><a href="#cb128-469" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-470"><a href="#cb128-470" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(</span>
<span id="cb128-471"><a href="#cb128-471" aria-hidden="true" tabindex="-1"></a>  flights, </span>
<span id="cb128-472"><a href="#cb128-472" aria-hidden="true" tabindex="-1"></a>  <span class="at">years =</span> year, </span>
<span id="cb128-473"><a href="#cb128-473" aria-hidden="true" tabindex="-1"></a>  <span class="at">months =</span> month</span>
<span id="cb128-474"><a href="#cb128-474" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb128-475"><a href="#cb128-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-476"><a href="#cb128-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-477"><a href="#cb128-477" aria-hidden="true" tabindex="-1"></a>⚠️和其他<span class="in">`dplyr`</span>中的函数一样，<span class="in">`rename`</span>不会对原始数据进行修改，因此需要将<span class="in">`rename`</span>后的数据重新赋值给新的对象或覆盖原来的对象以应用对变量名的修改。</span>
<span id="cb128-478"><a href="#cb128-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-479"><a href="#cb128-479" aria-hidden="true" tabindex="-1"></a>如果我们有一个提供了重命名依据的字符串向量，那么可以通过<span class="in">`all_of()`</span>来基于这个字符串向量对数据集的列进行重命名：</span>
<span id="cb128-480"><a href="#cb128-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-483"><a href="#cb128-483" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-484"><a href="#cb128-484" aria-hidden="true" tabindex="-1"></a>lookup <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb128-485"><a href="#cb128-485" aria-hidden="true" tabindex="-1"></a>  <span class="at">years =</span> <span class="st">"year"</span>, </span>
<span id="cb128-486"><a href="#cb128-486" aria-hidden="true" tabindex="-1"></a>  <span class="at">months =</span> <span class="st">"month"</span></span>
<span id="cb128-487"><a href="#cb128-487" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb128-488"><a href="#cb128-488" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(flights, <span class="fu">all_of</span>(lookup))</span>
<span id="cb128-489"><a href="#cb128-489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-490"><a href="#cb128-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-491"><a href="#cb128-491" aria-hidden="true" tabindex="-1"></a>如果提供重命名依据的字符串向量中有的变量是原数据集中不存在的，那么可以用 <span class="in">`any_of()`</span>代替 <span class="in">`all_of()`</span> 来实现：</span>
<span id="cb128-492"><a href="#cb128-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-495"><a href="#cb128-495" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-496"><a href="#cb128-496" aria-hidden="true" tabindex="-1"></a>lookup <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb128-497"><a href="#cb128-497" aria-hidden="true" tabindex="-1"></a>  <span class="at">years =</span> <span class="st">"year"</span>, </span>
<span id="cb128-498"><a href="#cb128-498" aria-hidden="true" tabindex="-1"></a>  <span class="at">months =</span> <span class="st">"month"</span>,</span>
<span id="cb128-499"><a href="#cb128-499" aria-hidden="true" tabindex="-1"></a>  <span class="at">new =</span> <span class="st">"unknown"</span></span>
<span id="cb128-500"><a href="#cb128-500" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb128-501"><a href="#cb128-501" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(flights, <span class="fu">any_of</span>(lookup))</span>
<span id="cb128-502"><a href="#cb128-502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-503"><a href="#cb128-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-504"><a href="#cb128-504" aria-hidden="true" tabindex="-1"></a><span class="fu">### `rename_with()`</span></span>
<span id="cb128-505"><a href="#cb128-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-506"><a href="#cb128-506" aria-hidden="true" tabindex="-1"></a>根据函数批量重命名列。</span>
<span id="cb128-507"><a href="#cb128-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-510"><a href="#cb128-510" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-511"><a href="#cb128-511" aria-hidden="true" tabindex="-1"></a><span class="co"># 将所有列名变为大写</span></span>
<span id="cb128-512"><a href="#cb128-512" aria-hidden="true" tabindex="-1"></a><span class="fu">rename_with</span>(flights, toupper)</span>
<span id="cb128-513"><a href="#cb128-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-514"><a href="#cb128-514" aria-hidden="true" tabindex="-1"></a><span class="co"># 将所有以“dep_"开头的列名转换为大写</span></span>
<span id="cb128-515"><a href="#cb128-515" aria-hidden="true" tabindex="-1"></a><span class="fu">rename_with</span>(flights, toupper, <span class="at">.cols =</span> <span class="fu">starts_with</span>(<span class="st">"dep_"</span>))</span>
<span id="cb128-516"><a href="#cb128-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-517"><a href="#cb128-517" aria-hidden="true" tabindex="-1"></a><span class="co"># 将列名中所有的"_"替换成“.”，并将所有列名转换成大写</span></span>
<span id="cb128-518"><a href="#cb128-518" aria-hidden="true" tabindex="-1"></a><span class="fu">rename_with</span>(</span>
<span id="cb128-519"><a href="#cb128-519" aria-hidden="true" tabindex="-1"></a>  flights, </span>
<span id="cb128-520"><a href="#cb128-520" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) {</span>
<span id="cb128-521"><a href="#cb128-521" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gsub</span>(<span class="at">pattern =</span> <span class="st">"_"</span>, <span class="at">replacement =</span> <span class="st">"."</span>, <span class="at">x =</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb128-522"><a href="#cb128-522" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toupper</span>()</span>
<span id="cb128-523"><a href="#cb128-523" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb128-524"><a href="#cb128-524" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb128-525"><a href="#cb128-525" aria-hidden="true" tabindex="-1"></a><span class="co"># 匿名函数形式</span></span>
<span id="cb128-526"><a href="#cb128-526" aria-hidden="true" tabindex="-1"></a><span class="fu">rename_with</span>(flights, <span class="sc">~</span> <span class="fu">gsub</span>(<span class="at">pattern =</span> <span class="st">"_"</span>, <span class="at">replacement =</span> <span class="st">"."</span>, <span class="at">x=</span> .x) <span class="sc">%&gt;%</span> <span class="fu">toupper</span>())</span>
<span id="cb128-527"><a href="#cb128-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-528"><a href="#cb128-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-529"><a href="#cb128-529" aria-hidden="true" tabindex="-1"></a><span class="fu">## `relocate()`</span></span>
<span id="cb128-530"><a href="#cb128-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-531"><a href="#cb128-531" aria-hidden="true" tabindex="-1"></a>调整列的顺序。</span>
<span id="cb128-532"><a href="#cb128-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-535"><a href="#cb128-535" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-536"><a href="#cb128-536" aria-hidden="true" tabindex="-1"></a><span class="co"># 将“day”和“year”放到最前面</span></span>
<span id="cb128-537"><a href="#cb128-537" aria-hidden="true" tabindex="-1"></a><span class="fu">relocate</span>(flights, day, year)</span>
<span id="cb128-538"><a href="#cb128-538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-539"><a href="#cb128-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-540"><a href="#cb128-540" aria-hidden="true" tabindex="-1"></a>也可以和上面的<span class="sc">\[</span>mutate()<span class="sc">\]</span>一样通过<span class="in">`.before`</span>&nbsp;和&nbsp;<span class="in">`.after`</span>&nbsp;参数指定放置位置：</span>
<span id="cb128-541"><a href="#cb128-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-544"><a href="#cb128-544" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-545"><a href="#cb128-545" aria-hidden="true" tabindex="-1"></a><span class="co"># 将“year”和“dep_time”及其之间的列放到“sched_dep_time”之后</span></span>
<span id="cb128-546"><a href="#cb128-546" aria-hidden="true" tabindex="-1"></a><span class="fu">relocate</span>(flights, year<span class="sc">:</span>dep_time, <span class="at">.after =</span> sched_dep_time)</span>
<span id="cb128-547"><a href="#cb128-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-548"><a href="#cb128-548" aria-hidden="true" tabindex="-1"></a><span class="co"># 将所有以“dep_”开头的列放到“sched_dep_time”之前</span></span>
<span id="cb128-549"><a href="#cb128-549" aria-hidden="true" tabindex="-1"></a><span class="fu">relocate</span>(flights, <span class="fu">starts_with</span>(<span class="st">"dep_"</span>), <span class="at">.before =</span> sched_dep_time)</span>
<span id="cb128-550"><a href="#cb128-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-551"><a href="#cb128-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-552"><a href="#cb128-552" aria-hidden="true" tabindex="-1"></a><span class="fu"># 分组统计</span></span>
<span id="cb128-553"><a href="#cb128-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-554"><a href="#cb128-554" aria-hidden="true" tabindex="-1"></a><span class="fu">## `group_by()`</span></span>
<span id="cb128-555"><a href="#cb128-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-556"><a href="#cb128-556" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/截屏2024-02-02%2017.26.52.png)</span>{width="240"}</span>
<span id="cb128-557"><a href="#cb128-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-558"><a href="#cb128-558" aria-hidden="true" tabindex="-1"></a>根据某一列或几列将数据分组，便于后续的分组统计/运算。</span>
<span id="cb128-559"><a href="#cb128-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-562"><a href="#cb128-562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-563"><a href="#cb128-563" aria-hidden="true" tabindex="-1"></a><span class="fu">group_by</span>(flights, month)</span>
<span id="cb128-564"><a href="#cb128-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-565"><a href="#cb128-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-566"><a href="#cb128-566" aria-hidden="true" tabindex="-1"></a><span class="in">`group_by()`</span>本身不会改变数据，除了在输出结果中出现了<span class="in">`# Groups: month [12]`</span>，提示我们该数据集进行了分组。这意味着随后的操作将按不同的月份分别进行。<span class="in">`group_by()`</span>向数据添加了这个分组特性（称为类），从而改变了接下来对数据应用的函数的行为。</span>
<span id="cb128-567"><a href="#cb128-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-568"><a href="#cb128-568" aria-hidden="true" tabindex="-1"></a><span class="fu">## `summarize()`</span></span>
<span id="cb128-569"><a href="#cb128-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-570"><a href="#cb128-570" aria-hidden="true" tabindex="-1"></a>分组汇总数据。根据某列或某几列的数据汇总一个包含了统计数据的新表。</span>
<span id="cb128-571"><a href="#cb128-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-574"><a href="#cb128-574" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-575"><a href="#cb128-575" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算每月的平均起飞延误时间</span></span>
<span id="cb128-576"><a href="#cb128-576" aria-hidden="true" tabindex="-1"></a><span class="fu">group_by</span>(flights, month) <span class="sc">|&gt;</span> </span>
<span id="cb128-577"><a href="#cb128-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg_delay =</span> <span class="fu">mean</span>(dep_delay))</span>
<span id="cb128-578"><a href="#cb128-578" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-579"><a href="#cb128-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-580"><a href="#cb128-580" aria-hidden="true" tabindex="-1"></a>可以看到，这里出现了问题，所有的结果都是“NA”。这是因为一些航班在延误时间（dep_delay）列中有缺失数据，所以当我们计算包括这些缺失值的平均值时，得到了一个NA结果。所以需要在mean()中设置参数 <span class="in">`na.rm = TRUE`</span> 来忽略所有缺失值：</span>
<span id="cb128-581"><a href="#cb128-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-584"><a href="#cb128-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-585"><a href="#cb128-585" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算每月的平均起飞延误时间</span></span>
<span id="cb128-586"><a href="#cb128-586" aria-hidden="true" tabindex="-1"></a><span class="fu">group_by</span>(flights, month) <span class="sc">|&gt;</span> </span>
<span id="cb128-587"><a href="#cb128-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg_delay =</span> <span class="fu">mean</span>(dep_delay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb128-588"><a href="#cb128-588" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-589"><a href="#cb128-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-590"><a href="#cb128-590" aria-hidden="true" tabindex="-1"></a>可以在单次对summarize()的调用中创建任意数量的数据汇总。但其中一个非常有用的汇总函数是<span class="in">`n()`</span>，它返回每个组中行数：</span>
<span id="cb128-591"><a href="#cb128-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-594"><a href="#cb128-594" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-595"><a href="#cb128-595" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算每月的平均起飞延误时间和延误航班数量</span></span>
<span id="cb128-596"><a href="#cb128-596" aria-hidden="true" tabindex="-1"></a>flights <span class="sc">|&gt;</span> </span>
<span id="cb128-597"><a href="#cb128-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">|&gt;</span> </span>
<span id="cb128-598"><a href="#cb128-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb128-599"><a href="#cb128-599" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_delay =</span> <span class="fu">mean</span>(dep_delay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb128-600"><a href="#cb128-600" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb128-601"><a href="#cb128-601" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb128-602"><a href="#cb128-602" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-603"><a href="#cb128-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-604"><a href="#cb128-604" aria-hidden="true" tabindex="-1"></a><span class="fu">## `slice_`系列函数</span></span>
<span id="cb128-605"><a href="#cb128-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-606"><a href="#cb128-606" aria-hidden="true" tabindex="-1"></a>分组提取数据。</span>
<span id="cb128-607"><a href="#cb128-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-608"><a href="#cb128-608" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`df |&gt; slice_head(n = 1)`</span>&nbsp;从每一组中取前n行数据.</span>
<span id="cb128-609"><a href="#cb128-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-610"><a href="#cb128-610" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`df |&gt; slice_tail(n = 1)`</span>&nbsp;从每一组中取后n行数据.</span>
<span id="cb128-611"><a href="#cb128-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-612"><a href="#cb128-612" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`df |&gt; slice_min(x, n = 1)`</span>&nbsp;从每一组中取<span class="in">`x`</span>列的值最小的n行数据.</span>
<span id="cb128-613"><a href="#cb128-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-614"><a href="#cb128-614" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`df |&gt; slice_max(x, n = 1)`</span>&nbsp;从每一组中取<span class="in">`x`</span>列的值最大的n行数据.</span>
<span id="cb128-615"><a href="#cb128-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-616"><a href="#cb128-616" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`df |&gt; slice_sample(n = 1)`</span>&nbsp;从每一组中随机取n行数据.</span>
<span id="cb128-617"><a href="#cb128-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-618"><a href="#cb128-618" aria-hidden="true" tabindex="-1"></a>其中的<span class="in">`n`</span>参数指定需要提取的行数，同时，也可以用<span class="in">`prop`</span>参数指定从每组中提取多少比例的行。例如，<span class="in">`prop = 0.1`</span> 表示从每组中提取10%的行。</span>
<span id="cb128-619"><a href="#cb128-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-622"><a href="#cb128-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-623"><a href="#cb128-623" aria-hidden="true" tabindex="-1"></a><span class="co"># 找出到达每个目的地的延误最严重的航班</span></span>
<span id="cb128-624"><a href="#cb128-624" aria-hidden="true" tabindex="-1"></a>flights <span class="sc">%&gt;%</span></span>
<span id="cb128-625"><a href="#cb128-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dest) <span class="sc">%&gt;%</span> </span>
<span id="cb128-626"><a href="#cb128-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> arr_delay, <span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb128-627"><a href="#cb128-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(dest, arr_delay) <span class="sc">%T&gt;%</span> </span>
<span id="cb128-628"><a href="#cb128-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>() <span class="sc">%&gt;%</span></span>
<span id="cb128-629"><a href="#cb128-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb128-630"><a href="#cb128-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-631"><a href="#cb128-631" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(flights)</span>
<span id="cb128-632"><a href="#cb128-632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-633"><a href="#cb128-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-634"><a href="#cb128-634" aria-hidden="true" tabindex="-1"></a>上面的例子中，<span class="in">`relocate()`</span>函数后用到了分支管道<span class="sc">\[</span>%T<span class="sc">\&gt;</span>%<span class="sc">\]</span>，先通过<span class="in">`print()`</span>把分组统计的结果打印出来，然后通过<span class="in">`nrow()`</span>返回分组统计数据的行数。结果发现有108行，和原来数据的105行不符合，这是因为有的目的地可能有几架次并列延误最严重的航班。例如，第22行和23行的航班信息：</span>
<span id="cb128-635"><a href="#cb128-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-638"><a href="#cb128-638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-639"><a href="#cb128-639" aria-hidden="true" tabindex="-1"></a>flights <span class="sc">|&gt;</span> </span>
<span id="cb128-640"><a href="#cb128-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dest) <span class="sc">|&gt;</span> </span>
<span id="cb128-641"><a href="#cb128-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> arr_delay, <span class="at">n =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb128-642"><a href="#cb128-642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(dest, arr_delay) <span class="sc">|&gt;</span> </span>
<span id="cb128-643"><a href="#cb128-643" aria-hidden="true" tabindex="-1"></a>  _[<span class="dv">22</span><span class="sc">:</span><span class="dv">23</span>,]</span>
<span id="cb128-644"><a href="#cb128-644" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-645"><a href="#cb128-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-646"><a href="#cb128-646" aria-hidden="true" tabindex="-1"></a><span class="fu">## 多变量分组统计</span></span>
<span id="cb128-647"><a href="#cb128-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-648"><a href="#cb128-648" aria-hidden="true" tabindex="-1"></a>例如分别统计每个日期（年+月+日）的航班数量：</span>
<span id="cb128-649"><a href="#cb128-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-652"><a href="#cb128-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-653"><a href="#cb128-653" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span>  </span>
<span id="cb128-654"><a href="#cb128-654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, month, day)</span>
<span id="cb128-655"><a href="#cb128-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-656"><a href="#cb128-656" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">|&gt;</span> </span>
<span id="cb128-657"><a href="#cb128-657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">flights =</span> <span class="fu">n</span>())</span>
<span id="cb128-658"><a href="#cb128-658" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-659"><a href="#cb128-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-660"><a href="#cb128-660" aria-hidden="true" tabindex="-1"></a>需要注意到结果中的第一行提示我们 <span class="in">`summarise()`</span> 后的数据按照“year”和“month”进行了<span class="in">`group`</span>处理。这是因为<span class="in">`summarise()`</span> 在处理超过一个分组的数据时，输出的结果默认去除最后一个分组依据。这一行为可以通过设定<span class="in">`.groups`</span>参数进行修改：</span>
<span id="cb128-661"><a href="#cb128-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-662"><a href="#cb128-662" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`.groups = "drop_last"`</span>：默认。<span class="in">`summarise()`</span>后丢掉最后一个分组依据。</span>
<span id="cb128-663"><a href="#cb128-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-664"><a href="#cb128-664" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`.groups = "drop"`</span>：<span class="in">`summarise()`</span>后取消分组。</span>
<span id="cb128-665"><a href="#cb128-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-666"><a href="#cb128-666" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`.groups = "keep"`</span>：<span class="in">`summarise()`</span>后保留原分组。</span>
<span id="cb128-667"><a href="#cb128-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-670"><a href="#cb128-670" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-671"><a href="#cb128-671" aria-hidden="true" tabindex="-1"></a>flights <span class="sc">|&gt;</span>  </span>
<span id="cb128-672"><a href="#cb128-672" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, month, day) <span class="sc">|&gt;</span> </span>
<span id="cb128-673"><a href="#cb128-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb128-674"><a href="#cb128-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">flights =</span> <span class="fu">n</span>(),</span>
<span id="cb128-675"><a href="#cb128-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"keep"</span></span>
<span id="cb128-676"><a href="#cb128-676" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb128-677"><a href="#cb128-677" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-678"><a href="#cb128-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-679"><a href="#cb128-679" aria-hidden="true" tabindex="-1"></a><span class="fu">## `ungroup()`</span></span>
<span id="cb128-680"><a href="#cb128-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-681"><a href="#cb128-681" aria-hidden="true" tabindex="-1"></a>取消分组。</span>
<span id="cb128-682"><a href="#cb128-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-685"><a href="#cb128-685" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-686"><a href="#cb128-686" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">|&gt;</span> </span>
<span id="cb128-687"><a href="#cb128-687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb128-688"><a href="#cb128-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb128-689"><a href="#cb128-689" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_delay =</span> <span class="fu">mean</span>(dep_delay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb128-690"><a href="#cb128-690" aria-hidden="true" tabindex="-1"></a>    <span class="at">flights =</span> <span class="fu">n</span>()</span>
<span id="cb128-691"><a href="#cb128-691" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb128-692"><a href="#cb128-692" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-693"><a href="#cb128-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-694"><a href="#cb128-694" aria-hidden="true" tabindex="-1"></a><span class="fu">## `.by`</span></span>
<span id="cb128-695"><a href="#cb128-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-696"><a href="#cb128-696" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="al">![](images/截屏2024-02-02%2017.05.04.png)</span><span class="ot">{width="147"}</span><span class="co">](https://lifecycle.r-lib.org/articles/stages.html#experimental)</span></span>
<span id="cb128-697"><a href="#cb128-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-698"><a href="#cb128-698" aria-hidden="true" tabindex="-1"></a>dplyr从1.1.0版本开始包括了一个新的实验性语法，用于直接在统计函数中指定分组依据，即 <span class="in">`.by`</span> 参数。<span class="in">`group_by()`</span> 和 <span class="in">`ungroup()`</span> 不会消失，但现在也可以使用 <span class="in">`.by`</span> 参数来在单个操作中进行分组：</span>
<span id="cb128-699"><a href="#cb128-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-702"><a href="#cb128-702" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-703"><a href="#cb128-703" aria-hidden="true" tabindex="-1"></a>flights <span class="sc">|&gt;</span> </span>
<span id="cb128-704"><a href="#cb128-704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb128-705"><a href="#cb128-705" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_delay =</span> <span class="fu">mean</span>(dep_delay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb128-706"><a href="#cb128-706" aria-hidden="true" tabindex="-1"></a>    <span class="at">flights =</span> <span class="fu">n</span>(),</span>
<span id="cb128-707"><a href="#cb128-707" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> month <span class="co"># 按“month”分组统计</span></span>
<span id="cb128-708"><a href="#cb128-708" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb128-709"><a href="#cb128-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(month)</span>
<span id="cb128-710"><a href="#cb128-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-711"><a href="#cb128-711" aria-hidden="true" tabindex="-1"></a><span class="co"># 等价于:</span></span>
<span id="cb128-712"><a href="#cb128-712" aria-hidden="true" tabindex="-1"></a>flights <span class="sc">|&gt;</span> </span>
<span id="cb128-713"><a href="#cb128-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">|&gt;</span> </span>
<span id="cb128-714"><a href="#cb128-714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb128-715"><a href="#cb128-715" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_delay =</span> <span class="fu">mean</span>(dep_delay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb128-716"><a href="#cb128-716" aria-hidden="true" tabindex="-1"></a>    <span class="at">flights =</span> <span class="fu">n</span>()</span>
<span id="cb128-717"><a href="#cb128-717" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb128-718"><a href="#cb128-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-719"><a href="#cb128-719" aria-hidden="true" tabindex="-1"></a><span class="co"># 支持指定多个分组依据</span></span>
<span id="cb128-720"><a href="#cb128-720" aria-hidden="true" tabindex="-1"></a>flights <span class="sc">|&gt;</span> </span>
<span id="cb128-721"><a href="#cb128-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb128-722"><a href="#cb128-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_delay =</span> <span class="fu">mean</span>(dep_delay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb128-723"><a href="#cb128-723" aria-hidden="true" tabindex="-1"></a>    <span class="at">flights =</span> <span class="fu">n</span>(),</span>
<span id="cb128-724"><a href="#cb128-724" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(origin, dest)</span>
<span id="cb128-725"><a href="#cb128-725" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb128-726"><a href="#cb128-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(origin, dest)</span>
<span id="cb128-727"><a href="#cb128-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-728"><a href="#cb128-728" aria-hidden="true" tabindex="-1"></a><span class="co"># 等价于：</span></span>
<span id="cb128-729"><a href="#cb128-729" aria-hidden="true" tabindex="-1"></a>flights <span class="sc">|&gt;</span> </span>
<span id="cb128-730"><a href="#cb128-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(origin, dest) <span class="sc">|&gt;</span> </span>
<span id="cb128-731"><a href="#cb128-731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb128-732"><a href="#cb128-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_delay =</span> <span class="fu">mean</span>(dep_delay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb128-733"><a href="#cb128-733" aria-hidden="true" tabindex="-1"></a>    <span class="at">flights =</span> <span class="fu">n</span>()</span>
<span id="cb128-734"><a href="#cb128-734" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb128-735"><a href="#cb128-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb128-736"><a href="#cb128-736" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-737"><a href="#cb128-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-738"><a href="#cb128-738" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb128-739"><a href="#cb128-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-740"><a href="#cb128-740" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true" icon="false"}</span>
<span id="cb128-741"><a href="#cb128-741" aria-hidden="true" tabindex="-1"></a><span class="fu">## Session Info</span></span>
<span id="cb128-742"><a href="#cb128-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-745"><a href="#cb128-745" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb128-746"><a href="#cb128-746" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb128-747"><a href="#cb128-747" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb128-748"><a href="#cb128-748" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb128-749"><a href="#cb128-749" aria-hidden="true" tabindex="-1"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
 This website was built with Quarto
  </li>  
</ul>
</div>   
    <div class="nav-footer-center">Copyright 2024, Du Junhong</div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/djhcod">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer>


</body></html>