---
title: "Rstudioç¯å¢ƒé…ç½®"
execute: 
  eval: false
editor_options: 
  chunk_output_type: console
---

# æ›´æ–°R

åœ¨RåŸè½¯ä»¶ä¸­é€ä¸ªè¿è¡Œä¸‹é¢çš„ä»£ç ï¼ˆä»…é€‚ç”¨Windowsç³»ç»Ÿï¼‰ã€‚macOSç›´æ¥æ‰“å¼€[CRANå®˜ç½‘](https://cran.r-project.org/bin/macosx/)ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„Rè¦†ç›–å®‰è£…ï¼Œé‡å¯RStudioå³å¯å®ŒæˆRçš„æ›´æ–°ï¼ŒåŸRåŒ…éƒ½åœ¨ã€‚

```{r}
install.packages("installr")
library(installr)
updateR()
```

# æ›´æ–°RåŒ…

è¿è¡Œä¸‹é¢çš„ä»£ç æˆ–é€šè¿‡å³ä¸‹è§’çš„Packagesé€‰é¡¹å¡è¿›è¡ŒRåŒ…çš„æ›´æ–°

```{r}
old.packages() # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ›´æ–°çš„RåŒ…
update.packages(ask = F) # æ›´æ–°æ‰€æœ‰RåŒ…
news(package = "limma") # å‚çœ‹RåŒ…çš„æ›´æ–°å†…å®¹
BiocManager::valid() # æŸ¥çœ‹æ˜¯å¦æœ‰éœ€è¦æ›´æ–°çš„bioconductoråŒ…ã€‚æ ¹æ®æç¤ºå®‰è£…æ›´æ–°
```

# ä»bioconductorå®‰è£…RåŒ…

```{r}
BiocManager::install("biomaRt",update = TRUE,ask = FALSE)
```

# æ¸…é™¤å½“å‰åŠ è½½çš„ç¨‹åºåŒ…

```{r}
detach("package:dplyr", unload=TRUE)
# æˆ–ç”¨pacmanåŒ…å†…çš„p_unloadå‡½æ•°
pacman::p_unload("dplyr")
```

å¦‚æœè¦ä»ç¯å¢ƒä¸­ç§»é™¤æ‰€æœ‰ç”¨æˆ·åŒ…ï¼Œåˆ™å¯é€šè¿‡`pacman`åŒ…çš„`p_loaded()`+`p_unload()`å‡½æ•°å®ç°ï¼š

```{r}
pacman::p_unload(pacman::p_loaded(), character.only = TRUE)
```

# æ›´æ”¹å½“å‰Rè„šæœ¬è¿è¡Œç›®å½•

```{r}
setwd("/Users/totoshihiro/Library/Mobile Documents/com~apple~CloudDocs/Documents/ç§‘ç ”/åŒ»å­¦ç»Ÿè®¡å­¦/æ•°æ®åŸºæœ¬å¤„ç†ä¸æ ‡å‡†åŒ–")
getwd()#æŸ¥çœ‹å½“å‰Rè„šæœ¬è¿è¡Œç›®å½•
```

# ç¯å¢ƒæŸ¥çœ‹å’Œæ¸…ç†

```{r}
rm(mydata)
rm(list = ls())#ç§»é™¤å½“å‰ç¯å¢ƒä¸­çš„æ‰€æœ‰å¯¹è±¡
cat("\014")#æ¸…ç©ºæ‰€æœ‰è¾“å‡ºç»“æœ
sessionInfo()#æ”¶é›†æœ‰å…³å½“å‰Ré¡¹ç›®çš„ä¿¡æ¯
```

# è‡ªåŠ¨å®‰è£…æ‰€éœ€çš„RåŒ…

```{r}
packages <-c("GEOquery", "limma","ggplot2", "pheatmap")#åˆ—å‡ºæ‰€éœ€çš„RåŒ…

#æ£€æŸ¥æ‰€éœ€çš„RåŒ…æ˜¯å¦å·²å®‰è£…ï¼Œè‹¥æœªå®‰è£…åˆ™ä»CRANæˆ–Bioconductorå®‰è£…åŒ…
packagecheck <- function(x) {
  if (!require("BiocManager")) {
    install.packages("BiocManager")
  } else if (!require(x, character.only = T)) {
    CRANpackages <- available.packages()
    if (x %in% rownames(CRANpackages)) {
      install.packages(x)
    } else {
      BiocManager::install(x, update = TRUE, ask = FALSE)
    }
  }
}
lapply(packages, packagecheck)
```

# è°ƒæ•´çŸ¢é‡/å†…å­˜åˆ†é…ä¸Šé™

## æé«˜çŸ¢é‡å¤§å°ä¸Šé™

åœ¨Rè¯­è¨€ä¸­å¦‚æœæˆ‘ä»¬è¦å¤„ç†çš„æ•°æ®é›†è¾ƒå¤§ï¼Œå¦‚åœ¨[å¤„ç†å•ç»†èƒæ•°æ®æ—¶](/single_cell/scRNA-seq_online/06_SC_SCT_normalization.qmd#re_sctransform)ï¼Œå¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™ï¼š

``` md
Error: cannot allocate vector of size *** Mb
```

è¿™æ˜¯å› ä¸º R ä¸­æœ‰å¯¹è±¡å¤§å°çš„é™åˆ¶ï¼ˆé»˜è®¤å€¼ä¸º 500 1024 \^ 2 = 500 Mbï¼‰ã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œè°ƒæ•´ï¼š

```{r}
#| eval: false
# è°ƒæ•´å…è®¸å¯¹è±¡å¤§å°é™åˆ¶ä¸º6GB
options(future.globals.maxSize = 6 * 1024 * 1024^2)
```

## æé«˜Rå†…å­˜åˆ†é…ä¸Šé™ï¼ˆmacOSï¼‰ {#sec-Raising_memory_limit}

å¦‚æœåœ¨è¿è¡Œå¤§é‡çš„æ•°æ®å¤„ç†æ—¶ï¼Œå‡ºç°å¦‚ä¸‹æŠ¥é”™ï¼š

``` md
Error: vector memory exhausted (limit reached?)
```

é‚£ä¹ˆè¯´æ˜è„šæœ¬çš„è¿è¡Œè¶…å‡ºäº†Rè¯­è¨€å†…å­˜åˆ†é…çš„ä¸Šé™ï¼Œè¿™ä¸€èˆ¬å°±æ˜¯Macçš„ç‰©ç†å†…å­˜å¤§å°ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼æ¥é€šè¿‡åˆ†é…SWAPè™šæ‹Ÿå†…å­˜çš„æ–¹å¼ï¼Œä½¿å¾—ä»£ç èƒ½å¤Ÿç»§ç»­è¿è¡Œï¼ˆæ¥è‡ªstackoverflowä¸Šçš„[è¿™ç¯‡](https://stackoverflow.com/questions/51295402/r-on-macos-error-vector-memory-exhausted-limit-reached)å¸–å­ï¼‰ã€‚

ã€æ–¹æ³•ä¸€ï¼šé€šè¿‡[usethis](https://usethis.r-lib.org/)åŒ…é…ç½®ã€‘

åœ¨Rä¸­è¿è¡Œï¼š

```{r}
usethis::edit_r_environ()
```

::: callout-tip
`usethis` is a package that facilitates interactive workflows for R project creation and development
:::

è¿è¡Œåä¼šåœ¨RStudioä¸­ä»¥æ–°æ ‡ç­¾é¡µçš„æ–¹å¼æ‰“å¼€ä¸€ä¸ª.Renvironæ–‡ä»¶ã€‚åœ¨å…¶ä¸­è¾“å…¥ï¼š

``` md
R_MAX_VSIZE=50Gb
```

::: callout-caution
æ³¨æ„è¿™é‡Œçš„å†…å­˜æ•°å€¼åŒ…æ‹¬äº†ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜ï¼Œæ‰€ä»¥å¦‚æœä½ çš„ç”µè„‘çš„å®é™…å†…å­˜ä¸º16GBï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œéœ€è¦è¾“å…¥æ¯”16GBæ›´å¤§çš„æ•°å€¼ï¼Œè¾“å…¥16GBæ˜¯ä¸ä¼šæœ‰å¸®åŠ©çš„ã€‚
:::

ä¿å­˜è¿™ä¸ªæ–‡ä»¶åï¼Œé‡å¯RStudioï¼Œè¿™æ—¶å€™å†…å­˜ä¸Šé™å°±è¢«ä¿®æ”¹å¥½äº†ã€‚

![RStudioè°ƒç”¨è™šæ‹Ÿå†…å­˜æ‰§è¡Œè„šæœ¬](images/æˆªå±2024-01-14%2010.33.37.png){width="290"}

ã€æ–¹æ³•äºŒï¼šé€šè¿‡ç»ˆç«¯é…ç½®ã€‘

æ‰“å¼€ç»ˆç«¯ï¼ˆTerminalï¼‰ï¼Œåœ¨å…¶ä¸­è¾“å…¥ï¼š

``` md
cd ~
touch .Renviron
open .Renviron
```

è¿™æ—¶ä¼šæ‰“å¼€.Renvironæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­è¾“å…¥ï¼š

``` md
R_MAX_VSIZE=50Gb
```

ä¿å­˜æ–‡ä»¶ï¼Œé‡å¯RStudioã€‚

# RStudioå¸¸ç”¨å¿«æ·é”®

+------------------------------------------------+-------------------------------------------------------------------+
| æ“ä½œ                                           | MacOSå¿«æ·é”®                                                       |
+================================================+===================================================================+
| æ–°å»ºRè„šæœ¬                                      | `Command` + `Shift` + `N`                                         |
+------------------------------------------------+-------------------------------------------------------------------+
| å¤šè¡Œæ³¨é‡Š                                       | å…ˆé€‰ä¸­æ‰€è¦æ³¨é‡Šçš„ä»£ç ï¼Œç„¶åæŒ‰`Command` + `Shift` + `C`ã€‚\          |
|                                                | å¦‚æœæƒ³å–æ¶ˆæ³¨é”€ï¼Œå†é€‰ä¸­ä»£ç ï¼Œå†åæŒ‰`Command` + `Shift` + `C`ã€‚     |
+------------------------------------------------+-------------------------------------------------------------------+
| æ’å…¥[ç®¡é“å‡½æ•°%\>%](/r_basic/pipe_operator.qmd) | `Command` + `Shift` + `M`                                         |
+------------------------------------------------+-------------------------------------------------------------------+
| èµ‹å€¼                                           | `Option` + `-`                                                    |
+------------------------------------------------+-------------------------------------------------------------------+
| æ‰“å¼€å¸®åŠ©                                       | å°†å…‰æ ‡æ”¾åˆ°å‡½æ•°ä¸­é—´ï¼Œç„¶åæŒ‰`F1`é”®                                  |
+------------------------------------------------+-------------------------------------------------------------------+
| å¤åˆ¶å¹¶ç²˜è´´ä»£ç                                  | åœ¨ä¸€è¡Œä»£ç æœ«å°¾æˆ–è€…é€‰ä¸­éœ€è¦å¤åˆ¶çš„ä»£ç åæŒ‰`Command` + `Shift` + `D` |
+------------------------------------------------+-------------------------------------------------------------------+
| åˆ›å»ºå¯æŠ˜å æ³¨é‡Š                                 | `Command` + `Shift` + `R`                                         |
+------------------------------------------------+-------------------------------------------------------------------+

: RStudioå¸¸ç”¨å¿«æ·é”®

ğŸ’¡åœ¨Windowsä¸­ç›¸åº”çš„å¿«æ·é”®æŠŠä¸Šé¢çš„`Command`æ›¿æ¢æˆ`Control`ï¼Œ`Option`æ›¿æ¢æˆ`Alt`å³å¯ã€‚

# è‡ªåŠ¨æ•´ç†ä»£ç 

[The tidyverse style guide](https://style.tidyverse.org/index.html)**å¯¹ä»£ç ç¼–å†™æ—¶çš„è§„èŒƒæ ¼å¼è¿›è¡Œäº†è¯¦ç»†è¯´æ˜ã€‚é€šè¿‡**[styleråŒ…](https://styler.r-lib.org)å¯ä»¥å®ç°å¯¹ä»£ç çš„è‡ªåŠ¨æ•´ç†ï¼Œæœ‰åŠ©äºä¿æŒä¸åŒé¡¹ç›®ä¹‹é—´çš„ä»£ç é£æ ¼ä¸€è‡´ï¼Œå¹¶ä¿ƒè¿›åä½œã€‚å®‰è£…styleråé€šè¿‡è¿è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯è‡ªåŠ¨æ•´ç†å½“å‰æ‰“å¼€çš„æ–‡æ¡£çš„ä»£ç ã€‚

```{r}
install.packages("styler")
styler:::style_active_file()
```

ä¹Ÿå¯ä»¥ç”¨é€šè¿‡æ‰“å¼€Rstudioçš„æ’ä»¶ï¼ˆAddinsï¼‰ï¼Œé€‰æ‹©"Style active file"æ¥å®ç°å¯¹å½“å‰Rè„šæœ¬çš„ä»£ç æ•´ç†ã€‚æˆ–è€…é€‰æ‹©ä¸€æ®µä»£ç åï¼Œç‚¹å‡»"Style selection"æ¥å¯¹é€‰ä¸­çš„ä»£ç è¿›è¡Œæ•´ç†ã€‚

![Rstudioæ’ä»¶](images/screenshot_2023-11-14%2011.44.02.png){#fig-æ’ä»¶ width="219"}

# Rstudioä¸»é¢˜

[`rsthemes`](https://www.garrickadenbuie.com/project/rsthemes/#installation)åŒ…æä¾›äº†å¤šç§é¢å¤–çš„ä¸»é¢˜ã€‚

![](images/rsthemes.gif)

è¯¥åŒ…é€šè¿‡[r-universe](https://gadenbuie.r-universe.dev/)è¿›è¡Œå®‰è£…ï¼š

```{r}
install.packages(
  "rsthemes",
  repos = c(gadenbuie = 'https://gadenbuie.r-universe.dev', getOption("repos"))
)
```

ç„¶åå®‰è£…ä¸»é¢˜ï¼š

```{r}
rsthemes::install_rsthemes()
```

ä½¿ç”¨ï¼š

```{r}
# åˆ—å‡ºæ‰€æœ‰æ¥è‡ªrsthemesçš„ä¸»é¢˜
rsthemes::list_rsthemes()

# ä¾æ¬¡å°è¯•æ‰€æœ‰ä¸»é¢˜
rsthemes::try_rsthemes()

# åªå°è¯•æµ…è‰²ä¸»é¢˜
rsthemes::try_rsthemes("light")
```

é€šè¿‡Tools \> Global Options \> Appearanceä¹Ÿå¯ä»¥æµè§ˆå’Œåº”ç”¨è¿™äº›ä¸»é¢˜ã€‚

å®‰è£…è¯¥åŒ…åè¿˜ä¼šåœ¨Rstudioçš„æ’ä»¶ä¸­æ˜¾ç¤ºï¼Œå¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œæ·±è‰²å’Œæµ…è‰²æ¨¡å¼çš„åˆ‡æ¢ã€‚è¦å®ç°è¿™ä¸€ç‚¹ï¼Œéœ€è¦æ‰“å¼€Rçš„é…ç½®æ–‡ä»¶ï¼ˆ\~/.Rprofileï¼‰ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å¿«é€Ÿæ‰“å¼€ï¼š

```{r}
usethis::edit_r_profile()
```

ç„¶åå°†ä¸‹é¢çš„ä»£ç ç²˜è´´è¿›é…ç½®æ–‡ä»¶ï¼š

```{r}
if (interactive()) {
  rsthemes::set_theme_light("Chrome") # é»˜è®¤çš„æµ…è‰²ä¸»é¢˜
  rsthemes::set_theme_dark("Cobalt") # é»˜è®¤çš„æ·±è‰²ä¸»é¢˜
  rsthemes::set_theme_favorite( # å†æ·»åŠ ä¸€äº›ä¸»é¢˜ä½œä¸ºå¤‡é€‰
    c(
      "GitHub {rsthemes}",
      "Material Palenight {rsthemes}"
    )
  )
}
```

ç°åœ¨å°±å¯ä»¥é€šè¿‡ç‚¹å‡»æ’ä»¶ä¸­çš„"Toggle Dark Mode"æ¥ä¸€é”®åˆ‡æ¢æ·±è‰²å’Œæµ…è‰²ä¸»é¢˜äº†ï¼ˆ@fig-æ’ä»¶ ï¼‰ã€‚åŒæ—¶ï¼Œç‚¹å‡»"Next Favorite Theme"å¯ä»¥åˆ‡æ¢ä¸Šé¢è®¾ç½®çš„`set_theme_favorite()`é‡Œé¢çš„ä¸»é¢˜ã€‚
